function BurstBrowser(~,~)
%   2017 - FAB Lab Munich - Don C. Lamb

hfig=findobj('Tag','BurstBrowser');

addpath(genpath(['.' filesep 'functions']));

global UserValues BurstMeta PathToApp
LSUserValues(0);
Look=UserValues.Look;
if isempty(PathToApp)
    GetAppFolder();
end
if isempty(hfig)
    warning('off','MATLAB:uigridcontainer:MigratingFunction');
    warning('off','MATLAB:uiflowcontainer:MigratingFunction');
    
    %%% start splash screen
    s = SplashScreen( 'Splashscreen', [PathToApp filesep 'images' filesep 'BurstBrowser' filesep 'splash.jpg'], ...
                         'ProgressBar', 'on', ...
                         'ProgressPosition', 5, ...
                         'ProgressRatio', 0 );
     s.addText( 30, 50, 'BurstBrowser', 'FontSize', 30, 'Color', [1 1 1] );
     s.addText( 30, 80, 'v1.2', 'FontSize', 20, 'Color', [1 1 1] );
     s.addText( 385, 330, 'Loading...', 'FontSize', 20, 'Color', 'white' );
    %% Define main window
    h.BurstBrowser = figure(...
        'Units','normalized',...
        'Name','BurstBrowser',...
        'NumberTitle','off',...
        'MenuBar','none',...
        'defaultUicontrolFontName',Look.Font,...
        'defaultAxesFontName',Look.Font,...
        'defaultTextFontName',Look.Font,...
        'OuterPosition',[0.01 0.05 0.98 0.95],...
        'UserData',[],...
        'Visible','off',...
        'Tag','BurstBrowser',...
        'ToolBar','figure',...
        'CloseRequestFcn',@Close_BurstBrowser,...
        'KeyPressFcn',@BurstBrowser_KeyPress,...
        'WindowButtonDownFcn',@PhasorLiveUpdate);
    whitebg(h.BurstBrowser,Look.Axes);
    set(h.BurstBrowser,'Color',Look.Back);
    %%% Remove unneeded items from toolbar
    toolbar = findall(h.BurstBrowser,'Type','uitoolbar');
    toolbar_items = findall(toolbar);
    if verLessThan('matlab','9.5') %%% toolbar behavior changed in MATLAB 2018b
        delete(toolbar_items([2:7 9 13:17]));
    else %%% 2018b and upward
        %%% just remove the tool bar since the options are now in the axis
        %%% (e.g. axis zoom etc)
        delete(toolbar_items);
    end
    %%% get BurstBrowser size in pixels
    h.BurstBrowser.Units = 'pixels';
    h.figure_size = h.BurstBrowser.Position;
    %%% define menu items
    h.File_Menu = uimenu(...
        'Parent',h.BurstBrowser,...
        'Label','File',...
        'Tag','File_Menu',...
        'Enable','off');
    %%% Load Burst Data Callback
    h.Load_Bursts = uimenu(...
        'Parent',h.File_Menu,...
        'Label','<html>Load <b>New</b> Burst Data <b>(Crtl+N)</b><html>',...
        'Callback',@Load_Burst_Data_Callback,...
        'Tag','Load_Burst_Data');
    h.Load_Bursts_From_Folder = uimenu(...
        'Parent',h.File_Menu,...
        'Label','<html>Load <b>New</b> Burst Files from <b>Subfolders</b></html>',...
        'Callback',@Load_Burst_Data_Callback,...
        'Tag','Load_Bursts_From_Folder');
    h.Append_File = uimenu(...
        'Parent',h.File_Menu,...
        'Label','<html><b>Add</b> Burst Data<html>',...
        'Callback',@Load_Burst_Data_Callback,...
        'Tag','Load_Burst_Data',...
        'Separator','on',...
        'Enable','off');
    %h.Database.Add = uimenu(...
    %    'Parent', h.File_Menu,...
    %    'Tag','Database_Add',...
    %    'Label','Add Burst File to Database',...
    %    'enable', 'off',...
    %    'Callback',{@Database,1});
    
    %%% Save Analysis State
    h.Save_Bursts = uimenu(...
        'Parent',h.File_Menu,...
        'Label','<html><b>Save</b> Analysis State <b>(Ctrl+S)</b></html>',...
        'Callback',@Save_Analysis_State_Callback,...
        'Tag','Save_Analysis_State',...
        'Separator','on');
    %%% Merge *.bur files
    h.Merge_Files_Menu = uimenu(...
        'Parent',h.File_Menu,...
        'Label','<html><b>Merge</b> <i>*.bur</i>-files</html>',...
        'Callback',@Merge_bur_files,...
        'Tag','Merge_Files_Menu',...
        'Separator','on');
    %%% Merge *.bur files
    h.Export_Files_To_CSV_Menu = uimenu(...
        'Parent',h.File_Menu,...
        'Label','<html><b>Export</b> to <i>*.csv</i>-file</html>',...
        'Callback',@write_to_csv,...
        'Tag','Export_Files_To_CSV_Menu',...
        'Separator','off');
    %%% "Export" Menu    
    h.Export_Menu = uimenu(...
        'Parent',h.BurstBrowser,...
        'Label','Export',...
        'Tag','More_Export_Menu',...
        'Enable','on');
    %%% Export FRET histograms for all loaded measurements
    h.FRET_Export_Top_Menu = uimenu(...
        'Parent',h.Export_Menu,...
        'Label','<html>Export <b>FRET efficiency histograms</b>...</html>',...
        'Callback',[],...
        'Tag','FRET_Export_Top_Menu',...
        'Separator','off');
    h.FRET_Export_Sel_Menu = uimenu(...
        'Parent',h.FRET_Export_Top_Menu,...
        'Label','<html>for all selected species</html>',...
        'Callback',@Export_FRET_Hist,...
        'Tag','FRET_Export_Sel__Menu',...
        'Separator','off');
    h.FRET_Export_All_Menu = uimenu(...
        'Parent',h.FRET_Export_Top_Menu,...
        'Label','<html>for all loaded files</html>',...
        'Callback',@Export_FRET_Hist,...
        'Tag','FRET_Export_All_Menu',...
        'Separator','off');
    h.Export_PDA_Top_Menu = uimenu(...
        'Parent',h.Export_Menu,...
        'Label','<html>Export to <b>PDA</b>...</html>',...
        'Tag','Export_PDA_Top_Menu',...
        'Callback',[],...
        'Enable','on',...
        'Separator','off');
    h.Export_PDA_Sel_Menu = uimenu(...
        'Parent',h.Export_PDA_Top_Menu,...
        'Label','<html>for all selected species</html>',...
        'Tag','Export_PDA_Sel_Menu',...
        'Callback',@Export_To_PDA,...
        'Enable','on');
    h.Export_PDA_All_Menu = uimenu(...
        'Parent',h.Export_PDA_Top_Menu,...
        'Label','<html>for all loaded files</html>',...
        'Tag','Export_PDA_All_Menu',...
        'Callback',@Export_To_PDA,...
        'Enable','on');
    h.ExportAllGraphs_Menu = uimenu(...
        'Parent',h.Export_Menu,...
        'Label','<html>Export all graphs (E, E-S, lifetime...)</html>',...
        'Tag','ExportAllGraphs_Menu',...
        'Callback',@ExportAllGraphs,...
        'Enable','on',...
        'Separator','on');
    h.ExportAllInOneGraphs_Top_Menu = uimenu(...
        'Parent',h.Export_Menu,...
        'Label','<html>Export all-in-one graphs...</html>',...
        'Tag','ExportAllInOneGraphs_Top_Menu',...
        'Callback',[],...
        'Enable','on',...
        'Separator','off');
    h.ExportAllInOneGraphs_Top_Menu1 = uimenu(...
        'Parent',h.ExportAllInOneGraphs_Top_Menu,...
        'Label','<html>S-E plot attached</html>',...
        'Tag','ExportAllInOneGraphs_Menu1',...
        'Callback',{@ExportAllInOneGraphs,1},...
        'Enable','on',...
        'Separator','off');
    h.ExportAllInOneGraphs_Top_Menu2 = uimenu(...
        'Parent',h.ExportAllInOneGraphs_Top_Menu,...
        'Label','<html>S-E plot centered</html>',...
        'Tag','ExportAllInOneGraphs_Menu2',...
        'Callback',{@ExportAllInOneGraphs,2},...
        'Enable','on',...
        'Separator','off');
     %%% Choose print path
    h.Autoset_PrintPath_Menu = uimenu(...
        'Parent',h.Export_Menu,...
        'Label','<html>Export to <b>Current</b> File Path<html>',...
        'Callback',@Choose_PrintPath_Menu,...
        'Tag','Autoset_PrintPath_Menu',...
        'Separator','on');
    h.Choose_PrintPath_Menu = uimenu(...
        'Parent',h.Export_Menu,...
        'Label','<html><b>Change</b> Export Path<html>',...
        'Callback',@Choose_PrintPath_Menu,...
        'Tag','Choose_PrintPath_Menu',...
        'Separator','off');
    h.Current_PrintPath_Menu = uimenu(...
        'Parent',h.Export_Menu,...
        'Label','<html><i>Current Export Path:</i></html>',...
        'Callback',[],...
        'Tag','Current_PrintPath_Menu',...
        'Separator','off');
    h.Current_PrintPath_Text = uimenu(...
        'Parent',h.Current_PrintPath_Menu,...
        'Label',UserValues.BurstBrowser.PrintPath,...
        'Callback',[],...
        'Tag','Current_PrintPath_Text',...
        'Separator','off');
    if UserValues.BurstBrowser.Settings.UseFilePathForExport
        h.Autoset_PrintPath_Menu.Checked = 'on';
        h.Choose_PrintPath_Menu.Enable = 'off';
        h.Current_PrintPath_Menu.Enable = 'off';
    else
        h.Autoset_PrintPath_Menu.Checked = 'off';
        h.Choose_PrintPath_Menu.Enable = 'on';
        h.Current_PrintPath_Menu.Enable = 'on';
    end
    h.ExportToTracy = uimenu(...
        'Parent',h.Export_Menu,...
        'Label','Export burst-wise traces',...
        'Callback',@Export_to_Tracy,...
        'Tag','ExportToTracy',...
        'Separator','on');
    %%% "Parameter Comparison" Menu
    h.Parameter_Comparison_Menu = uimenu(....
        'Parent',h.BurstBrowser,...
        'Label','Compare',...
        'Tag','Parameter_Comparison_Menu');
    h.FRET_comp_selected_Menu = uimenu(...
        'Parent',h.Parameter_Comparison_Menu,...
        'Label','<html>Compare <b>FRET efficiency histograms</b> of selected species</html>',...
        'Callback',[],...
        'Tag','FRET_comp_selected_Menu',...
        'Enable','off',...
        'Separator','off');
    h.FRET_comp_selected_together_Menu = uimenu(...
        'Parent',h.FRET_comp_selected_Menu,...
        'Label','... in one plot',...
        'Callback',@Compare_FRET_Hist,...
        'Tag','FRET_comp_selected_together_Menu',...
        'Enable','off',...
        'Separator','off');
    h.FRET_comp_selected_separate_Menu = uimenu(...
        'Parent',h.FRET_comp_selected_Menu,...
        'Label','... stacked',...
        'Callback',@Compare_FRET_Hist,...
        'Tag','FRET_comp_selected_separate_Menu',...
        'Enable','off',...
        'Separator','off');
    h.Param_comp_selected_Menu = uimenu(...
        'Parent',h.Parameter_Comparison_Menu,...
        'Label','<html>Compare <b>current parameter</b> of selected species</html>',...
        'Callback',[],...
        'Tag','Param_comp_selected_Menu',...
        'Enable','off',...
        'Separator','off');
    h.Param_comp_selected_together_Menu = uimenu(...
        'Parent',h.Param_comp_selected_Menu,...
        'Label','... in one plot',...
        'Callback',@Compare_FRET_Hist,...
        'Tag','Param_comp_selected_together_Menu',...
        'Enable','off',...
        'Separator','off');
    h.Param_comp_selected_separate_Menu = uimenu(...
        'Parent',h.Param_comp_selected_Menu,...
        'Label','... stacked',...
        'Callback',@Compare_FRET_Hist,...
        'Tag','Param_comp_selected_separate_Menu',...
        'Enable','off',...
        'Separator','off');
    %%% FRET Comparions plot of loaded files
    h.FRET_comp_Loaded_Menu = uimenu(...
        'Parent',h.Parameter_Comparison_Menu,...
        'Label','<html>Compare <b>FRET efficiency histograms</b> of loaded files</html>',...
        'Callback',[],...
        'Tag','FRET_comp_Loaded_Menu',...
        'Separator','on');
    h.FRET_comp_Loaded_together_Menu = uimenu(...
        'Parent',h.FRET_comp_Loaded_Menu,...
        'Label','... in one plot',...
        'Callback',@Compare_FRET_Hist,...
        'Tag','FRET_comp_Loaded_together_Menu',...
        'Separator','off');
    h.FRET_comp_Loaded_separate_Menu = uimenu(...
        'Parent',h.FRET_comp_Loaded_Menu,...
        'Label','... stacked',...
        'Callback',@Compare_FRET_Hist,...
        'Tag','FRET_comp_Loaded_together_Menu',...
        'Separator','off');
    %%% Parameter Comparions plot from loaded files
    h.Param_comp_Loaded_Menu = uimenu(...
        'Parent',h.Parameter_Comparison_Menu,...
        'Label','<html>Compare <b>current parameter</b> of loaded files</html>',...
        'Callback',[],...
        'Tag','Param_comp_Loaded_Menu',...
        'Separator','off');
    h.Param_comp_Loaded_together_Menu = uimenu(...
        'Parent',h.Param_comp_Loaded_Menu,...
        'Label','... in one plot',...
        'Callback',@Compare_FRET_Hist,...
        'Tag','Param_comp_Loaded_Menu',...
        'Separator','off');
    h.Param_comp_Loaded_separate_Menu = uimenu(...
        'Parent',h.Param_comp_Loaded_Menu,...
        'Label','... stacked',...
        'Callback',@Compare_FRET_Hist,...
        'Tag','Param_comp_Loaded_Menu',...
        'Separator','off');
    %%% FRET Comparions plot from *.his files
    h.FRET_comp_File_Menu = uimenu(...
        'Parent',h.Parameter_Comparison_Menu,...
        'Label','<html>Compare <b>FRET efficiency histograms</b> from <i>*.his</i>-files</html>',...
        'Callback',@Compare_FRET_Hist,...
        'Tag','FRET_comp_File_Menu',...
        'Separator','on');
    
    %%% PCA Comparion between files
    h.PCA_comp_File_Menu = uimenu(...
        'Parent',h.Parameter_Comparison_Menu,...
        'Label','<html>PCA<b> anaylsis</html>',...
        'Callback',@PCA_analysis,...
        'Tag','PCA_comp',...
        'Separator','on');
    %%% Notepad Menu Item
    h.Extras_Menu = uimenu(....
        'Parent',h.BurstBrowser,...
        'Label','Extras',...
        'Tag','Extras_Menu');
    h.Notepad_Menu = uimenu(    ...
        'Parent',h.Extras_Menu,...
        'Label','Notepad',...
        'Callback',@Open_Notepad,...
        'Tag','Notepad_Menu',...
        'Separator','off');
    %define tabs
    %main tab
    h.Main_Tab = uitabgroup(...
        'Parent',h.BurstBrowser,...
        'Tag','Main_Tab',...
        'Units','normalized',...
        'Position',[0 0 0.65 1],...
        'SelectionChangedFcn',@TabSelectionChange);
    
    h.Main_Tab_General = uitab(h.Main_Tab,...
        'title','General',...
        'Tag','Main_Tab_General'...
        );
    
    h.MainTabGeneralPanel = uibuttongroup(...
        'Parent',h.Main_Tab_General,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'HighlightColor', Look.Control,...
        'ShadowColor', Look.Shadow,...
        'Units','normalized',...
        'Position',[0 0 1 1],...
        'Tag','MainTabGeneralPanel');
    
    
    %%% Progress Bar
    %%% Panel for progressbar
    h.Progress_Panel = uibuttongroup(...
        'Parent',h.BurstBrowser,...
        'Tag','Progress_Panel',...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'HighlightColor', Look.Control,...
        'ShadowColor', Look.Shadow,...
        'Position',[0.65 0 0.35 0.03]);
    %%% Axes for progressbar
    h.Progress_Axes = axes(...
        'Parent',h.Progress_Panel,...
        'Tag','Progress_Axes',...
        'Units','normalized',...
        'Color',Look.Control,...
        'Position',[0 0 1 1]);
    h.Progress_Axes.XTick=[]; h.Progress_Axes.YTick=[];
    %%% Progress and filename text
    h.Progress_Text=text(...
        'Parent',h.Progress_Axes,...
        'Tag','Progress_Text',...
        'Units','normalized',...
        'FontSize',12,...
        'FontWeight','bold',...
        'String','Nothing loaded',...
        'Interpreter','none',...
        'HorizontalAlignment','center',...
        'BackgroundColor','none',...
        'Color',Look.Fore,...
        'Position',[0.5 0.5]);
    
    %%% Define hide uitabgroup
    h.Hide_Tab =  uitabgroup(...
        'Parent',h.BurstBrowser,...
        'Tag','Hide_Tab',...
        'Units','normalized',...
        'Position',[0 0 1 1],...
        'Visible','off');
    h.Hide_Stuff = uitab(...
        'Parent',h.Hide_Tab,...
        'Tag','Hide_Stuff');
    
    h.Main_Tab_Lifetime= uitab(h.Main_Tab,...
        'title','Lifetime',...
        'Tag','Main_Tab_Lifetime'...
        );
    
    h.LifetimeTabgroup = uitabgroup(...
        'Parent',h.Main_Tab_Lifetime,...
        'Units','normalized',...
        'Position',[0 0 1 1],...
        'SelectionChangedFcn',@TabSelectionChange);
    h.LifetimeTabAll = uitab('Parent',h.LifetimeTabgroup,...
        'title','All');
    h.LifetimePanelAll = uibuttongroup(...
        'Parent',h.LifetimeTabAll,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'HighlightColor', Look.Control,...
        'ShadowColor', Look.Shadow,...
        'Units','normalized',...
        'Position',[0 0 1 1],...
        'Tag','LifetimePanelAll');%,...
        %'UIContextMenu',h.LifeTime_Menu);
    h.LifetimeTabInd = uitab('Parent',h.LifetimeTabgroup,'title','Individual');
    h.LifetimePanelInd = uibuttongroup(...
        'Parent',h.LifetimeTabInd,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'HighlightColor', Look.Control,...
        'ShadowColor', Look.Shadow,...
        'Units','normalized',...
        'Position',[0 0 1 1],...
        'Tag','LifetimePanelInd');%,...
        %'UIContextMenu',h.LifeTime_Menu);
     
    %%% fFCS main tab
    h.Main_Tab_fFCS= uitab(h.Main_Tab,...
        'title','filtered FCS',...
        'Tag','Main_Tab_fFCS'...
        );
    
    h.MainTabfFCSPanel = uibuttongroup(...
        'Parent',h.Main_Tab_fFCS,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'HighlightColor', Look.Control,...
        'ShadowColor', Look.Shadow,...
        'Units','normalized',...
        'Position',[0 0 1 1],...
        'Tag','MainTabfFCSPanel');
    
    h.Main_Tab_Corrections= uitab(h.Main_Tab,...
        'title','Corrections',...
        'Tag','Main_Tab_Corrections'...
        );
    
    h.MainTabCorrectionsPanel = uibuttongroup(...
        'Parent',h.Main_Tab_Corrections,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'HighlightColor', Look.Control,...
        'ShadowColor', Look.Shadow,...
        'Units','normalized',...
        'Position',[0 0 1 1],...
        'Tag','MainTabCorrectionsPanel');
    h.Main_Tab_Corrections_ThreeCMFD= uitab(h.Hide_Tab,...
        'title','Corrections (3C)',...
        'Tag','Main_Tab_Corrections_ThreeCMFD'...
        );
    
    h.MainTabCorrectionsThreeCMFDPanel = uibuttongroup(...
        'Parent',h.Main_Tab_Corrections_ThreeCMFD,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'HighlightColor', Look.Control,...
        'ShadowColor', Look.Shadow,...
        'Units','normalized',...
        'Position',[0 0 1 1],...
        'Tag','MainTabCorrectionsThreeCMFDPanel'...
        );
    
    
    %%% fFCS sub tabs for display of filter and filter matching
    h.fFCS_SubTabPar = uitabgroup(...
        'Parent',h.MainTabfFCSPanel,...
        'Tag','fFCS_SubTabPar',...
        'Units','normalized',...
        'Position',[0 0 0.5 0.45]);
    
    h.fFCS_SubTabParFilter = uitab(h.fFCS_SubTabPar,...
        'title','Filter Par',...
        'Tag','fFCS_SubTabParFilter');
    h.fFCS_SubTabParFilterPanel = uibuttongroup(...
        'Parent',h.fFCS_SubTabParFilter,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'HighlightColor', Look.Control,...
        'ShadowColor', Look.Shadow,...
        'Units','normalized',...
        'Position',[0 0 1 1],...
        'Tag','fFCS_SubTabParFilterPanel');
    
    h.fFCS_SubTabParReconstruction = uitab(h.fFCS_SubTabPar,...
        'title','Reconstruction Par',...
        'Tag','fFCS_SubTabParReconstruction');
    h.fFCS_SubTabParReconstructionPanel = uibuttongroup(...
        'Parent',h.fFCS_SubTabParReconstruction,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'HighlightColor', Look.Control,...
        'ShadowColor', Look.Shadow,...
        'Units','normalized',...
        'Position',[0 0 1 1],...
        'Tag','fFCS_SubTabParReconstructionPanel');
    
    h.fFCS_SubTabPerp = uitabgroup(...
        'Parent',h.MainTabfFCSPanel,...
        'Tag','fFCS_SubTabPerp',...
        'Units','normalized',...
        'Position',[0.5 0 0.5 0.45]);
    
    h.fFCS_SubTabPerpFilter = uitab(h.fFCS_SubTabPerp,...
        'title','Filter Perp',...
        'Tag','fFCS_SubTabPerpFilter');
    h.fFCS_SubTabPerpFilterPanel = uibuttongroup(...
        'Parent',h.fFCS_SubTabPerpFilter,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'HighlightColor', Look.Control,...
        'ShadowColor', Look.Shadow,...
        'Units','normalized',...
        'Position',[0 0 1 1],...
        'Tag','fFCS_SubTabPerpFilterPanel');
    
    h.fFCS_SubTabPerpReconstruction = uitab(h.fFCS_SubTabPerp,...
        'title','Reconstruction Perp',...
        'Tag','fFCS_SubTabPerpReconstruction');
    h.fFCS_SubTabPerpReconstructionPanel = uibuttongroup(...
        'Parent',h.fFCS_SubTabPerpReconstruction,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'HighlightColor', Look.Control,...
        'ShadowColor', Look.Shadow,...
        'Units','normalized',...
        'Position',[0 0 1 1],...
        'Tag','fFCS_SubTabPerpReconstructionPanel');
    %% Secondary tab selection gui
    h.Secondary_Tab = uitabgroup(...
        'Parent',h.BurstBrowser,...
        'Tag','Secondary_Tab',...
        'Units','normalized',...
        'Position',[0.65 0.25 0.35 0.75]);
    
    h.Secondary_Tab_Selection = uitab(h.Secondary_Tab,...
        'title','Selection',...
        'Tag','Secondary_Tab_Selection'...
        );
    
    h.SecondaryTabSelectionPanel = uibuttongroup(...
        'Parent',h.Secondary_Tab_Selection,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'HighlightColor', Look.Control,...
        'ShadowColor', Look.Shadow,...
        'Units','normalized',...
        'Position',[0 0 1 1],...
        'Tag','SecondaryTabSelectionPanel');
    
    h.Secondary_Tab_Corrections= uitab(h.Secondary_Tab,...
        'title','Corrections/FCS',...
        'Tag','Secondary_Tab_Corrections'...
        );
    
    h.SecondaryTabCorrectionsPanel = uibuttongroup(...
        'Parent',h.Secondary_Tab_Corrections,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'HighlightColor', Look.Control,...
        'ShadowColor', Look.Shadow,...
        'Units','normalized',...
        'Position',[0 0 1 1],...
        'Tag','SecondaryTabCorrectionsPanel');
    
    h.Secondary_Tab_Fitting= uitab(...
        'Parent',h.Secondary_Tab,...
        'title','Fitting',...
        'Tag','Secondary_Tab_Fitting'...
        );
    h.Secondary_Tab_BVA= uitab(...
        'Parent',h.Secondary_Tab,...
        'title','BVA',...
        'Tag','Secondary_Tab_BVA'...
        );
    
    h.Secondary_Tab_Options= uitab(h.Secondary_Tab,...
        'title','Options',...
        'Tag','Secondary_Tab_DisplayOptions'...
        );
    
    h.SecondaryTabOptionsPanel = uibuttongroup(...
        'Parent',h.Secondary_Tab_Options,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'HighlightColor', Look.Control,...
        'ShadowColor', Look.Shadow,...
        'Units','normalized',...
        'Position',[0 0 1 1],...
        'Tag','SecondaryTabOptionsPanel');
    h.Secondary_Tab_Database= uitab(h.Secondary_Tab,...
        'title','Database',...
        'Tag','Secondary_Tab_Database');
    
    h.DatabaseBB.Panel = uibuttongroup(...
        'Parent',h.Secondary_Tab_Database,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'HighlightColor', Look.Control,...
        'ShadowColor', Look.Shadow,...
        'Units','normalized',...
        'Position',[0 0 1 1],...
        'Tag','SecondaryTabDatabasePanel');
    
    s.ProgressRatio = 0.25;
    
    %%% jave based right-click menu for uitree implementation
    %%% see http://undocumentedmatlab.com/blog/adding-context-menu-to-uitree
    % Prepare the context menu (can use HTML labels)
    h.AddSpeciesMenuItem = javax.swing.JMenuItem('Add Species');
    h.RemoveSpeciesMenuItem = javax.swing.JMenuItem('Remove Species');
    h.RenameSpeciesMenuItem = javax.swing.JMenuItem('Rename Species');
    h.RemoveFileMenuItem = javax.swing.JMenuItem('Remove File');
    h.ExportMenuItem = javax.swing.JMenu('Export...');
    h.ExportSpeciesToPDAMenuItem = javax.swing.JMenuItem('Export Species to PDA');
    h.ExportMicrotimePattern = javax.swing.JMenuItem('Export Microtime Pattern');
    h.DynamicMenuItem = javax.swing.JMenuItem('Dynamic Analyses (BVA, E vs. Tau, FRET-2CDE)');
    h.DoTimeWindowAnalysis = javax.swing.JMenuItem('Time Window Analysis');
    %h.DoBurstVarianceAnalysis = javax.swing.JMenuItem('Burst Variance Analysis');
    %h.EvsTauConfInt = javax.swing.JMenuItem('E vs. Tau (Conf. Int.)');
    %h.FRET2CDEConfInt = javax.swing.JMenuItem('FRET-2CDE Filter (Conf. Int.)');
    h.Export_FRET_Hist_Menu = javax.swing.JMenuItem('Export FRET Efficiency Histogram');
    h.Export_FRET_Hist_Timeseries_Menu = javax.swing.JMenuItem('Export FRET Efficiency Histogram (Time Series)');
    h.SendToTauFit = javax.swing.JMenuItem('Send Selected Species to TauFit');
    h.DisplayFileInfo = javax.swing.JMenuItem('Display File Info');
    % set callbacks
    set(h.AddSpeciesMenuItem,'ActionPerformedCallback',@AddSpecies);
    set(h.RemoveSpeciesMenuItem,'ActionPerformedCallback',@RemoveSpecies);
    set(h.RenameSpeciesMenuItem,'ActionPerformedCallback',@RenameSpecies);
    set(h.RemoveFileMenuItem,'ActionPerformedCallback',@RemoveFile);
    set(h.ExportSpeciesToPDAMenuItem,'ActionPerformedCallback',@Export_To_PDA)
    set(h.ExportMicrotimePattern,'ActionPerformedCallback',@Export_Microtime_Pattern); 
    set(h.DoTimeWindowAnalysis,'ActionPerformedCallback',@Time_Window_Analysis);
    set(h.DynamicMenuItem,'ActionPerformedCallback',@Dynamic_Analysis);
    %set(h.EvsTauConfInt,'ActionPerformedCallback',@Burst_Variance_Analysis);
    %set(h.FRET2CDEConfInt,'ActionPerformedCallback',@Burst_Variance_Analysis);
    set(h.Export_FRET_Hist_Menu,'ActionPerformedCallback',@Export_FRET_Hist); 
    set(h.Export_FRET_Hist_Timeseries_Menu,'ActionPerformedCallback',@Export_FRET_Hist); 
    set(h.SendToTauFit,'ActionPerformedCallback',@Send_To_TauFit);
    set(h.DisplayFileInfo,'ActionPerformedCallback',@DisplayFileInfo);
    % construct contextmenu
    h.SpeciesListMenu = javax.swing.JPopupMenu;
    h.SpeciesListMenu.add(h.AddSpeciesMenuItem);
    h.SpeciesListMenu.add(h.RemoveSpeciesMenuItem);
    h.SpeciesListMenu.add(h.RenameSpeciesMenuItem);
    h.SpeciesListMenu.addSeparator;
    h.SpeciesListMenu.add(h.RemoveFileMenuItem);
    h.SpeciesListMenu.addSeparator;
    h.SpeciesListMenu.add(h.SendToTauFit);
    h.ExportMenuItem.add(h.Export_FRET_Hist_Menu);
    h.ExportMenuItem.add(h.ExportSpeciesToPDAMenuItem);
    h.ExportMenuItem.add(h.ExportMicrotimePattern);
    h.ExportMenuItem.add(h.Export_FRET_Hist_Timeseries_Menu);
    h.SpeciesListMenu.add(h.ExportMenuItem);
    h.SpeciesListMenu.add(h.DoTimeWindowAnalysis);
    h.SpeciesListMenu.add(h.DynamicMenuItem);
    h.SpeciesListMenu.addSeparator;
    h.SpeciesListMenu.add(h.DisplayFileInfo);
    %%% Define Species List
    % new: use uitreenode
    %%% read icons
    [iconBurst,map] = imread([PathToApp filesep 'images/BurstBrowser/plottype-hist.gif']);
    iconBurst = ind2rgb(iconBurst,map);
    h.icons.iconBurst = imresize(iconBurst,[16,16]);
    h.icons.iconFile = imresize(imread([PathToApp filesep 'images/BurstBrowser/folder.jpg']),[16,16]);
    h.icons.iconSpecies = imresize(imread([PathToApp filesep 'images/BurstBrowser/book_sim.jpg']),[16,16]);
    h.icons.iconSubspecies = imresize(imread([PathToApp filesep 'images/BurstBrowser/help_rn.jpg']),[16,16]);
    h.SpeciesList.Root = uitreenode('v0','internalHandle','Burst Data',[],false);
    h.SpeciesList.Root.setIcon(im2java(h.icons.iconBurst));
    [h.SpeciesList.Tree, h.SpeciesList.container] = uitree('v0','Root',h.SpeciesList.Root);
    set(h.SpeciesList.container,...% 'Parent', h.SecondaryTabSelectionPanel,...
        'Parent',h.BurstBrowser,...
        'Units','normalize',...
        'Position',[0.65 0.03 0.35 0.22]);  % fix the uitree Parent
    set(h.SpeciesList.Tree,'NodeSelectedCallback',@SpeciesList_ButtonDownFcn);
    h.SpeciesList.Tree.getTree.setBackground(java.awt.Color(0.9,0.9,0.9));
    % Set the tree mouse-click callback
    set(h.SpeciesList.Tree.getTree, 'MousePressedCallback', {@SpeciesListContextMenuCallback,h.SpeciesListMenu});
    
    buttonsize = 20;
    offset = 5;
    button_posX = (h.SpeciesList.container.Position(1)+0.5*h.SpeciesList.container.Position(3))*h.figure_size(3);
    button_posY = 0.2375*h.figure_size(4)-buttonsize;

    %%% add buttons to species list
    h.AddSpecies_Button = uicontrol(...
        'Parent',h.BurstBrowser,...
        'Units','pixels',...
        'BackgroundColor','white',...
        'ForegroundColor', Look.Fore,...
        'Position',[button_posX button_posY buttonsize buttonsize],...
        'Style','pushbutton',...
        'Tag','AddSpecies_Button',...
        'FontSize',12,...
        'TooltipString','Add Species...',...
        'Callback',@AddSpecies);
    iconbutton(h.AddSpecies_Button,[PathToApp filesep 'images/BurstBrowser/GreenPlus_12.jpg']);

    h.RemoveSpecies_Button = uicontrol(...
        'Parent',h.BurstBrowser,...
        'Units','pixels',...
        'BackgroundColor','white',...
        'ForegroundColor', Look.Fore,...
        'Position',[button_posX+buttonsize+offset button_posY buttonsize buttonsize],...
        'Style','pushbutton',...
        'Tag','RemoveSpecies_Button',...
        'FontSize',12,...
        'TooltipString','Remove Species...',...
        'Callback',@RemoveSpecies);
    iconbutton(h.RemoveSpecies_Button,[PathToApp filesep 'images/BurstBrowser/status_failed.jpg']);
    
    h.RenameSpecies_Button = uicontrol(...
        'Parent',h.BurstBrowser,...
        'Units','pixels',...
        'BackgroundColor','white',...
        'ForegroundColor', Look.Fore,...
        'Position',[button_posX+2*(buttonsize+offset) button_posY buttonsize buttonsize],...
        'Style','pushbutton',...
        'Tag','RenameSpecies_Button',...
        'FontSize',12,...
        'TooltipString','Rename Species...',...
        'Callback',@RenameSpecies);
    iconbutton(h.RenameSpecies_Button,[PathToApp filesep 'images/BurstBrowser/cc_sourcecodec.jpg']);
    
    h.Send_to_TauFit_Button = uicontrol(...
        'Parent',h.BurstBrowser,...
        'Units','pixels',...
        'BackgroundColor','black',...
        'ForegroundColor', Look.Fore,...
        'Position',[button_posX+3*(buttonsize+offset)+10 button_posY buttonsize buttonsize],...
        'Style','pushbutton',...
        'Tag','Send_to_TauFit_Button',...
        'FontSize',12,...
        'TooltipString','Send selected species to TauFit',...
        'Callback',@Send_To_TauFit);
    iconbutton(h.Send_to_TauFit_Button,[PathToApp filesep 'images/BurstBrowser/lifetime.jpg']);
    
    h.Export_To_PDA_Button = uicontrol(...
        'Parent',h.BurstBrowser,...
        'Units','pixels',...
        'BackgroundColor','white',...
        'ForegroundColor', Look.Fore,...
        'Position',[button_posX+4*(buttonsize+offset)+10 button_posY buttonsize buttonsize],...
        'Style','pushbutton',...
        'Tag','Export_To_PDA_Button',...
        'FontSize',12,...
        'TooltipString','Export selected species to PDA',...
        'Callback',@Export_To_PDA);
    iconbutton(h.Export_To_PDA_Button,[PathToApp filesep 'images/BurstBrowser/plottype-hist.jpg']);
    
    %%% Context menu of multiplot button
    % option to toggle normalization, normalization method selection, and
    % display of sum of all populations
    h.MultiPlotButtonMenu = uicontextmenu;
    h.MultiPlotButtonMenu_ToggleDisplayTotal = uimenu(...
        h.MultiPlotButtonMenu,...
        'Tag','MultiPlotButtonMenu_ToggleDisplayTotal',...
        'Label','Display sum of all populations',...
        'Callback',@UpdateOptions);
    if UserValues.BurstBrowser.Settings.Display_Total_Multiplot
        h.MultiPlotButtonMenu_ToggleDisplayTotal.Checked = 'on';
    else
        h.MultiPlotButtonMenu_ToggleDisplayTotal.Checked = 'off';
    end
    h.MultiPlotButtonMenu_ToggleNormalize = uimenu(...
        h.MultiPlotButtonMenu,...
        'Tag','MultiPlotButtonMenu_ToggleNormalize',...
        'Label','Normalize populations',...
        'Callback',@UpdateOptions);
    if UserValues.BurstBrowser.Settings.Normalize_Multiplot
        h.MultiPlotButtonMenu_ToggleNormalize.Checked = 'on';
    else
        h.MultiPlotButtonMenu_ToggleNormalize.Checked = 'off';
    end
    h.MultiPlotButtonMenu_ChoooseNormalize = uimenu(...
        h.MultiPlotButtonMenu,...
        'Tag','MultiPlotButtonMenu_ChoooseNormalize',...
        'Label','Normalize to...',...
        'Callback',[]);
    h.MultiPlotButtonMenu_NormalizeArea = uimenu(...
        h.MultiPlotButtonMenu_ChoooseNormalize,...
        'Tag','MultiPlotButtonMenu_NormalizeArea',...
        'Label','area',...
        'Callback',@UpdateOptions);
    h.MultiPlotButtonMenu_NormalizeMaximum = uimenu(...
        h.MultiPlotButtonMenu_ChoooseNormalize,...
        'Tag','MultiPlotButtonMenu_NormalizeMaximum',...
        'Label','maximum',...
        'Callback',@UpdateOptions);
    switch UserValues.BurstBrowser.Settings.Normalize_Method
        case 'max'
            h.MultiPlotButtonMenu_NormalizeMaximum.Checked = 'on';
            h.MultiPlotButtonMenu_NormalizeArea.Checked = 'off';
        case 'area'
            h.MultiPlotButtonMenu_NormalizeMaximum.Checked = 'off';
            h.MultiPlotButtonMenu_NormalizeArea.Checked = 'on';
    end
    %%% Define MultiPlot Button
    h.MultiPlotButton = uicontrol(...
        'Parent',h.BurstBrowser,...
        'Units','pixels',...
        'BackgroundColor', 'white',...
        'ForegroundColor', Look.Fore,...
        'Position',[button_posX+3*(buttonsize+offset)+10 button_posY 2.5*buttonsize buttonsize],...
        'Style','pushbutton',...
        'Tag','MutliPlotButton',...
        'TooltipString','Plots multiple species using different colors. Support up to three species.',...
        'FontSize',12,...
        'Visible','off',...
        'Callback',@MultiPlot,...
        'Enable','on');
        %'String','Plot multiple species',...
    iconbutton(h.MultiPlotButton,[PathToApp filesep 'images/BurstBrowser/plot_multiple_icon.png']);
    
    h.MultiselectOnCheckbox = uicontrol(...
        'Parent',h.BurstBrowser,...
        'Units','pixels',...
        'BackgroundColor', 'white',...
        'ForegroundColor', Look.Fore,...
        'Position',[button_posX+6*(buttonsize+offset)+20 button_posY buttonsize buttonsize],...
        'Style','pushbutton',...
        'Tag','MultiselectOnCheckbox',...
        'FontSize',12,...
        'TooltipString','Enable multiselection for plotting',...
        'Callback',@UpdateOptions,...
        'UserData',0,...
        'UIContextMenu', h.MultiPlotButtonMenu);
    iconbutton(h.MultiselectOnCheckbox,[PathToApp filesep 'images/BurstBrowser/multiselection.png']);
    h.MultiselectOnCheckbox.CData(:,:,[2,3]) = 0;
    
    %%% Cut Table right click menu
    h.CutTable_Menu = uicontextmenu;
    h.StoreInCutDatabase_Menu = uimenu(...
        'Parent',h.CutTable_Menu,...
        'Tag','StoreInCutDatabase_Menu',...
        'Label','Store in cut database',...
        'Callback',@UpdateCutDatabase);
    h.ApplyCutsToLoaded_Menu = uimenu(...
        'Parent',h.CutTable_Menu,...
        'Tag','ApplyCutsToLoaded_Menu',...
        'Label','Apply current cuts to all loaded files',...
        'Separator','on',...
        'Callback',@ApplyCutsToLoaded);
    
    %define the cut table
    if ispc
        trash_image = ['<html><img src="file:/' PathToApp '/images/trash16p.png"/></html>'];
        trash_image = strrep(trash_image,'\','/');
        circle_image = ['<html><img src="file:/' PathToApp '/images/BurstBrowser/greencircleicon.gif"/></html>'];
        circle_image = strrep(circle_image,'\','/');
        zscale_image = ['<html><img src="file:/' PathToApp '/images/BurstBrowser/zscale_square.png"/></html>'];
        zscale_image = strrep(zscale_image,'\','/');
    else
        trash_image = ['<html><img src="file://' PathToApp '/images/trash16p.png"/></html>'];
        circle_image = ['<html><img src="file://' PathToApp '/images/BurstBrowser/greencircleicon.gif"/></html>'];
        zscale_image = ['<html><img src="file://' PathToApp '/images/BurstBrowser/zscale_square.png"/></html>'];
    end
    cname = {'<html><font size=4><b>Parameter</b></font></html>','<html><font size=4><b>min</b></font></html>','<html><font size=4><b>max</b></font></html>',circle_image,trash_image,zscale_image};
    cformat = {'char','numeric','numeric','logical','logical','logical'};
    ceditable = [false,true true true true true];
    table_dat = {'','','',false,false,false};
    cwidth = {225,80,80,25,25,25};
    
    h.CutTable = uitable(...
        'Parent',h.SecondaryTabSelectionPanel,...
        'Units','normalized',...
        'ForegroundColor',[0,0,0],...
        'Position',[0 0.04 1 0.345],...
        'BackgroundColor', [Look.Table1;Look.Table2],...
        'ForegroundColor', Look.TableFore,...
        'Tag','CutTable',...
        'RowName',[],...
        'ColumnName',cname,...
        'ColumnFormat',cformat,...
        'ColumnEditable',ceditable,...
        'Data',table_dat,...
        'ColumnWidth',cwidth,...
        'FontSize',12,...
        'CellEditCallback',@CutTableChange,...
        'UIContextMenu',h.CutTable_Menu);
    h.CutTable.Units = 'pixels';
    h.CutTable.ColumnWidth{1} = h.CutTable.Position(3)-2*80-2*25-56;
    h.CutTable.Units = 'normalized';
    
    %define the parameter selection listboxes
    h.ParameterListX = uicontrol(...
        'Parent',h.SecondaryTabSelectionPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.List,...
        'ForegroundColor', Look.ListFore,...
        'Max',1,...
        'Position',[0 0.385 0.5 0.615],...
        'Style','listbox',...
        'Tag','ParameterListX',...
        'Interruptible','off',...
        'Enable','on',...
        'FontSize',12,...
        'KeyPressFcn',@BurstBrowser_KeyPress);%,...
        %'Callback',{@ParameterList_ButtonDownFcn,'left'},...
        %'ButtonDownFcn',{@ParameterList_ButtonDownFcn,'right'});
    
    h.ParameterListY = uicontrol(...
        'Parent',h.SecondaryTabSelectionPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.List,...
        'ForegroundColor', Look.ListFore,...
        'Max',1,...
        'Position',[0.5 0.385 0.5 0.615],...
        'Style','listbox',...
        'Tag','ParameterListY',...
        'Interruptible','off',...
        'Enable','on',...
        'FontSize',12);%,...
        %'Callback',{@ParameterList_ButtonDownFcn,'left'},...
        %'ButtonDownFcn',{@ParameterList_ButtonDownFcn,'right'});
    
    % for right click selection to work, we need to access the underlying
    % java object
    %see: http://undocumentedmatlab.com/blog/setting-listbox-mouse-actions
    drawnow;
    jScrollPaneX = findjobj(h.ParameterListX);
    jScrollPaneY = findjobj(h.ParameterListY);
    jParameterListX = jScrollPaneX.getViewport.getComponent(0);
    jParameterListY = jScrollPaneY.getViewport.getComponent(0);
    jParameterListX = handle(jParameterListX, 'CallbackProperties');
    jParameterListY = handle(jParameterListY, 'CallbackProperties');
    set(jParameterListX, 'MousePressedCallback',{@ParameterList_ButtonDownFcn,h.ParameterListX});
    set(jParameterListY, 'MousePressedCallback',{@ParameterList_ButtonDownFcn,h.ParameterListY});
    
    %define manual cut button
    h.CutButton = uicontrol(...
        'Parent',h.SecondaryTabSelectionPanel,...
        'Units','normalized',...
        'BackgroundColor','white',...
        'ForegroundColor', Look.Fore,...
        'Position',[0 0.0025 0.05 0.035],...
        'Style','pushbutton',...
        'Tag','CutButton',...
        'FontSize',12,...
        'TooltipString','Manual Cut (ctr+space)',...
        'Callback',@ManualCut);
    iconbutton(h.CutButton,[PathToApp filesep 'images/BurstBrowser/crop_tool.jpg']);
    %define arbitrary cut button
    h.ArbitraryCutButton = uicontrol(...
        'Parent',h.SecondaryTabSelectionPanel,...
        'Units','normalized',...
        'BackgroundColor','white',...
        'ForegroundColor', Look.Fore,...
        'Position',[0.05 0.0025 0.05 0.035],...
        'Style','pushbutton',...
        'Tag','ArbitraryCutButton',...
        'FontSize',12,...
        'TooltipString','Arbitrary Cut (space)',...
        'Callback',@ManualCut);
    iconbutton(h.ArbitraryCutButton,[PathToApp filesep 'images/BurstBrowser/Freehand_24px.jpg']);
    h.ArbitraryCutButton_Menu = uicontextmenu;
    h.ArbitraryCutInvertCheckbox = uimenu(...
        'Parent',h.ArbitraryCutButton_Menu,...
        'Label','Invert Arbitrary Region Cut',...
        'Checked','off',...
        'Callback',@UpdateOptions);
    h.ArbitraryCutButton.UIContextMenu = h.ArbitraryCutButton_Menu;
    %h.ArbitraryCutInvertCheckbox = uicontrol(...
    %    'Parent',h.SecondaryTabSelectionPanel,...
    %    'Units','normalized',...
    %    'BackgroundColor', Look.Back,...
    %    'ForegroundColor', Look.Fore,...
    %    'Position',[0.86 0.0025 0.14 0.035],...
    %    'Style','checkbox',...
    %    'Tag','ArbitraryCutInvertCheckbox',...
    %    'String','Invert AR',...
    %    'Value',0,...
    %    'FontSize',12,...
    %    'TooltipString','Invert arbitrary cut',...
    %    'Callback',[]);
    cutdatabasetooltip = '<html>Cut Database:<br>Define Cuts and store in Database for frequent use.<br>Choose to add cuts to current species, or add a new species with the defined cuts.</html>';
    h.CutDatabaseText = uicontrol(...
        'Parent',h.SecondaryTabSelectionPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.1 0.0025 0.2 0.035],...
        'Style','text',...
        'Tag','CutDatabaseText',...
        'HorizontalAlignment','right',...
        'TooltipString',cutdatabasetooltip,...
        'String','Cut Database:',...
        'FontSize',12);
    %define cut selection popupmenu
    h.CutDatabase = uicontrol(...
        'Parent',h.SecondaryTabSelectionPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.3 0.0025 0.5 0.035],...
        'Style','popupmenu',...
        'Tag','CutDatabase',...
        'TooltipString',cutdatabasetooltip,...
        'String',{'-'},...
        'FontSize',12);
    %%% Update string if cuts have been stores
    if ~isempty(fieldnames(UserValues.BurstBrowser.CutDatabase{1}))
        h.CutDatabase.String = fieldnames(UserValues.BurstBrowser.CutDatabase{1});
    end
    %%% Button for applying cut from database
    h.ApplyCutDatabase = uicontrol(...
        'Parent',h.SecondaryTabSelectionPanel,...
        'Units','normalized',...
        'BackgroundColor','white',...
        'ForegroundColor', Look.Fore,...
        'Position',[0.9 0.0025 0.05 0.035],...
        'Style','pushbutton',...
        'Tag','ApplyCutDatabase',...
        'FontSize',12,...
        'TooltipString','Applies cut from database.',...
        'Callback',@UpdateCutDatabase);
    iconbutton(h.ApplyCutDatabase,[PathToApp filesep 'images/BurstBrowser/Floodfill_24.jpg']);
    h.AddCutDatabase = uicontrol(...
        'Parent',h.SecondaryTabSelectionPanel,...
        'Units','normalized',...
        'BackgroundColor','white',...
        'ForegroundColor', Look.Fore,...
        'Position',[0.95 0.0025 0.05 0.035],...
        'Style','pushbutton',...
        'Tag','AddCutDatabase',...
        'FontSize',12,...
        'TooltipString','Adds cut from database as species',...
        'Callback',@UpdateCutDatabase);
    iconbutton(h.AddCutDatabase,[PathToApp filesep 'images/BurstBrowser/GreenPlus_12.jpg']);
    %%% Right-click menu for removing cut from database
    h.ApplyCutDatabase_Menu = uicontextmenu;
    h.PrintDatabaseCut_Menu = uimenu(...
        'Parent',h.ApplyCutDatabase_Menu,...
        'Tag','PrintDatabaseCut_Menu',...
        'Label','Display Selected Cut from Database',...
        'Callback',@UpdateCutDatabase);
    h.RemoveCutDatabase_Menu = uimenu(...
        'Parent',h.ApplyCutDatabase_Menu,...
        'Tag','RemoveCutDatabase_Menu',...
        'Label','Remove Cut from Database',...
        'Callback',@UpdateCutDatabase);
    h.CutDatabase.UIContextMenu = h.ApplyCutDatabase_Menu;
    %% Secondary tab corrections
    s.ProgressRatio = 0.5;
    %%% Buttons
    %%% vertical layout for buttons
    h.CorrectionsButtonsContainer = uiflowcontainer(...
        'Parent',h.SecondaryTabCorrectionsPanel,...
        'Units','norm',...
        'Position',[0 0.6 0.5 0.4],...
        'FlowDirection','TopDown',...
        'Margin',10,...
        'BackgroundColor',Look.Back);
    %%% Button to determine CrossTalk and DirectExcitation
    h.DetermineCorrectionsButton = uicontrol(...
        'Parent',h.CorrectionsButtonsContainer,...
        'Units','normalized',...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0 0.95 0.4 0.03],...
        'Style','pushbutton',...
        'Tag','DetermineCorrectionsButton',...
        'String','Fit ct/de',...
        'TooltipString',sprintf('Uses donor and acceptor only subpopulations\nto determine crosstalk (ct) and direct excitation (de).'),...
        'FontSize',12,...
        'Callback',@DetermineCorrections);
    
    %%% Layout container for edit box and text
%     h.CorrectionsFilterContainer = uigridcontainer(...
%         'GridSize',[1,2],...
%         'HorizontalWeight',[0.7,0.3],...
%         'Parent',h.CorrectionsButtonsContainer,...
%         'Units','norm',...
%         'Position',[.1,.1,.8,.8],...
%         'BackgroundColor',Look.Back);
%     h.TGX_TRR_text = uicontrol('Style','text',...
%         'Tag','T_Threshold_Text',...
%         'String','Threshold |TGX-TRR|',...
%         'FontSize',12,...
%         'Units','normalized',...
%         'Parent',h.CorrectionsFilterContainer,...
%         'Position',[0.45 0.96 0.35 0.02],...
%         'BackgroundColor',Look.Back,...
%         'ForegroundColor',Look.Fore);
%     
%     h.T_Threshold_Edit =  uicontrol('Style','edit',...
%         'Tag','T_Threshold_Edit',...
%         'String','0.1',...
%         'FontSize',12,...
%         'Units','normalized',...
%         'Parent',h.CorrectionsFilterContainer,...
%         'Position',[0.8 0.96 0.15 0.02],...
%         'BackgroundColor',Look.Control,...
%         'ForegroundColor',Look.Fore);
    h.Menu_gammadetermination = uicontextmenu;
    h.DetermineGammaManuallyButton = uimenu(...
        'Parent',h.Menu_gammadetermination,...
        'Label','<html>Determine gamma factor manually.<br>Select the midpoints of two different FRET species in S vs E plot.<br>Uses currently selected bursts.</html>',...
        'Tag','DetermineGammaManuallyButton',...
        'Callback',@DetermineCorrections);
    %%% Button to fit gamma
    h.FitGammaButton = uicontrol(...
        'Parent',h.CorrectionsButtonsContainer,...
        'Units','normalized',...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0 0.91 0.4 0.03],...
        'Style','pushbutton',...
        'Tag','FitGammaButton',...
        'String','<html>Fit &gamma;-factor</html>',...
        'TooltipString','<html>Fit &gamma;-factor by linear interpolation of 1/S vs. E.<br>At least 2 FRET species are required.<br>Uses currently selected bursts.</html>',...
        'FontSize',12,...
        'UIContextMenu',h.Menu_gammadetermination,...
        'Callback',@DetermineCorrections);
    
    %%% Button for manual gamma determination
    h.CalculateGammaButton = uicontrol(...
        'Parent',h.CorrectionsButtonsContainer,...
        'Units','normalized',...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0 0.86 0.4 0.03],...
        'Style','pushbutton',...
        'Tag','CalculateGammaButton',...
        'String','<html>Calculate &gamma;-factor</html>',...
        'TooltipString','<html>Calculates the &gamma;-factor from specified center values</html>',...
        'FontSize',12,...
        'Callback',@CalculateGammaGUI);
    
    %%% Button to determine gamma from lifetime
    h.DetermineGammaLifetimeTwoColorButton = uicontrol(...
        'Parent',h.CorrectionsButtonsContainer,...
        'Units','normalized',...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.5 0.91 0.5 0.03],...
        'Style','pushbutton',...
        'Tag','DetermineGammaLifetimeTwoColorButton',...
        'String','<html>Fit &gamma;-factor from lifetime</html>',...
        'TooltipString','<html>Determine &gamma;-factor from lifetime. <br>Minimizes deviation between data and static FRET line.<br>Uses currently selected bursts.</html>',...
        'FontSize',12,...
        'Callback',@DetermineCorrections);
    
    %     h.GetBackgroundTwoColorButton = uicontrol(...
    %         'Parent',h.SecondaryTabCorrectionsPanel,...
    %         'Units','normalized',...
    %         'BackgroundColor', Look.Control,...
    %         'ForegroundColor', Look.Fore,...
    %         'Position',[0.5 0.86 0.5 0.03],...
    %         'Style','pushbutton',...
    %         'Tag','GetBackgroundTwoColorButton',...
    %         'String','Get Background from data',...
    %         'FontSize',12,...
    %         'Callback',@GetBackground);
    
    h.DetermineGammaLifetimeThreeColorButton = uicontrol(...
        'Parent',h.SecondaryTabCorrectionsPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.5 0.86 0.5 0.03],...
        'Style','pushbutton',...
        'Tag','DetermineGammaLifetimeThreeColorButton',...
        'String','<html>Fit &gamma;-factor from lifetime (3C)</html>',...
        'TooltipString','<html>Determine &gamma;<sub>BG</sub> and &gamma;<sub>BR</sub> from lifetime (3C)<br>Minimizes the deviation between data and static FRET line for total FRET efficiency from B->G+R and blue lifetime.<br>Uses currently selected bursts and takes previously determined value for &gamma;<sub>GR</sub> for calculations.</html>',...
        'FontSize',12,...
        'Callback',@DetermineCorrections,...
        'Visible','off');
    
    %     h.GetBackgroundThreeColorButton = uicontrol(...
    %         'Parent',h.SecondaryTabCorrectionsPanel,...
    %         'Units','normalized',...
    %         'BackgroundColor', Look.Control,...
    %         'ForegroundColor', Look.Fore,...
    %         'Position',[0.5 0.81 0.5 0.03],...
    %         'Style','pushbutton',...
    %         'Tag','GetBackgroundThreeColorButton',...
    %         'String','Get Background from data',...
    %         'FontSize',12,...
    %         'Callback',@GetBackground,...
    %         'Visible','off');
    
    %%% Button to apply custom correction factors
    h.ApplyCorrectionsButton = uicontrol(...
        'Parent',h.CorrectionsButtonsContainer,...
        'Units','normalized',...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0 0.81 0.4 0.03],...
        'Style','pushbutton',...
        'Tag','ApplyCorrectionsButton',...
        'String','Apply Corrections',...
        'TooltipString','Apply corrections to selected data',...
        'FontSize',12,...
        'Callback',@ApplyCorrections);
    h.ApplyCorrection_Menu = uicontextmenu;
    h.ApplyCorrectionsAll_Menu = uimenu(...
        'Parent',h.ApplyCorrection_Menu,...
        'Tag','ApplyCorrectionsAll_Menu',...
        'Label','Replace corrections of all files with current one',...
        'Callback',@ApplyCorrections);
    set(h.ApplyCorrectionsButton,'UIContextMenu',h.ApplyCorrection_Menu);
    %%% Checkbox to enabel/disable beta factor Stoichiometry corrections
    %%% (Corrects S to be 0.5 for double labeled)
    h.UseBetaCheckbox = uicontrol(...
        'Parent',h.CorrectionsButtonsContainer,...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0 0.76 0.4 0.03],...
        'Style','checkbox',...
        'Tag','UseBetaCheckbox',...
        'Value',UserValues.BurstBrowser.Corrections.UseBeta,...
        'String','<html>&beta - Correction of Stoichiometry</html>',...
        'TooltipString','<html>Applies &beta correction of Stoichiometry accounting for<br>different excitation efficiencies.</html>',...
        'FontSize',12,...
        'Callback',@ApplyCorrections);
    
    %%% Table for Corrections factors
    Corrections_Rownames = {'<html><b>&gamma</b></html>','<html><b>&beta</b></html>',...
        '<html><b>crosstalk</b></html>','<html><b>direct exc.</b></html>',...
        '<html><b>G(green)</b></html>','<html><b>G(red)</b></html>',...
        '<html><b>l1</b></html>','<html><b>l2</b></html>',...
        '<html><b>BG DD par</b></html>','<html><b>BG DD perp</b></html>','<html><b>BG DA par</b></html>',...
        '<html><b>BG DA perp</b></html>','<html><b>BG AA par</b></html>','<html><b>BG AA perp</b></html>'}';
    Corrections_Columnnames = {'<html><b>Parameter</b></html>','<html><b>Value</b></html>'};
    Corrections_Editable = [false,true];
    Corrections_Data = {1;1;0;0;1;1;0;0;0:0;0;0;0;0;0};
    Corrections_Columnformat = {'char','numeric'};
    Tooltip = ['<html>Correction factors:<br>',...
        '&gamma: Detection efficiency ratio red over green<br>',...
        '&beta: Excitation efficiency ratio red over green<br>',...
        'crosstalk: Spectral crosstalk as percentage of donor signal<br>',...
        'direct exc.: Direct acceptor excitation by donor laser as percentage of acceptor signal after direct acceptor probing<br>',...
        'G: Detection efficiency ratio perpendicular over parallel channel<br>',...
        'l1,l2: Anisotropy correction factors accounting for polarization mixing by high N.A. objective<br>',...
        'BG: Background counts per channel in kHz',...
        '</html>'];
    h.CorrectionsTable = uitable(...
        'Parent',h.SecondaryTabCorrectionsPanel,...
        'Units','normalized',...
        'Tag','CorrectionsTable',...
        'Position',[0.5 0.4 0.5 0.6],...
        'Data',horzcat(Corrections_Rownames,Corrections_Data),...
        'BackgroundColor', [Look.Table1;Look.Table2],...
        'ForegroundColor', Look.TableFore,...
        'RowName',[],...
        'ColumnName',Corrections_Columnnames,...
        'ColumnEditable',Corrections_Editable,...
        'ColumnFormat',Corrections_Columnformat,...
        'ColumnWidth',{100,50},...
        'TooltipString',Tooltip,...
        'CellEditCallback',@UpdateCorrections,...
        'ForegroundColor',[0,0,0]);
    
    %%% Uipanel for fitting lifetime-related quantities
    h.FitLifetimeRelatedPanel = uipanel(...
        'Parent',h.Secondary_Tab_Fitting,...
        'Units','normalized',...
        'Position',[0 0.5 1 0.5],...
        'Tag','DisplayOptionsPanel',...
        'BackgroundColor',Look.Back,...
        'ForegroundColor',Look.Fore,...
        'Title','Lifetime Plots',...
        'HighlightColor',Look.Fore,...
        'FontSize',12);
    
    h.FitAnisotropyButton = uicontrol(...
        'Parent',h.FitLifetimeRelatedPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.05 0.89 0.4 0.1],...
        'Style','pushbutton',...
        'Tag','FitAnisotropyButton',...
        'String','Fit Anisotropy',...
        'FontSize',12,...
        'TooltipString','<html>Fit Perrin line to anisotropy plots.<br>r(&tau)=r<sub>0</sub>/(1+&tau/&rho)</html>',...
        'Callback',@UpdateLifetimeFits);
    
    h.ManualAnisotropyButton = uicontrol(...
        'Parent',h.FitLifetimeRelatedPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.05 0.79 0.4 0.1],...
        'Style','pushbutton',...
        'Tag','ManualAnisotropyButton',...
        'String','Manual Perrin line',...
        'TooltipString','<html>Add manual Perrin line to anisotropy plots by clicking species mid-point.<br>r(&tau)=r<sub>0</sub>/(1+&tau/&rho)<br>Left-click adds first line or resets if multiple lines were present.<br>Right-click adds new line (up to three).</html>',...
        'FontSize',12,...
        'Callback',@UpdateLifetimeFits);
    
    h.r0Green_text = uicontrol(...
        'Parent',h.FitLifetimeRelatedPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.5 0.92 0.2 0.07],...
        'Style','text',...
        'Tag','r0GG_text',...
        'String','r0 Donor',...
        'HorizontalAlignment','left',...
        'TooltipString','Fundamental anisotropy of green dye',...
        'FontSize',12);
    
    h.r0Green_edit = uicontrol(...
        'Parent',h.FitLifetimeRelatedPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.75 0.92 0.2 0.07],...
        'Style','edit',...
        'Tag','r0Green_edit',...
        'String',num2str(UserValues.BurstBrowser.Corrections.r0_green),...
        'TooltipString','Fundamental anisotropy of green dye',...
        'FontSize',12,...
        'Callback',@UpdateCorrections);
    
    h.r0Red_text = uicontrol(...
        'Parent',h.FitLifetimeRelatedPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.5 0.84 0.2 0.07],...
        'Style','text',...
        'HorizontalAlignment','left',...
        'Tag','r0RR_text',...
        'String','r0 Acceptor',...
        'TooltipString','Fundamental anisotropy of red dye',...
        'FontSize',12);
    
    h.r0Red_edit = uicontrol(...
        'Parent',h.FitLifetimeRelatedPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.75 0.84 0.2 0.07],...
        'Style','edit',...
        'Tag','r0Red_edit',...
        'String',num2str(UserValues.BurstBrowser.Corrections.r0_red),...
        'TooltipString','Fundamental anisotropy of red dye',...
        'FontSize',12,...
        'Callback',@UpdateCorrections);
    
    h.r0Blue_text = uicontrol(...
        'Parent',h.FitLifetimeRelatedPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.5 0.76 0.2 0.07],...
        'Style','text',...
        'Tag','r0BB_text',...
        'HorizontalAlignment','left',...
        'String','r0 Blue',...
        'TooltipString','Fundamental anisotropy of blue dye',...
        'FontSize',12,...
        'Visible','off');
    
    h.r0Blue_edit = uicontrol(...
        'Parent',h.FitLifetimeRelatedPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.75 0.76 0.2 0.07],...
        'Style','edit',...
        'Tag','r0Blue_edit',...
        'String',num2str(UserValues.BurstBrowser.Corrections.r0_blue),...
        'TooltipString','Fundamental anisotropy of blue dye',...
        'FontSize',12,...
        'Visible','off',...
        'Callback',@UpdateCorrections);
    
    h.PlotStaticFRETButton = uicontrol(...
        'Parent',h.FitLifetimeRelatedPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.05 0.55 0.4 0.1],...
        'Style','pushbutton',...
        'Tag','PlotStaticFRETButton',...
        'String','Plot static FRET line',...
        'TooltipString','<html>Add static FRET line: E=1-&tau<sub>D,A</sub>/&tau<sub>D,0</sub><br>Includes linker contributions given by F?rster radius and effective linker length.</html>',...
        'FontSize',12,...
        'Callback',@UpdateLifetimeFits);
    
    h.DynamicFRET_Menu = uicontextmenu;
    h.DynamicFRETManual_Menu = uimenu(...
        'Parent',h.DynamicFRET_Menu,...
        'Tag','DynamicFRETManual_Menu',...
        'Callback',@UpdateLifetimeFits,...
        'Label','Define States');
    h.DynamicFRETRemove_Menu = uimenu(...
        'Parent',h.DynamicFRET_Menu,...
        'Tag','DynamicFRETRemove_Menu',...
        'Callback',@UpdateLifetimeFits,...
        'Label','Remove Plot');
    
    h.PlotDynamicFRETButton = uicontrol(...
        'Parent',h.FitLifetimeRelatedPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.55 0.55 0.4 0.1],...
        'Style','pushbutton',...
        'Tag','PlotDynamicFRETButton',...
        'String','Dynamic FRET line',...
        'TooltipString','<html>Add dynamic FRET line by clicking start and end point donor lifetimes in Efficiency-&tau<sub>DA</sub> plot<br>Right-click: Open menu to enter state donor lifetimes manually or remove plots.<br>A total of three lines can be added.</html>',...
        'FontSize',12,...
        'UIContextMenu',h.DynamicFRET_Menu,...
        'Callback',@UpdateLifetimeFits);
    
    h.DonorLifetimeText = uicontrol(...
        'Parent',h.FitLifetimeRelatedPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.05 0.45 0.35 0.07],...
        'HorizontalAlignment','left',...
        'Style','text',...
        'Tag','SelectDonorDyeText',...
        'String','Donor Lifetime (ns)',...
        'TooltipString','Lifetime of the donor dye in absence of the acceptor dye',...
        'FontSize',12);
    
    h.DonorLifetimeEdit = uicontrol(...
        'Parent',h.FitLifetimeRelatedPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.37 0.45 0.1 0.07],...
        'Style','edit',...
        'Tag','DonorLifetimeEdit',...
        'String',num2str(UserValues.BurstBrowser.Corrections.DonorLifetime),...
        'TooltipString','Lifetime of the donor dye in absence of the acceptor dye',...
        'FontSize',12,...
        'Callback',@UpdateCorrections);
    
    h.AcceptorLifetimeText = uicontrol(...
        'Parent',h.FitLifetimeRelatedPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.05 0.3 0.35 0.07],...
        'HorizontalAlignment','left',...
        'Style','text',...
        'Tag','SelectAcceptorDyeText',...
        'String','Acceptor Lifetime (ns)',...
        'TooltipString','Lifetime of the acceptor dye',...
        'FontSize',12);
    
    h.AcceptorLifetimeEdit = uicontrol(...
        'Parent',h.FitLifetimeRelatedPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.37 0.3 0.1 0.07],...
        'Style','edit',...
        'Tag','AcceptorLifetimeEdit',...
        'String',num2str(UserValues.BurstBrowser.Corrections.AcceptorLifetime),...
        'TooltipString','Lifetime of the acceptor dye',...
        'FontSize',12,...
        'Callback',@UpdateCorrections);
    
    h.DonorLifetimeBlueText = uicontrol(...
        'Parent',h.FitLifetimeRelatedPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.05 0.15 0.35 0.07],...
        'Style','text',...
        'Tag','DonorLifetimeBlueText',...
        'String','Donor Lifetime Blue (ns)',...
        'TooltipString','Lifetime of the blue dye in absence of the acceptor dyes',...
        'HorizontalAlignment','left',...
        'Visible','off',...
        'FontSize',12);
    
    h.DonorLifetimeBlueEdit = uicontrol(...
        'Parent',h.FitLifetimeRelatedPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.37 0.15 0.1 0.07],...
        'Style','edit',...
        'Tag','DonorLifetimeBlueEdit',...
        'String',num2str(UserValues.BurstBrowser.Corrections.DonorLifetimeBlue),...
        'TooltipString','Lifetime of the blue dye in absence of the acceptor dyes',...
        'FontSize',12,...
        'Visible','off',...
        'Callback',@UpdateCorrections);
    
    h.DonorLifetimeFromDataCheckbox = uicontrol(....
        'Parent',h.FitLifetimeRelatedPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.05 0.05 0.4 0.1],...
        'Style','pushbutton',...
        'Tag','DonorLifetimeFromDataCheckbox',...
        'String','Get dye lifetimes from data',...
        'TooltipString','Extract dye lifetimes from single-labeled subpopulations using stoichiometry threshold.',...
        'enable','off',...
        'FontSize',12,...
        'Callback',@DonorOnlyLifetimeCallback);
    
    h.FoersterRadiusText = uicontrol(...
        'Parent',h.FitLifetimeRelatedPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.5 0.45 0.35 0.07],...
        'Style','text',...
        'Tag','FoersterRadiusText',...
        'String','Foerster Radius [A]',...
        'HorizontalAlignment','left',...
        'FontSize',12);
    
    h.FoersterRadiusEdit = uicontrol(...
        'Parent',h.FitLifetimeRelatedPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.87 0.45 0.1 0.07],...
        'Style','edit',...
        'Tag','FoersterRadiusEdit',...
        'String',num2str(UserValues.BurstBrowser.Corrections.FoersterRadius),...
        'FontSize',12,...
        'Callback',@UpdateCorrections);
    
    h.LinkerLengthText = uicontrol(...
        'Parent',h.FitLifetimeRelatedPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.5 0.37 0.35 0.07],...
        'Style','text',...
        'Tag','LinkerLengthText',...
        'String','Linker Length [A]',...
        'HorizontalAlignment','left',...
        'FontSize',12);
    
    h.LinkerLengthEdit = uicontrol(...
        'Parent',h.FitLifetimeRelatedPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.87 0.37 0.1 0.07],...
        'Style','edit',...
        'Tag','LinkerLengthEdit',...
        'String',num2str(UserValues.BurstBrowser.Corrections.LinkerLength),...
        'FontSize',12,...
        'Callback',@UpdateCorrections);
    
    h.FoersterRadiusBGText = uicontrol(...
        'Parent',h.FitLifetimeRelatedPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.5 0.29 0.35 0.07],...
        'Style','text',...
        'Tag','FoersterRadiusBGText',...
        'HorizontalAlignment','left',...
        'String','Foerster Radius BG [A]',...
        'FontSize',12,...
        'Visible','off');
    
    h.FoersterRadiusBGEdit = uicontrol(...
        'Parent',h.FitLifetimeRelatedPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.87 0.29 0.1 0.07],...
        'Style','edit',...
        'Tag','FoersterRadiusBGEdit',...
        'String',num2str(UserValues.BurstBrowser.Corrections.FoersterRadiusBG),...
        'FontSize',12,...
        'Visible','off',...
        'Callback',@UpdateCorrections);
    
    h.LinkerLengthBGText = uicontrol(...
        'Parent',h.FitLifetimeRelatedPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.5 0.21 0.35 0.07],...
        'Style','text',...
        'Tag','LinkerLengthBGText',...
        'HorizontalAlignment','left',...
        'String','Linker Length BG [A]',...
        'Visible','off',...
        'FontSize',12);
    
    h.LinkerLengthBGEdit = uicontrol(...
        'Parent',h.FitLifetimeRelatedPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.87 0.21 0.1 0.07],...
        'Style','edit',...
        'Tag','F?rsterRadiusEdit',...
        'String',num2str(UserValues.BurstBrowser.Corrections.LinkerLengthBG),...
        'FontSize',12,...
        'Visible','off',...
        'Callback',@UpdateCorrections);
    
    h.FoersterRadiusBRText = uicontrol(...
        'Parent',h.FitLifetimeRelatedPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.5 0.13 0.35 0.07],...
        'Style','text',...
        'Tag','FoersterRadiusBRText',...
        'HorizontalAlignment','left',...
        'String','Foerster Radius BR [A]',...
        'Visible','off',...
        'FontSize',12);
    
    h.FoersterRadiusBREdit = uicontrol(...
        'Parent',h.FitLifetimeRelatedPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.87 0.13 0.1 0.07],...
        'Style','edit',...
        'Tag','FoersterRadiusBREdit',...
        'String',num2str(UserValues.BurstBrowser.Corrections.FoersterRadiusBR),...
        'FontSize',12,...
        'Visible','off',...
        'Callback',@UpdateCorrections);
    
    h.LinkerLengthBRText = uicontrol(...
        'Parent',h.FitLifetimeRelatedPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.5 0.05 0.35 0.07],...
        'Style','text',...
        'Tag','LinkerLengthBRText',...
        'HorizontalAlignment','left',...
        'Visible','off',...
        'String','Linker Length BR [A]',...
        'FontSize',12);
    
    h.LinkerLengthBREdit = uicontrol(...
        'Parent',h.FitLifetimeRelatedPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.87 0.05 0.1 0.07],...
        'Style','edit',...
        'Tag','FoersterRadiusBREdit',...
        'String',num2str(UserValues.BurstBrowser.Corrections.LinkerLengthBR),...
        'FontSize',12,...
        'Visible','off',...
        'Callback',@UpdateCorrections);
    %% Secondary tab correlation
    h.Correlation_Panel = uipanel(...
        'Parent',h.SecondaryTabCorrectionsPanel,...
        'Units','normalized',...
        'Position',[0 0 1 0.4],...
        'Tag','DisplayOptionsPanel',...
        'BackgroundColor',Look.Back,...
        'ForegroundColor',Look.Fore,...
        'Title','Burstwise FCS',...
        'HighlightColor',Look.Fore,...
        'FontSize',12);
    %%% Contexmenu for correlation table
    h.Secondary_Tab_Correlation_Menu = uicontextmenu;
    
    %%% Sets a divider for correlation
    h.Secondary_Tab_Correlation_Standard2CMFD_Menu = uimenu(...
        'Parent',h.Secondary_Tab_Correlation_Menu,...
        'Label','FRET FCCS selection',...
        'Tag','Secondary_Tab_Correlation_Standard2CMFD_Menu',...
        'Callback',@Calculate_Settings,...
        'Visible','off');
    h.Secondary_Tab_Correlation_Reset_Menu = uimenu(...
        'Parent',h.Secondary_Tab_Correlation_Menu,...
        'Label','Reset',...
        'Tag','Secondary_Tab_Correlation_Reset_Menu',...
        'Callback',@Calculate_Settings);
    h.Secondary_Tab_Correlation_Divider_Menu = uimenu(...
        'Parent',h.Secondary_Tab_Correlation_Menu,...
        'Label',['Divider: ' num2str(UserValues.Settings.Pam.Cor_Divider)],...
        'Tag','Secondary_Tab_Correlation_Divider_Menu',...
        'Callback',@Calculate_Settings,...
        'Separator','on');
    
    Names = {'DD1','DD2','DA1','DA2','AA1','AA2','DD','DA','DX','DX1','DX2','AA'};
    h.Correlation_Table = uitable(...
        'Parent',h.Correlation_Panel,...
        'Units','normalized',...
        'Position',[0 0.12 1 0.88],...
        'Tag','CorrelationTable',...
        'TooltipString',sprintf([...
        'Rightclick to open contextmenu with additional function: \n'...
        'Divider: Divider for correlation time resolution for certain excitation schemes']),...
        'UIContextMenu',h.Secondary_Tab_Correlation_Menu,...
        'ColumnWidth',{40},...
        'ColumnEditable',true,...
        'ColumnName',Names,...
        'BackgroundColor', [Look.Table1;Look.Table2],...
        'ForegroundColor', Look.TableFore,...
        'RowName',Names,...
        'Data',false(numel(Names)));
    
    h.Correlate_Button = uicontrol(...
        'Style','pushbutton',...
        'Parent',h.Correlation_Panel,...
        'Units','normalized',...
        'Position',[0.01 0.025 0.25 0.08],...
        'Tag','Correlate_Button',...
        'String','Correlate',...
        'ForegroundColor',Look.Fore,...
        'BackgroundColor',Look.Control,...
        'FontSize',12,...
        'Callback',@Correlate_Bursts);
    
%     h.LoadAllPhotons_Button = uicontrol(...
%         'Style','pushbutton',...
%         'Parent',h.SecondaryTabCorrelationPanel,...
%         'Units','normalized',...
%         'Position',[0 0.45 0.3 0.05],...
%         'ForegroundColor',Look.Fore,...
%         'BackgroundColor',Look.Control,...
%         'Tag','LoadAllPhotons_Button',...
%         'String','Load All Photons (*.aps)',...
%         'FontSize',12,...
%         'Callback',@Load_Photons);
    h.CorrelateWindow_Menu = uicontextmenu;
    h.BurstwiseDiffusionTime_Menu = uimenu(...
        'Parent',h.CorrelateWindow_Menu,...
        'Label','Fit burst wise diffusion time',...
        'Callback',@Correlate_Bursts);
    h.CorrelateWindow_Button = uicontrol(...
        'Style','pushbutton',...
        'Parent',h.Correlation_Panel,...
        'Units','normalized',...
        'Position',[0.27 0.025 0.33 0.08],...
        'Tag','CorrelateWindow_Button',...
        'String','Correlate with time window',...
        'ForegroundColor',Look.Fore,...
        'BackgroundColor',Look.Control,...
        'Callback',@Correlate_Bursts,...
        'FontSize',12,...
        'Enable','on',...
        'UIContextMenu',h.CorrelateWindow_Menu);
    
    h.CorrelateWindow_Edit = uicontrol(...
        'Style','edit',...
        'Parent',h.Correlation_Panel,...
        'Units','normalized',...
        'BackgroundColor',Look.Control,...
        'ForegroundColor',Look.Fore,...
        'Position',[0.87 0.025 0.12 0.08],...
        'Tag','CorrelateWindow_Edit',...
        'String',num2str(UserValues.BurstBrowser.Settings.Corr_TimeWindowSize),...
        'Callback',@UpdateOptions,...
        'FontSize',12,...
        'Enable','on');
    
    h.CorrelateWindow_Text = uicontrol(...
        'Style','text',...
        'Parent',h.Correlation_Panel,...
        'Units','normalized',...
        'Position',[0.6 0.035 0.265 0.08],...
        'Tag','CorrelateWindow_Text',...
        'String','Time window [ms]:',...
        'Callback',@UpdateOptions,...
        'BackgroundColor',Look.Back,...
        'ForegroundColor',Look.Fore,...
        'HorizontalAlignment','right',...
        'FontSize',12,...
        'Enable','on');
    
    %%% Gaussian mixture fitting
    h.FitGaussian_Panel = uipanel(...
        'Parent',h.Secondary_Tab_Fitting,...
        'Units','normalized',...
        'Position',[0 0 1 0.5],...
        'Tag','FitGaussian_Panel',...
        'BackgroundColor',Look.Back,...
        'ForegroundColor',Look.Fore,...
        'Title','Gaussian Mixture Fitting',...
        'HighlightColor',Look.Fore,...
        'FontSize',12);
    
    h.Fit_Gaussian_Button = uicontrol(...
        'Parent',h.FitGaussian_Panel,...
        'Callback',@UpdatePlot,...
        'Units','normalized',...
        'Position',[0.1,0.9,0.3,0.08],...
        'String','Fit Gaussian mixture',...
        'ForegroundColor',Look.Fore,...
        'BackgroundColor',Look.Control,...
        'FontSize',12,...
        'TooltipString','<html>Fits a Gaussian mixture model to current 2D plot using the gmdistfit function in Matlab.<br>To fit 1D only, select the same parameter for x and y.<br>Set number of Gaussian using the popupmenu.<br>Start points are guessed unless fixed when using LSQ.</html>');
    h.Fit_NGaussian_Popupmenu = uicontrol('Style','popup',...
        'Units','normalized',...
        'Callback',@UpdateOptions,...
        'Position',[0.4,0.9,0.2,0.08],...
        'String',{'1','2','3','4','5'},...
        'Parent',h.FitGaussian_Panel,...
        'FontSize',12,...
        'TooltipStr','Number of Gaussian components of the model.');
    h.Fit_Gaussian_Pick = uicontrol('Style','checkbox',...
        'Units','normalized',...
        'Callback',@UpdateOptions,...
        'Value',UserValues.BurstBrowser.Settings.FitGaussPick,...
        'Position',[0.6,0.9,0.4,0.08],...
        'String','Pick start points manually',...
        'Parent',h.FitGaussian_Panel,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'FontSize',12,...
        'TooltipString','If selected, you are required to manually select the start point for the fit by clicking inside the 2D plot.');
    h.Fit_Gaussian_Use_Weights = uicontrol('Style','checkbox',...
        'Units','normalized',...
        'Callback',@UpdateOptions,...
        'Value',UserValues.BurstBrowser.Settings.FitGaussPick,...
        'Position',[0.6,0.8,0.4,0.08],...
        'String','Use weights',...
        'Parent',h.FitGaussian_Panel,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'FontSize',12,...
        'TooltipString','<html>If selected, the least-squares fits uses weights.<br>Weights are estimated based on Poissonian counting, i.e. sqrt(N).');
    switch UserValues.BurstBrowser.Settings.GaussianFitMethod
        case 'MLE'
            h.Fit_Gaussian_Use_Weights.Visible = 'off';
        case 'LSQ'
            h.Fit_Gaussian_Use_Weights.Visible = 'on';
    end
    h.Fit_GaussianMethod_Popupmenu = uicontrol('Style','popup',...
        'Units','normalized',...
        'Callback',@UpdateOptions,...
        'Position',[0.4,0.8,0.2,0.08],...
        'String',{'MLE','LSQ'},...
        'Value',find(strcmp({'MLE','LSQ'},UserValues.BurstBrowser.Settings.GaussianFitMethod)),...
        'Parent',h.FitGaussian_Panel,...
        'FontSize',12,...
        'TooltipStr','Fit Method. LSQ allows fixing of parameters.'); 
    h.Fit_GaussianChi2_Text = uicontrol('Style','text',...
        'Units','normalized',...
        'Callback',@UpdateOptions,...
        'Position',[0.1,0.8,0.3,0.08],...
        'String','',...
        'HorizontalAlignment','center',...
        'Parent',h.FitGaussian_Panel,...
        'FontSize',12,...
        'BackgroundColor',Look.Back,...
        'ForegroundColor',Look.Fore,...
        'TooltipStr','red. Chi2 value');
    h.FitTable_ContextMenu = uicontextmenu;
    h.FitTable_SpeciesFromGaussFit = uimenu(h.FitTable_ContextMenu,'Label','Copy fit result to clipboard','Callback',@CopyFitresultToClipboard);
    h.FitTable_SpeciesFromGaussFit = uimenu(h.FitTable_ContextMenu,'Label','Define Species from Fit','Callback',@SpeciesFromGaussianFit,'Separator','on');
    h.GUIData.TableDataMLE = cell(8,6);
    h.GUIData.TableDataMLE(3,1:6) = {'<html><b>Fraction</b></html>','<html><b>Mean(X)</b></html>','<html><b>Mean(Y)</b></html>','<html><b>&sigma(XX)</b></html>','<html><b>&sigma(YY)</b></html>','<html><b>COV(XY)</b></html>'};
    h.GUIData.ColumnNameMLE = {'<html><b>Converged</b></html>','<html><b>-logL</b></html>','<html><b>BIC</b></html>'};
    h.GUIData.ColumnEditableMLE = false(1,6);
    h.GUIData.ColumnWidthMLE = {100,100,100,100,100,100,100};
    h.GUIData.ColumnFormatMLE = repmat({'numeric'},1,7);
    h.GUIData.TableDataLSQ = num2cell(repmat([1,0,1,false,0.5,0,Inf,false,0.5,0,Inf,false,0.05,0.01,Inf,false,0.05,0.01,Inf,false,0,-Inf,Inf,false],[5,1]));
    for i =1:5
        h.GUIData.TableDataLSQ(i,4:4:end) = {false,false,false,false,false,false};
    end
    h.GUIData.ColumnEditableLSQ = true(1,24);
    h.GUIData.ColumnNameLSQ = {'<html><b>Fraction</b></html>','LB','UB','F','<html><b>Mean(X)</b></html>','LB','UB','F','<html><b>Mean(Y)</b></html>','LB','UB','F','<html><b>&sigma(XX)</b></html>','LB','UB','F','<html><b>&sigma(YY)</b></html>','LB','UB','F','<html><b>COV(XY)</b></html>','LB','UB','F'};
    h.GUIData.ColumnWidthLSQ = repmat({60,25,25,20},[1,6]);
    h.GUIData.ColumnFormatLSQ = repmat({'numeric','numeric','numeric','logical'},[1,6]);
    switch UserValues.BurstBrowser.Settings.GaussianFitMethod
        case 'MLE'
            h.Fit_Gaussian_Text = uitable(...
                'Units','normalized',...
                'Position',[0,0,1,0.75],...
                'Parent',h.FitGaussian_Panel,...
                'FontSize',12,...
                'ColumnName',h.GUIData.ColumnNameMLE,...
                'RowName',[],...
                'ColumnEditable',h.GUIData.ColumnEditableMLE,...
                'Data',h.GUIData.TableDataMLE,...
                'ColumnWidth',h.GUIData.ColumnWidthMLE,...
                'ColumnFormat',h.GUIData.ColumnFormatMLE,...
                'UIContextMenu',h.FitTable_ContextMenu,...
                'TooltipString','<html>Result of the Gaussian mixture fit.<br>If "converged" is zero, the fit did not converge. <br>-logL: negative log-likelihood. <br>BIC: Bayesian information criterion. The model with the lowest value is preferred.<br>Distribution widths are given as &sigma=sqrt(&sigma<sup>2</sup>), while the covariance COV(XY) is given as actual variance.</html>');
        case 'LSQ'
            h.Fit_Gaussian_Text = uitable(...
                'Units','normalized',...
                'Position',[0,0,1,0.75],...
                'Parent',h.FitGaussian_Panel,...
                'FontSize',12,...
                'ColumnName',h.GUIData.ColumnNameLSQ,...
                'ColumnFormat',h.GUIData.ColumnFormatLSQ,...
                'RowName',[],...
                'ColumnEditable',h.GUIData.ColumnEditableLSQ,...
                'Data',h.GUIData.TableDataLSQ,...
                'ColumnWidth',h.GUIData.ColumnWidthLSQ,...
                'UIContextMenu',h.FitTable_ContextMenu,...
                'TooltipString','<html>Gaussian fit table</html>');
    end
    %% Secondary tab PDA/BVA comparison
    h.ConsistencyCheck = uipanel(...
        'Parent',h.Secondary_Tab_BVA,...
        'Units','normalized',...
        'Position',[0 0 1 0.5],...
        'Tag','ConsistencyCheck',...
        'BackgroundColor',Look.Back,...
        'ForegroundColor',Look.Fore,...
        'HighlightColor', Look.Fore,...
        'Title','Consistency Check',...
        'FontSize',12);
    
    h.KineticTable_text = uicontrol(...
        'Parent',h.ConsistencyCheck,...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.05 0.9 0.25 0.07],...
        'Style','text',...
        'Tag','KineticTable_text',...
        'String','Kinetic Table',...
        'HorizontalAlignment','left',...
        'TooltipString','Kinetic table used for simulating BVA data',...
        'FontSize',12);
    
    h.PDA_BVA_Button = uicontrol(...
        'Style','pushbutton',...
        'Parent',h.ConsistencyCheck,...
        'Units','normalized',...
        'Position',[0.05 0.05 0.33 0.08],...
        'Tag','PDA/BVA_Button',...
        'String','PDA/BVA Comparison',...
        'ForegroundColor',Look.Fore,...
        'BackgroundColor',Look.Control,...
        'Callback',@PDA_BVA_Comparison,...
        'FontSize',12,...
        'Enable','on');
    
   h.PDA_Etau_Button = uicontrol(...
        'Style','pushbutton',...
        'Parent',h.ConsistencyCheck,...
        'Units','normalized',...
        'Position',[0.35 0.05 0.33 0.08],...
        'Tag','PDA/Etau_Button',...
        'String','PDA/Lifetime Comparison',...
        'ForegroundColor',Look.Fore,...
        'BackgroundColor',Look.Control,...
        'Callback',@PDA_E_tau_comparison,...
        'FontSize',12,...
        'Enable','on');
%     
%     h.k12_edit = uicontrol(...
%         'Parent',h.ConsistencyCheck,...
%         'Units','normalized',...
%         'BackgroundColor', Look.Control,...
%         'ForegroundColor', Look.Fore,...
%         'Position',[0.75 0.92 0.2 0.07],...
%         'Style','edit',...
%         'Tag','k_12',...
%         'String',num2str(0.15),...
%         'TooltipString','Transition rate from state 1 to state 2',...
%         'FontSize',12,...
%         'Callback',@UpdateCorrections);

    initial_rates = ones(3);
    initial_rates(1,1) = NaN;
    initial_rates(2,2) = NaN;
    initial_rates(3,3) = NaN;
    data = cell(size(initial_rates));
    for i = 1:size(initial_rates,2)
        data(:,i) = num2cell(initial_rates(:,i));
    end
    columnwidth={50};
    %positionwidth=cell2num(columnwidth)/150;
    
    h.KineticRates_table = uitable(...
        'Parent',h.ConsistencyCheck,...
        'Data',data,...
        'RowName', {'1','2','3'},...
        'ColumnName',{'1->','2->','3->'},...
        'ColumnWidth',columnwidth,...
        'ColumnFormat',{'numeric'},...
        'ColumnEditable',true,...
        'Parent',h.Secondary_Tab_BVA,...
        'Tag','KineticRates_table',...
        'Units','normalized',...
        'ForegroundColor',Look.TableFore,...
        'BackgroundColor',[Look.Table1;Look.Table2],...
        'FontSize',12,...
        'Visible','on',...
        'CellEditCallback',@UpdateBVATab);
        %'Position',[0.05 0.26 0.45 0.155],...
        h.KineticRates_table.Position = [0.05 0.25 h.KineticRates_table.Extent(3)*1.32 h.KineticRates_table.Extent(4)*1.8];
    h.state1_text = uicontrol(...
        'Parent',h.ConsistencyCheck,...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.6 0.9 0.25 0.07],...
        'Style','text',...
        'Tag','state1_text',...
        'String','State 1',...
        'HorizontalAlignment','left',...
        'FontSize',12);
    
    h.Rstate1_text = uicontrol(...
        'Parent',h.ConsistencyCheck,...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.65 0.82 0.25 0.07],...
        'Style','text',...
        'Tag','state1_text',...
        'String',['R [',char(197),']'],...
        'HorizontalAlignment','left',...
        'TooltipString',['Distance of state 1 [',char(197),']'],...
        'FontSize',12);
    
    h.Rstate1_edit = uicontrol(...
        'Parent',h.ConsistencyCheck,...
        'Units','normalized',...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.77 0.82 0.1 0.07],...
        'Style','edit',...
        'Tag','Rstate1_edit',...
        'String','',...
        'HorizontalAlignment','left',...
        'FontSize',12);
    
    h.Rsigma1_text = uicontrol(...
        'Parent',h.ConsistencyCheck,...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.65 0.75 0.25 0.07],...
        'Style','text',...
        'Tag','Rsigma1_text',...
        'String','R sigma',...
        'HorizontalAlignment','left',...
        'TooltipString','Standard deviation of R in state 1',...
        'FontSize',12);
    
    h.Rsigma1_edit = uicontrol(...
        'Parent',h.ConsistencyCheck,...
        'Units','normalized',...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.77 0.75 0.1 0.07],...
        'Style','edit',...
        'Tag','Rsigma1_edit',...
        'String','0.1',...
        'HorizontalAlignment','left',...
        'FontSize',12);
    
    h.state2_text = uicontrol(...
        'Parent',h.ConsistencyCheck,...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.6 0.65 0.25 0.07],...
        'Style','text',...
        'Tag','state2_text',...
        'String','State 2',...
        'HorizontalAlignment','left',...
        'FontSize',12);
    
    h.Rstate2_text = uicontrol(...
        'Parent',h.ConsistencyCheck,...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.65 0.57 0.25 0.07],...
        'Style','text',...
        'Tag','Rstate1_text',...
        'String',['R [',char(197),']'],...
        'HorizontalAlignment','left',...
        'TooltipString',['Distance in state 2 [',char(197),']'],...
        'FontSize',12);
    
    h.Rstate2_edit = uicontrol(...
        'Parent',h.ConsistencyCheck,...
        'Units','normalized',...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.77 0.57 0.1 0.07],...
        'Style','edit',...
        'Tag','Rstate2_edit',...
        'String','',...
        'HorizontalAlignment','left',...
        'FontSize',12);
   
    
    h.Rsigma2_text = uicontrol(...
        'Parent',h.ConsistencyCheck,...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.65 0.50 0.25 0.07],...
        'Style','text',...
        'Tag','Rsigma1_text',...
        'String','R sigma',...
        'HorizontalAlignment','left',...
        'TooltipString','Standard deviation of R in state 2',...
        'FontSize',12);
    
    h.Rsigma2_edit = uicontrol(...
        'Parent',h.ConsistencyCheck,...
        'Units','normalized',...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.77 0.50 0.1 0.07],...
        'Style','edit',...
        'Tag','Rsigma1_edit',...
        'String','0.1',...
        'HorizontalAlignment','left',...
        'FontSize',12);
    
    h.state3_text = uicontrol(...
        'Parent',h.ConsistencyCheck,...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.6 0.40 0.25 0.07],...
        'Style','text',...
        'Tag','state3_text',...
        'String','State 3',...
        'HorizontalAlignment','left',...
        'FontSize',12);
    
    h.Rstate3_text = uicontrol(...
        'Parent',h.ConsistencyCheck,...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.65 0.32 0.25 0.07],...
        'Style','text',...
        'Tag','Rstate1_text',...
        'String',['R [',char(197),']'],...
        'HorizontalAlignment','left',...
        'TooltipString',['Distance in state 3 [',char(197),']'],...
        'FontSize',12);
    
    h.Rstate3_edit = uicontrol(...
        'Parent',h.ConsistencyCheck,...
        'Units','normalized',...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.77 0.32 0.1 0.07],...
        'Style','edit',...
        'Tag','Rstate2_edit',...
        'String','',...
        'HorizontalAlignment','left',...
        'FontSize',12);
   
    
    h.Rsigma3_text = uicontrol(...
        'Parent',h.ConsistencyCheck,...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.65 0.25 0.25 0.07],...
        'Style','text',...
        'Tag','Rsigma1_text',...
        'String','R sigma',...
        'HorizontalAlignment','left',...
        'TooltipString','Standard deviation of R in state 3',...
        'FontSize',12);
    
    h.Rsigma3_edit = uicontrol(...
        'Parent',h.ConsistencyCheck,...
        'Units','normalized',...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.77 0.25 0.1 0.07],...
        'Style','edit',...
        'Tag','Rsigma1_edit',...
        'String','0.1',...
        'HorizontalAlignment','left',...
        'FontSize',12);
    
    %% Secondary tab options
    s.ProgressRatio = 0.75;
    %%% Display Options Panel
    h.DisplayOptionsPanel = uipanel(...
        'Parent',h.SecondaryTabOptionsPanel,...
        'Units','normalized',...
        'Position',[0 0.5 1 0.5],...
        'Tag','DisplayOptionsPanel',...
        'BackgroundColor',Look.Back,...
        'ForegroundColor',Look.Fore,...
        'HighlightColor', Look.Fore,...
        'Title','Display Options',...
        'FontSize',12);
    
    %%% Specify the Number of Bins
    h.NbinsXText = uicontrol('Style','text',...
        'Parent',h.DisplayOptionsPanel,...
        'String','Number of Bins X',...
        'Tag','Text_Number_of_BinsX',...
        'Units','normalized',...
        'Position',[0 0.92 0.25 0.07],...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore);
    
    h.NumberOfBinsXEdit = uicontrol(...
        'Style','edit',...
        'Parent',h.DisplayOptionsPanel,...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Units','normalized',...
        'Position',[0.3 0.92 0.2 0.07],...
        'FontSize',12,...
        'Tag','NumberOfBinsEdit',...
        'String',UserValues.BurstBrowser.Display.NumberOfBinsX,...
        'Callback',@UpdatePlot...
        );
    %%% log X option
    h.logX_checkbox = uicontrol(...
        'Style','checkbox',...
        'Parent',h.DisplayOptionsPanel,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Units','normalized',...
        'Position',[0.5 0.92 0.2 0.07],...
        'FontSize',12,...
        'Tag','logX_checkbox',...
        'Value',UserValues.BurstBrowser.Display.logX,...
        'String','logX',...
        'TooltipStr','Logarithmic X-axis',...
        'Callback',@UpdatePlot...
        );
    h.NBinsYText = uicontrol('Style','text',...
        'Parent',h.DisplayOptionsPanel,...
        'String','Number of Bins Y',...
        'Tag','Text_Number_of_BinsY',...
        'Units','normalized',...
        'Position',[0 0.85 0.25 0.07],...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore);
    
    h.NumberOfBinsYEdit = uicontrol(...
        'Style','edit',...
        'Parent',h.DisplayOptionsPanel,...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Units','normalized',...
        'Position',[0.3 0.85 0.2 0.07],...
        'FontSize',12,...
        'Tag','NumberOfBinsEdit',...
        'String',UserValues.BurstBrowser.Display.NumberOfBinsY,...
        'Callback',@UpdatePlot...
        );
    %%% log Y option
    h.logY_checkbox = uicontrol(...
        'Style','checkbox',...
        'Parent',h.DisplayOptionsPanel,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Units','normalized',...
        'Position',[0.5 0.85 0.2 0.07],...
        'FontSize',12,...
        'Tag','logY_checkbox',...
        'Value',UserValues.BurstBrowser.Display.logY,...
        'String','logY',...
        'TooltipStr','Logarithmic Y-axis',...
        'Callback',@UpdatePlot...
        );
    %%% Plot grid lines above data
    h.PlotGridAboveDataCheckbox = uicontrol(...
        'Style','checkbox',...
        'Parent',h.DisplayOptionsPanel,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Units','normalized',...
        'Position',[0.7 0.92 0.3 0.07],...
        'FontSize',12,...
        'Tag','PlotGridAboveDataCheckbox',...
        'Value',UserValues.BurstBrowser.Display.PlotGridAboveData,...
        'String','Plot grid on top of data',...
        'TooltipStr','Choose to overlay grid lines on data, or to plot grid lines behind data.',...
        'Callback',@UpdateGUIOptions...
        );
    %%% Plot grid lines above data
    h.Restrict_EandS_Range = uicontrol(...
        'Style','checkbox',...
        'Parent',h.DisplayOptionsPanel,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Units','normalized',...
        'Position',[0.7 0.85 0.3 0.07],...
        'FontSize',12,...
        'Tag','Restrict_EandS_Range',...
        'Value',UserValues.BurstBrowser.Display.Restrict_EandS_Range,...
        'String','Restrict E and S range',...
        'TooltipStr','Restrict Efficiency and Stoichiometry plot ranges to [-0.1,1.1].',...
        'Callback',@UpdatePlot...
        );
    
    %%% Specify the Plot Type
    h.PlotTypeText = uicontrol('Style','text',...
        'Parent',h.DisplayOptionsPanel,...
        'String','Plot Type',...
        'Tag','Text_Plot_Type',...
        'Units','normalized',...
        'Position',[0 0.75 0.2 0.07],...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'HorizontalAlignment','left');
    
    PlotType_String = {'Image','Contour','Scatter','Hex'};
    h.PlotTypePopumenu = uicontrol(...
        'Style','popupmenu',...
        'Parent',h.DisplayOptionsPanel,...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Units','normalized',...
        'Position',[0.2 0.75 0.3 0.07],...
        'FontSize',12,...
        'Tag','PlotTypePopupmenu',...
        'String',PlotType_String,...
        'Value',find(strcmp(PlotType_String,UserValues.BurstBrowser.Display.PlotType)),...
        'Callback',@ChangePlotType...
        );
    %%% Contour plot settings
    h.NumberOfContourLevels_text = uicontrol(...
        'Style','text',...
        'Parent',h.DisplayOptionsPanel,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Units','normalized',...
        'Position',[0.62 0.78 0.28 0.06],...
        'FontSize',12,...
        'Tag','NumberOfContourLevels_edit',...
        'String','# Contour Levels'...
        );
    
    h.NumberOfContourLevels_edit = uicontrol(...
        'Style','edit',...
        'Parent',h.DisplayOptionsPanel,...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Units','normalized',...
        'Position',[0.9 0.775 0.1 0.06],...
        'FontSize',12,...
        'Tag','NumberOfContourLevels_edit',...
        'String',num2str(UserValues.BurstBrowser.Display.NumberOfContourLevels),...
        'Callback',@UpdatePlot...
        );
    
    h.PlotOffset_text = uicontrol(...
        'Style','text',...
        'Parent',h.DisplayOptionsPanel,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Units','normalized',...
        'Position',[0.62 0.72 0.28 0.06],...
        'FontSize',12,...
        'Tag','ContourOffset_text',...
        'String','Plot Offset [%]'...
        );
    
    h.PlotOffset_edit = uicontrol(...
        'Style','edit',...
        'Parent',h.DisplayOptionsPanel,...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Units','normalized',...
        'Position',[0.9 0.715 0.1 0.06],...
        'FontSize',12,...
        'Tag','NumberOfContourLevels_edit',...
        'String',num2str(UserValues.BurstBrowser.Display.ContourOffset),...
        'Callback',@UpdatePlot...
        );
    %%% maximum cutoff (applies to image and contour plots)
    h.PlotCutoff_text = uicontrol(...
        'Style','text',...
        'Parent',h.DisplayOptionsPanel,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Units','normalized',...
        'Position',[0.62 0.66 0.28 0.06],...
        'FontSize',12,...
        'Tag','PlotCutoff_text',...
        'String','Plot Cutoff [%]'...        
        );
    
    h.PlotCutoff_edit = uicontrol(...
        'Style','edit',...
        'Parent',h.DisplayOptionsPanel,...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Units','normalized',...
        'Position',[0.9 0.655 0.1 0.06],...
        'FontSize',12,...
        'Tag','PlotCutoff_edit',...
        'String',num2str(UserValues.BurstBrowser.Display.PlotCutoff),...
        'Callback',@UpdatePlot...
        );
    %%% Toggle fill of contour plot
    h.ContourFill = uicontrol(...
        'Style','checkbox',...
        'Parent',h.DisplayOptionsPanel,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Units','normalized',...
        'Position',[0.5 0.74 0.15 0.07],...
        'FontSize',12,...
        'Tag','ContourFill',...
        'String','Fill',...
        'TooltipString','Toggle fill of contour plot.',...
        'Value',UserValues.BurstBrowser.Display.ContourFill,...
        'Callback',@UpdatePlot...
        );
    %%% scatter plot settings
    h.MarkerColor_text = uicontrol(...
        'Style','text',...
        'Parent',h.DisplayOptionsPanel,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Units','normalized',...
        'Position',[0.62 0.75 0.28 0.07],...
        'FontSize',12,...
        'Tag','MarkerColor_text',...
        'String','Marker Color'...
        );
    h.MarkerColor_button = uicontrol('Style','pushbutton',...
        'Parent',h.DisplayOptionsPanel,...
        'String','',...
        'Tag','MarkerColor_button',...
        'Units','normalized',...
        'Position',[0.9 0.75 0.1 0.07],...
        'FontSize',12,...
        'BackgroundColor', UserValues.BurstBrowser.Display.MarkerColor,...
        'ForegroundColor', Look.Fore,...
        'Callback',@UpdateLineColor...
        );
    
    h.MarkerSize_text = uicontrol(...
        'Style','text',...
        'Parent',h.DisplayOptionsPanel,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Units','normalized',...
        'Position',[0.62 0.65 0.28 0.07],...
        'FontSize',12,...
        'Tag','MarkerSize_text',...
        'String','Marker Size'...
        );
    
    h.MarkerSize_edit = uicontrol(...
        'Style','edit',...
        'Parent',h.DisplayOptionsPanel,...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Units','normalized',...
        'Position',[0.9 0.65 0.1 0.07],...
        'FontSize',12,...
        'Tag','NumberOfContourLevels_edit',...
        'String',num2str(UserValues.BurstBrowser.Display.MarkerSize),...
        'Callback',@UpdateGUIOptions...
        );
    %%% Specify the colormap
    h.ColormapText = uicontrol('Style','text',...
        'Parent',h.DisplayOptionsPanel,...
        'String','Colormap',...
        'Tag','Text_ColorMap',...
        'Units','normalized',...
        'Position',[0 0.65 0.2 0.07],...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'HorizontalAlignment','left');
    
    Colormaps_String = {'jet','parula','hot','inferno','magma','plasma','viridis','cool','spring','summer','autumn','winter','bone','gray','copper','pink','hsv'};
    if ischar(UserValues.BurstBrowser.Display.ColorMap)
        try
            colormap_val = find(strcmp(Colormaps_String,UserValues.BurstBrowser.Display.ColorMap));
        catch
            colormap_val = 1;
            UserValues.BurstBrowser.Display.ColorMap = Colormaps_String(1);
        end
    else
        colormap_val = 2;
    end
    h.ColorMapPopupmenu = uicontrol(...
        'Style','popupmenu',...
        'Parent',h.DisplayOptionsPanel,...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Units','normalized',...
        'Position',[0.2 0.65 0.3 0.07],...
        'FontSize',12,...
        'Tag','ColorMapPopupmenu',...
        'String',Colormaps_String,...
        'Value',colormap_val,...
        'Callback',@UpdatePlot...
        );
    
    h.ColorMapInvert = uicontrol(...
        'Style','checkbox',...
        'Parent',h.DisplayOptionsPanel,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Units','normalized',...
        'Position',[0.5 0.68 0.15 0.07],...
        'FontSize',12,...
        'Tag','ColorMapInvert',...
        'String','Invert',...
        'TooltipString','Invert colormap.',...
        'Value',UserValues.BurstBrowser.Display.ColorMapInvert,...
        'Callback',@UpdatePlot...
        );
    h.ColorMapFromWhite = uicontrol(...
        'Style','checkbox',...
        'Parent',h.DisplayOptionsPanel,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Units','normalized',...
        'Position',[0.5 0.62 0.15 0.07],...
        'FontSize',12,...
        'Tag','ColorMapFromWhite',...
        'String','from white',...
        'TooltipString','Start colormap from white.',...
        'Value',UserValues.BurstBrowser.Display.ColorMapFromWhite,...
        'Callback',@UpdatePlot...
        );
    
    h.PlotContourLines = uicontrol('Style','checkbox',...
        'Parent',h.DisplayOptionsPanel,...
        'String','Plot Contour Lines',...
        'Tag','PlotContourLines',...
        'Value', UserValues.BurstBrowser.Display.PlotContourLines,...
        'Units','normalized',...
        'Position',[0.52 0.55 0.48 0.07],...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Callback',@ChangePlotType...
        );
    %%% Option to take log10 of 2D histogram
    h.Hist_log10 = uicontrol('Style','checkbox',...
        'Parent',h.DisplayOptionsPanel,...
        'String','take log10 of 2D histogram',...
        'Tag','Hist_log10',...
        'Value', 0,...
        'Units','normalized',...
        'Position',[0.02 0.55 0.4 0.07],...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Callback',@UpdateOptions...
        );
    %%% Option to display average values in 1d histograms
    h.DisplayAverage = uicontrol('Style','checkbox',...
        'Parent',h.DisplayOptionsPanel,...
        'String','Display Average Value in 1D Histograms',...
        'Tag','DisplayAverage',...
        'Value', 0,...
        'Units','normalized',...
        'Position',[0.02 0.45 0.5 0.07],...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Callback',@UpdatePlot...
        );
    
    %%% Option to turn KDE estimate (data smoothing) on or off
    h.SmoothKDE = uicontrol('Style','checkbox',...
        'Parent',h.DisplayOptionsPanel,...
        'String','Plot Kernel Density Estimate (Smoothing)',...
        'Tag','SmoothKDE',...
        'Value', UserValues.BurstBrowser.Display.KDE,...
        'Units','normalized',...
        'Position',[0.02 0.35 0.48 0.07],...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Callback',@UpdatePlot...
        );
    
    h.SaveFileExportFigure_Checkbox = uicontrol('Style','checkbox',...
        'Parent',h.DisplayOptionsPanel,...
        'String','Save file when exporting figure',...
        'TooltipString','Save file when exporting figure',...
        'Tag','SaveFileExportFigure_Checkbox',...
        'Value', UserValues.BurstBrowser.Settings.SaveFileExportFigure,...
        'Units','normalized',...
        'Position',[0.02 0.25 0.48 0.07],...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Callback',@UpdateOptions...
        );
    
    %%% Option to  color-code a third parameter in 2d histograms using
    %%% colormap, while frequency is encoded in grayscale
    h.ZScale_Intensity = uicontrol('Style','checkbox',...
        'Parent',h.DisplayOptionsPanel,...
        'String','Grayscale Intensity for ZScale',...
        'TooltipString','<html>Enable grayscale colormap for encoding frequency when using Z-Scale parameter to define colormap.<br>Affected by colormap brightening.</html>',...
        'Tag','ZScale_Intensity',...
        'Value', UserValues.BurstBrowser.Display.ZScale_Intensity,...
        'Units','normalized',...
        'Position',[0.52 0.45 0.48 0.07],...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Callback',@UpdatePlot...
        );
    %%% Option to brighten the grayscale colormap used for encoding
    %%% frequency information
    h.BrightenColorMap_text = uicontrol(...
        'Style','text',...
        'Parent',h.DisplayOptionsPanel,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Units','normalized',...
        'TooltipString','Brightens the colormap. Affects z-scaling and multiplot.',...
        'Position',[0.52 0.35 0.36 0.07],...
        'FontSize',12,...
        'Tag','BrightenColorMap_text',...
        'String','Brighten Colormap'...
        );
    
    h.BrightenColorMap_edit = uicontrol(...
        'Style','edit',...
        'Parent',h.DisplayOptionsPanel,...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Units','normalized',...
        'Position',[0.88 0.35 0.1 0.07],...
        'FontSize',12,...
        'Tag','BrightenColorMap_edit',...
        'TooltipString','Brightens the colormap. Affects z-scaling and multiplot.',...
        'String',num2str(UserValues.BurstBrowser.Display.BrightenColorMap),...
        'Callback',@UpdatePlot...
        );
    %if ~UserValues.BurstBrowser.Display.ZScale_Intensity
    %    set([h.BrightenColorMap_text,h.BrightenColorMap_edit],'Visible','off');
    %end
    
    h.MultiPlot_PlotType = uicontrol('Style','checkbox',...
        'Parent',h.DisplayOptionsPanel,...
        'String','Use black-to-white for multi plot',...
        'TooltipString','<html>Uses black-to-white color scaling for plotting multiple species,<br> instead of white-to-black RGB plot mode. <br> Affected by colormap brightening.</html>',...
        'Tag','SaveFileExportFigure_Checkbox',...
        'Value', UserValues.BurstBrowser.Display.MultiPlotMode,...
        'Units','normalized',...
        'Position',[0.52 0.25 0.48 0.07],...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Callback',@UpdateOptions...
        );
    
    h.ColorSettingContainer = uigridcontainer(h.DisplayOptionsPanel,...
        'GridSize',[2,6],...
        'Units','norm',...
        'Position',[0.02,0,0.96,.17],...
        'BackgroundColor',Look.Back);
    
    h.ColorLine1Text = uicontrol('Style','text',...
        'Parent',h.ColorSettingContainer,...
        'String','Line 1',...
        'Tag','ColorLine1Text',...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore);
    
    h.ColorLine2Text = uicontrol('Style','text',...
        'Parent',h.ColorSettingContainer,...
        'String','Line 2',...
        'Tag','ColorLine2Text',...
        'Units','normalized',...
        'Position',[0.21 0.1 0.12 0.07],...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore);
    
    h.ColorLine3Text = uicontrol('Style','text',...
        'Parent',h.ColorSettingContainer,...
        'String','Line 3',...
        'Tag','ColorLine3Text',...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore);
    
    h.ColorLine4Text = uicontrol('Style','text',...
        'Parent',h.ColorSettingContainer,...
        'String','Line 4',...
        'Tag','ColorLine4Text',...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore);
    
    h.ColorLine5Text = uicontrol('Style','text',...
        'Parent',h.ColorSettingContainer,...
        'String','Line 5',...
        'Tag','ColorLine5Text',...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore);

    h.ColorLine6Text = uicontrol('Style','text',...
        'Parent',h.ColorSettingContainer,...
        'String','Line 6',...
        'Tag','ColorLine6Text',...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore);
    
    h.ColorLine1 = uicontrol('Style','pushbutton',...
        'Parent',h.ColorSettingContainer,...
        'String','',...
        'Tag','ColorLine1',...
        'FontSize',12,...
        'BackgroundColor', UserValues.BurstBrowser.Display.ColorLine1,...
        'ForegroundColor', Look.Fore,...
        'Callback',@UpdateLineColor...
        );
    
    h.ColorLine2 = uicontrol('Style','pushbutton',...
        'Parent',h.ColorSettingContainer,...
        'String','',...
        'Tag','ColorLine2',...
        'FontSize',12,...
        'BackgroundColor', UserValues.BurstBrowser.Display.ColorLine2,...
        'ForegroundColor', Look.Fore,...
        'Callback',@UpdateLineColor...
        );
    
    h.ColorLine3 = uicontrol('Style','pushbutton',...
        'Parent',h.ColorSettingContainer,...
        'String','',...
        'Tag','ColorLine3',...
        'FontSize',12,...
        'BackgroundColor', UserValues.BurstBrowser.Display.ColorLine3,...
        'ForegroundColor', Look.Fore,...
        'Callback',@UpdateLineColor...
        );
    
    h.ColorLine4 = uicontrol('Style','pushbutton',...
        'Parent',h.ColorSettingContainer,...
        'String','',...
        'Tag','ColorLine4',...
        'FontSize',12,...
        'BackgroundColor', UserValues.BurstBrowser.Display.ColorLine4,...
        'ForegroundColor', Look.Fore,...
        'Callback',@UpdateLineColor...
        );
    
    h.ColorLine5 = uicontrol('Style','pushbutton',...
        'Parent',h.ColorSettingContainer,...
        'String','',...
        'Tag','ColorLine5',...
        'FontSize',12,...
        'BackgroundColor', UserValues.BurstBrowser.Display.ColorLine5,...
        'ForegroundColor', Look.Fore,...
        'Callback',@UpdateLineColor...
        );
    
    h.ColorLine6 = uicontrol('Style','pushbutton',...
        'Parent',h.ColorSettingContainer,...
        'String','',...
        'Tag','ColorLine6',...
        'FontSize',12,...
        'BackgroundColor', UserValues.BurstBrowser.Display.ColorLine6,...
        'ForegroundColor', Look.Fore,...
        'Callback',@UpdateLineColor...
        );
    
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %%% Data Processing Options Panel
    h.DataProcessingPanel = uipanel(...
        'Parent',h.SecondaryTabOptionsPanel,...
        'Units','normalized',...
        'Position',[0 0 1 0.5],...
        'Tag','DataProcessingPanel',...
        'BackgroundColor',Look.Back,...
        'ForegroundColor',Look.Fore,...
        'Title','Data Processing Options',...
        'HighlightColor', Look.Fore,...
        'FontSize',12);
    
    %%% Option to enable/disable save dialog on closing
    h.SaveOnClose = uicontrol('Style','checkbox',...
        'Parent',h.DataProcessingPanel,...
        'String','Ask for saving when closing program',...
        'Tag','SaveOnClose',...
        'Value', UserValues.BurstBrowser.Settings.SaveOnClose,...
        'Units','normalized',...
        'Position',[0.1 0.88 0.8 0.07],...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Callback',@UpdateOptions...
        );
    
    h.TimeBinPDAText = uicontrol('Style','text',...
        'Parent',h.DataProcessingPanel,...
        'String','Timebin for PDA [ms]',...
        'Tag','TimeBinPDAText',...
        'Units','normalized',...
        'Position',[0.05 0.68 0.55 0.07],...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore);
    
    h.TimeBinPDAEdit = uicontrol(...
        'Style','edit',...
        'Parent',h.DataProcessingPanel,...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Units','normalized',...
        'Position',[0.6 0.68 0.2 0.07],...
        'FontSize',12,...
        'Tag','TimeBinPDAEdit',...
        'String',UserValues.BurstBrowser.Settings.PDATimeBin,...
        'Callback',@UpdateOptions,...
        'TooltipString', 'e.g. "1" or "0.2, 0.5, 0.75, 1"'...
        );
    
    h.ApplyCorrectionsOnLoad = uicontrol('Style','checkbox',...
        'Parent',h.DataProcessingPanel,...
        'String','Automatically apply default/stored corrections when loading a file',...
        'Tag','SaveOnClose',...
        'Value', UserValues.BurstBrowser.Settings.CorrectionOnLoad,...
        'Units','normalized',...
        'Position',[0.1 0.78 0.8 0.07],...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Callback',@UpdateOptions...
        );
    
    h.IsoLineGaussFit_Text = uicontrol('Style','text',...
        'Parent',h.DataProcessingPanel,...
        'String','Isoline height for Gaussian Fit Display',...
        'Tag','IsoLineGaussFit_Text',...
        'Units','normalized',...
        'Position',[0.05 0.58 0.55 0.07],...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore);
    
    h.IsoLineGaussFit_Edit = uicontrol(...
        'Style','edit',...
        'Parent',h.DataProcessingPanel,...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Units','normalized',...
        'Position',[0.6 0.58 0.2 0.07],...
        'FontSize',12,...
        'Tag','IsoLineGaussFit_Edit',...
        'String',num2str(UserValues.BurstBrowser.Settings.IsoLineGaussFit),...
        'Callback',@UpdateOptions...
        );
    
    h.CompareFRETHist_Waterfall = uicontrol('Style','checkbox',...
        'Parent',h.DataProcessingPanel,...
        'String','Make waterfall plot when comparing FRET histograms',...
        'Tag','CompareFRETHist_Waterfall',...
        'Value', UserValues.BurstBrowser.Settings.CompareFRETHist_Waterfall,...
        'Units','normalized',...
        'Position',[0.1 0.48 0.8 0.07],...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Callback',@UpdateOptions...
        );
    %%% Editboxes for S thresholds for species selection
    h.ThresholdsContainer = uigridcontainer(...
        'GridSize',[3,5],...
        'HorizontalWeight',[0.4,0.3,0.3,0.5,0.3],...
        'Parent',h.DataProcessingPanel,...
        'Units','norm',...
        'Position',[.02,.20,.7,.25],...
        'BackgroundColor',Look.Back);
    h.Threshold_Text = uicontrol('style','text',...
        'Parent',h.ThresholdsContainer,...
        'String','Thresholds:',...
        'Units','normalized',...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore);
    h.Threshold_MinText = uicontrol('style','text',...
        'Parent',h.ThresholdsContainer,...
        'String','Min',...
        'Units','normalized',...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore);
    h.Threshold_MaxText = uicontrol('style','text',...
        'Parent',h.ThresholdsContainer,...
        'String','Max',...
        'Units','normalized',...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore);
    h.Threshold_E1 = uicontrol('style','text',...
        'Parent',h.ThresholdsContainer,...
        'String','',...
        'Units','normalized',...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore);
    h.Threshold_E2 = uicontrol('style','text',...
        'Parent',h.ThresholdsContainer,...
        'String','',...
        'Units','normalized',...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore);
    h.Threshold_SDonlyText = uicontrol('style','text',...
        'Parent',h.ThresholdsContainer,...
        'String','S(D only)',...
        'Units','normalized',...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore);
    h.Threshold_S_Donly_Min_Edit = uicontrol('style','edit',...
        'Parent',h.ThresholdsContainer,...
        'String',num2str(UserValues.BurstBrowser.Settings.S_Donly_Min),...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Units','normalized',...
        'FontSize',12,...
        'Callback',@UpdateOptions);
    h.Threshold_S_Donly_Max_Edit = uicontrol('style','edit',...
        'Parent',h.ThresholdsContainer,...
        'String',num2str(UserValues.BurstBrowser.Settings.S_Donly_Max),...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Units','normalized',...
        'FontSize',12,...
        'Callback',@UpdateOptions);
    h.Threshold_EDonlyMaxText1 = uicontrol('style','text',...
        'Parent',h.ThresholdsContainer,...
        'String','',...
        'Units','normalized',...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore);
    h.Threshold_EDonlyMaxText2 = uicontrol('style','text',...
        'Parent',h.ThresholdsContainer,...
        'String','',...
        'Units','normalized',...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore);
    h.Threshold_SAonlyText = uicontrol('style','text',...
        'Parent',h.ThresholdsContainer,...
        'String','S(A only)',...
        'Units','normalized',...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore);
    h.Threshold_S_Aonly_Min_Edit = uicontrol('style','edit',...
        'Parent',h.ThresholdsContainer,...
        'String',num2str(UserValues.BurstBrowser.Settings.S_Aonly_Min),...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Units','normalized',...
        'FontSize',12,...
        'Callback',@UpdateOptions);
    h.Threshold_S_Aonly_Max_Edit = uicontrol('style','edit',...
        'Parent',h.ThresholdsContainer,...
        'String',num2str(UserValues.BurstBrowser.Settings.S_Aonly_Max),...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Units','normalized',...
        'FontSize',12,...
        'Callback',@UpdateOptions);
    h.Threshold_EAonlyMinText = uicontrol('style','text',...
        'Parent',h.ThresholdsContainer,...
        'String','EPR(A only) min',...
        'Units','normalized',...
        'TooltipStr','Minimum proximity ratio for Acceptor Only selection.',...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore);
    h.Threshold_E_Aonly_Min_Edit = uicontrol('style','edit',...
        'Parent',h.ThresholdsContainer,...
        'String',num2str(UserValues.BurstBrowser.Settings.E_Aonly_Min),...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Units','normalized',...
        'FontSize',12,...
        'Callback',@UpdateOptions);
    %% Database tab   
    %%% Database list
    h.DatabaseBB.List = uicontrol(...
        'Parent',h.DatabaseBB.Panel,...
        'Tag','DatabaseBB_List',...
        'Style','listbox',...
        'Units','normalized',...
        'FontSize',12,...
        'Max',2,...
        'String',UserValues.BurstBrowser.DatabaseString,...
        'BackgroundColor', Look.List,...
        'ForegroundColor', Look.ListFore,...
        'KeyPressFcn',{@Database,0},...
        'Callback',{@Database,0},...
        'Tooltipstring', ['<html>'...
                          'List of files in database <br>',...
                          '<i>"return"</i>: Loads selected files<br>',...
                          '<I>"delete"</i>: Removes selected files from list </b>'],...
        'Position',[0.01 0.51 0.98 0.38]);
    h.DatabaseBB.Load = uicontrol(...
        'Parent',h.DatabaseBB.Panel,...
        'Tag','DatabaseBB_Load_Button',...
        'Units','normalized',...
        'FontSize',12,...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'String','Load database',...
        'Callback',{@Database,3},...
        'Position',[0.05 0.95 0.25 0.035],...
        'Tooltipstring', 'Load database from file');
    %%% Button to add files to the database
    h.DatabaseBB.Save = uicontrol(...
        'Parent',h.DatabaseBB.Panel,...
        'Tag','DatabaseBB_Save_Button',...
        'Units','normalized',...
        'FontSize',12,...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'String','Save Database',...
        'Callback',{@Database,4},...
        'Position',[0.05 0.91 0.25 0.035],...
        'enable', 'on',...
        'Tooltipstring', 'Save database to a file');
    %%% Button to add files to the database from dialog
    h.DatabaseBB.AddFiles = uicontrol(...
        'Parent',h.DatabaseBB.Panel,...
        'Tag','DatabaseBB_Correlate_Button',...
        'Units','normalized',...
        'FontSize',12,...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'String','Add files to database',...
        'Callback',{@Database,1},...
        'Position',[0.35 0.95 0.3 0.035],...
        'enable', 'on',...
        'UserData',0,...
        'Tooltipstring', ''); 
    %%% Button to add all loaded files to the database
    h.DatabaseBB.AppendLoadedFiles = uicontrol(...
        'Parent',h.DatabaseBB.Panel,...
        'Tag','DatabaseBB_AppendLoadedFiles',...
        'Units','normalized',...
        'FontSize',12,...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'String','Append loaded files to database',...
        'Callback',{@Database,1},...
        'Position',[0.35 0.91 0.3 0.035],...
        'enable', 'off',...
        'UserData',0,...
        'Tooltipstring', '');  
    
    %%% Button to make database from selected folder
    h.DatabaseBB.DatabaseFromFolder = uicontrol(...
        'Parent',h.DatabaseBB.Panel,...
        'Tag','DatabaseBB_DatbaseFromFolder',...
        'Units','normalized',...
        'FontSize',12,...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'String','Create database from folder',...
        'Callback',{@Database,1},...
        'Position',[0.675 0.95 0.3 0.035],...
        'enable', 'on',...
        'UserData',0,...
        'Tooltipstring', '');  
    
     h.DatabaseBB.FileHistoryContainer = uibuttongroup(...
        'Parent',h.DatabaseBB.Panel,...
        'Tag','DatabaseBB_List',...
        'Units','normalized',...
        'FontSize',12,...
        'Title','File History',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.01 0.01 0.98 0.48]);
    h.DatabaseBB.FileHistory = FileHistory(h.DatabaseBB.FileHistoryContainer,'BurstBrowser',@(x) Load_Burst_Data_Callback([],[],x));
    %% Define axes in main_tab_general
    %%% Right-click menu for axes
    h.ExportGraph_Menu = uicontextmenu('Parent',h.BurstBrowser);
    
    h.Export1DX_Menu = uimenu(...
        'Parent',h.ExportGraph_Menu,...
        'Label','Export X 1D',...
        'Tag','Export1DX_Menu',...
        'Callback',@ExportGraphs);
    
    h.Export1DY_Menu = uimenu(...
        'Parent',h.ExportGraph_Menu,...
        'Label','Export Y 1D',...
        'Tag','Export1DY_Menu',...
        'Callback',@ExportGraphs);
    
    h.Export2D_Menu = uimenu(...
        'Parent',h.ExportGraph_Menu,...
        'Label','Export 2D',...
        'Tag','Export2D_Menu',...
        'Callback',@ExportGraphs);
    
    %define 2d axis
    h.axes_general =  axes(...
        'Parent',h.MainTabGeneralPanel,...
        'Units','normalized',...
        'Position',[0.07 0.06 0.71 0.73],...
        'Box','on',...
        'Tag','Axes_General',...
        'FontSize',12,...
        'View',[0 90],...
        'XColor',Look.Fore,...
        'YColor',Look.Fore,...
        'nextplot','add',...
        'LineWidth', Look.AxWidth,...
        'XGrid','on',...
        'YGrid','on',...
        'GridAlpha',0.5,...
        'Color',Look.Axes,...
        'UIContextMenu',h.ExportGraph_Menu);
    
    %display no. bursts
    h.text_nobursts = uicontrol(...
        'Style','text',...
        'Parent',h.MainTabGeneralPanel,...
        'Tag','Text_Burst',...
        'Units','normalized',...
        'FontSize',11,...
        'String','no bursts',...
        'HorizontalAlignment','left',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0 0.97 0.2 0.03]);
    
    %define 1d axes
    h.axes_1d_x =  axes(...
        'Parent',h.MainTabGeneralPanel,...
        'Units','normalized',...
        'Position',[0.07 0.79 0.71, 0.15],...
        'Box','on',...
        'Tag','Axes_1D_X',...
        'FontSize',12,...
        'XAxisLocation','top',...
        'nextplot','add',...
        'View',[0 90],...
        'LineWidth', Look.AxWidth,...
        'XColor',Look.Fore,...
        'YColor',Look.Fore,...
        'Color',Look.Axes,...
        'XGrid','on',...
        'YGrid','on',...
        'GridAlpha',0.5,...
        'UIContextMenu',h.ExportGraph_Menu);
    ylabel(h.axes_1d_x, 'counts','Color',Look.Fore);
    
    h.axes_1d_x_text =text(...
        'Parent',h.axes_1d_x,...
        'Tag','axes_1d_x_text',...
        'Units','normalized',...
        'FontSize',14,...
        'String','avg = ',...
        'Interpreter','none',...
        'HorizontalAlignment','left',...
        'BackgroundColor','none',...
        'Color', 'r',...
        'Position',[0.025 0.8],...
        'Visible','off');
    
    %%% Colorbar
    h.colorbar = colorbar(h.axes_general,'Location','north','Color',Look.Fore,'FontSize',12);
    h.colorbar.Position = [0.78,0.92,0.15,0.02];
    h.colorbar.Label.Color = Look.Fore;
    h.colorbar.Label.String = 'Occurrence';
    h.colorbar.Label.FontWeight = 'bold'; 
    h.colorbar.Label.Position(1) = 0.5;
    h.colorbar.Label.Position(2) = 2.5;
    h.colorbar.Label.Units = 'normalized';
    
    h.axes_1d_y =  axes(...
        'Parent',h.MainTabGeneralPanel,...
        'Units','normalized',...
        'Position',[0.78 0.06 0.15, 0.73],...
        'Tag','Main_Tab_General_Plot',...
        'Box','on',...
        'Tag','Axes_1D_Y',...
        'FontSize',12,...
        'XAxisLocation','top',...
        'nextplot','add',...
        'XColor',Look.Fore,...
        'YColor',Look.Fore,...
        'LineWidth', Look.AxWidth,...
        'View',[90 90],...
        'Color',Look.Axes,...
        'XGrid','on',...
        'YGrid','on',...
        'GridAlpha',0.5,...
        'XDir','reverse',...
        'UIContextMenu',h.ExportGraph_Menu);
    ylabel(h.axes_1d_y, 'counts','Color',Look.Fore);
    %     set(h.axes_1d_y.XLabel, 'String', '')
    %     p = get(h.axes_1d_y.XLabel, 'Pos');
    %     p(2) = p(2)*1.1;
    %     set(h.axes_1d_y.XLabel, 'Pos', p);
    
    h.axes_1d_y_text =text(...
        'Parent',h.axes_1d_y,...
        'Tag','axes_1d_y_text',...
        'Units','normalized',...
        'FontSize',14,...
        'String','avg = ',...
        'Interpreter','none',...
        'HorizontalAlignment','left',...
        'BackgroundColor','none',...
        'Color', 'r',...
        'Position',[0.1 0.95],...
        'Visible','off');
    %%% Axis for ZScale parameter, shows histogram of average values
    h.axes_ZScale =  axes(...
        'Parent',h.MainTabGeneralPanel,...
        'Units','normalized',...
        'Position',[0.78 0.79 0.15, 0.13],...
        'Tag','Main_Tab_General_Plot',...
        'Box','on',...
        'Tag','axes_ZScale',...
        'FontSize',12,...
        'LineWidth', Look.AxWidth,...
        'nextplot','add',...
        'XColor',Look.Fore,...
        'YColor',Look.Fore,...
        'XTick',[],...
        'YTick',[],...
        'XGrid','on',...
        'YGrid','on',...
        'GridAlpha',0.5,...
        'UIContextMenu',h.ExportGraph_Menu,...
        'Color',Look.Axes,...
        'Visible','off');
    ylabel(h.axes_ZScale, [],'Color',Look.Fore);
    xlabel(h.axes_ZScale, [],'Color',Look.Fore);
    
    linkaxes([h.axes_general,h.axes_1d_x],'x');
    addlistener(h.axes_general,'YLim','PostSet',@linkaxes_y);
    addlistener(h.axes_1d_y,'XLim','PostSet',@linkaxes_y);
    %% Define axes in Corrections tab
    % defined context menu for corrections tab
    h.Corrections_Menu = uicontextmenu;
    h.ExportCorrections_Menu = uimenu(...
        'Parent',h.Corrections_Menu,...
        'Label','Export Correction Plots',...
        'Tag','ExportCorrections_Menu',...
        'Callback',@ExportGraphs);
    h.MainTabCorrectionsPanel.UIContextMenu = h.Corrections_Menu;
    %% Corrections - 2ColorMFD
    h.Corrections.TwoCMFD.axes_crosstalk =  axes(...
        'Parent',h.MainTabCorrectionsPanel,...
        'Units','normalized',...
        'Position',[0.05 0.55 0.4 0.4],...
        'Tag','Main_Tab_Corrections_Plot_crosstalk',...
        'Box','on',...
        'FontSize',12,...
        'XColor',Look.Fore,...
        'YColor',Look.Fore,...
        'LineWidth', Look.AxWidth,...
        'nextplot','add',...
        'XGrid','on',...
        'YGrid','on',...
        'GridAlpha',0.5,...
        'View',[0 90],...
        'UIContextMenu', h.Corrections_Menu);
    xlabel(h.Corrections.TwoCMFD.axes_crosstalk,'Proximity Ratio','Color',UserValues.Look.Fore);
    ylabel(h.Corrections.TwoCMFD.axes_crosstalk,'#','Color',UserValues.Look.Fore);
    title(h.Corrections.TwoCMFD.axes_crosstalk,'Proximity Ratio of Donor only','Color',UserValues.Look.Fore);
    
    h.Corrections.TwoCMFD.axes_direct_excitation =  axes(...
        'Parent',h.MainTabCorrectionsPanel,...
        'Units','normalized',...
        'Position',[0.55 0.55 0.4 0.4],...
        'Tag','Main_Tab_Corrections_Plot_direct_excitation',...
        'Box','on',...
        'XColor',Look.Fore,...
        'YColor',Look.Fore,...
        'LineWidth', Look.AxWidth,...
        'FontSize',12,...
        'nextplot','add',...
                           'XGrid','on',...
        'YGrid','on',...
        'GridAlpha',0.5,...
        'View',[0 90],...
        'UIContextMenu', h.Corrections_Menu);
    xlabel(h.Corrections.TwoCMFD.axes_direct_excitation,'Stoichiometry (raw)','Color',UserValues.Look.Fore);
    ylabel(h.Corrections.TwoCMFD.axes_direct_excitation,'#','Color',UserValues.Look.Fore);
    title(h.Corrections.TwoCMFD.axes_direct_excitation,'Raw Stoichiometry of Acceptor only','Color',UserValues.Look.Fore);
    
    h.Corrections.TwoCMFD.axes_gamma=  axes(...
        'Parent',h.MainTabCorrectionsPanel,...
        'Units','normalized',...
        'Position',[0.05 0.05 0.4 0.4],...
        'Tag','Main_Tab_Corrections_Plot_gamma',...
        'Box','on',...
        'FontSize',12,...
        'XColor',Look.Fore,...
        'YColor',Look.Fore,...
        'LineWidth', Look.AxWidth,...
        'nextplot','add',...
                           'XGrid','on',...
        'YGrid','on',...
        'GridAlpha',0.5,...
        'View',[0 90],...
        'UIContextMenu', h.Corrections_Menu);
    xlabel(h.Corrections.TwoCMFD.axes_gamma,'FRET Efficiency','Color',UserValues.Look.Fore);
    ylabel(h.Corrections.TwoCMFD.axes_gamma,'Stoichiometry','Color',UserValues.Look.Fore);
    title(h.Corrections.TwoCMFD.axes_gamma,'1/Stoichiometry vs. FRET Efficiency for \gamma = 1','Color',UserValues.Look.Fore);
    
    h.Corrections.TwoCMFD.axes_gamma_lifetime =  axes(...
        'Parent',h.MainTabCorrectionsPanel,...
        'Units','normalized',...
        'Position',[0.55 0.05 0.4 0.4],...
        'Tag','Main_Tab_Corrections_Plot_gamma_lifetime',...
        'Box','on',...
        'FontSize',12,...
        'XColor',Look.Fore,...
        'YColor',Look.Fore,...
        'LineWidth', Look.AxWidth,...
        'nextplot','add',...
                           'XGrid','on',...
        'YGrid','on',...
        'GridAlpha',0.5,...
        'View',[0 90],...
        'UIContextMenu', h.Corrections_Menu);
    xlabel(h.Corrections.TwoCMFD.axes_gamma_lifetime,'Lifetime D [ns]','Color',UserValues.Look.Fore);
    ylabel(h.Corrections.TwoCMFD.axes_gamma_lifetime,'FRET Efficiency','Color',UserValues.Look.Fore);
    title(h.Corrections.TwoCMFD.axes_gamma_lifetime,'FRET Efficiency vs. Lifetime D','Color',UserValues.Look.Fore);

    %% Corrections - 3ColorMFD
    h.Corrections.ThreeCMFD.axes_crosstalk_BG =  axes(...
        'Parent',h.MainTabCorrectionsThreeCMFDPanel,...
        'Units','normalized',...
        'Position',[0.05 0.7 0.2 0.25],...
        'Tag','Main_Tab_Corrections_Plot_crosstalk',...
        'Box','on',...
        'XColor',Look.Fore,...
        'YColor',Look.Fore,...
        'LineWidth', Look.AxWidth,...
        'FontSize',12,...
        'nextplot','add',...
                           'XGrid','on',...
        'YGrid','on',...
        'GridAlpha',0.5,...
        'View',[0 90],...
        'UIContextMenu', h.Corrections_Menu);
    xlabel(h.Corrections.ThreeCMFD.axes_crosstalk_BG,'Proximity Ratio BG','Color',UserValues.Look.Fore);
    ylabel(h.Corrections.ThreeCMFD.axes_crosstalk_BG,'#','Color',UserValues.Look.Fore);
    title(h.Corrections.ThreeCMFD.axes_crosstalk_BG,'Blue dye only','Color',UserValues.Look.Fore);
    
    h.Corrections.ThreeCMFD.axes_crosstalk_BR =  axes(...
        'Parent',h.MainTabCorrectionsThreeCMFDPanel,...
        'Units','normalized',...
        'Position',[(0.25+0.1/3) 0.7 0.2 0.25],...
        'Tag','Main_Tab_Corrections_Plot_crosstalk',...
        'Box','on',...
        'XColor',Look.Fore,...
        'YColor',Look.Fore,...
        'FontSize',12,...
        'LineWidth', Look.AxWidth,...
        'nextplot','add',...
                           'XGrid','on',...
        'YGrid','on',...
        'GridAlpha',0.5,...
        'View',[0 90],...
        'UIContextMenu', h.Corrections_Menu);
    xlabel(h.Corrections.ThreeCMFD.axes_crosstalk_BR,'Proximity Ratio BR','Color',UserValues.Look.Fore);
    ylabel(h.Corrections.ThreeCMFD.axes_crosstalk_BR,'#','Color',UserValues.Look.Fore);
    title(h.Corrections.ThreeCMFD.axes_crosstalk_BR,'Blue dye only','Color',UserValues.Look.Fore);
    
    h.Corrections.ThreeCMFD.axes_direct_excitation_BG =  axes(...
        'Parent',h.MainTabCorrectionsThreeCMFDPanel,...
        'Units','normalized',...
        'Position',[(0.45+0.2/3) 0.7 0.2 0.25],...
        'Tag','Main_Tab_Corrections_Plot_direct_excitation',...
        'Box','on',...
        'XColor',Look.Fore,...
        'YColor',Look.Fore,...
        'LineWidth', Look.AxWidth,...
        'FontSize',12,...
        'nextplot','add',...
                           'XGrid','on',...
        'YGrid','on',...
        'GridAlpha',0.5,...
        'View',[0 90],...
        'UIContextMenu', h.Corrections_Menu);
    xlabel(h.Corrections.ThreeCMFD.axes_direct_excitation_BG,'Stoichiometry BG (raw)','Color',UserValues.Look.Fore);
    ylabel(h.Corrections.ThreeCMFD.axes_direct_excitation_BG,'#','Color',UserValues.Look.Fore);
    title(h.Corrections.ThreeCMFD.axes_direct_excitation_BG,'Green dye only','Color',UserValues.Look.Fore);
    
    h.Corrections.ThreeCMFD.axes_direct_excitation_BR =  axes(...
        'Parent',h.MainTabCorrectionsThreeCMFDPanel,...
        'Units','normalized',...
        'Position',[0.75 0.7 0.2 0.25],...
        'Tag','Main_Tab_Corrections_Plot_direct_excitation',...
        'Box','on',...
        'LineWidth', Look.AxWidth,...
        'XColor',Look.Fore,...
        'YColor',Look.Fore,...
        'FontSize',12,...
        'nextplot','add',...
                           'XGrid','on',...
        'YGrid','on',...
        'GridAlpha',0.5,...
        'View',[0 90],...
        'UIContextMenu', h.Corrections_Menu);
    xlabel(h.Corrections.ThreeCMFD.axes_direct_excitation_BR,'Stoichiometry BR (raw)','Color',UserValues.Look.Fore);
    ylabel(h.Corrections.ThreeCMFD.axes_direct_excitation_BR,'#','Color',UserValues.Look.Fore);
    title(h.Corrections.ThreeCMFD.axes_direct_excitation_BR,'Red dye only','Color',UserValues.Look.Fore);
    
    h.Corrections.ThreeCMFD.axes_gammaBG_threecolor=  axes(...
        'Parent',h.MainTabCorrectionsThreeCMFDPanel,...
        'Units','normalized',...
        'Position',[0.05 0.375 0.4 0.25],...
        'Tag','Main_Tab_Corrections_Plot_gammaBG_threecolor',...
        'Box','on',...
        'XColor',Look.Fore,...
        'YColor',Look.Fore,...
        'LineWidth', Look.AxWidth,...
        'FontSize',12,...
        'nextplot','add',...
                           'XGrid','on',...
        'YGrid','on',...
        'GridAlpha',0.5,...
        'View',[0 90],...
        'UIContextMenu', h.Corrections_Menu);
    xlabel(h.Corrections.ThreeCMFD.axes_gammaBG_threecolor,'FRET Efficiency* BG','Color',UserValues.Look.Fore);
    ylabel(h.Corrections.ThreeCMFD.axes_gammaBG_threecolor,'1/Stoichiometry* BG','Color',UserValues.Look.Fore);
    title(h.Corrections.ThreeCMFD.axes_gammaBG_threecolor,'1/Stoichiometry* BG vs. FRET Efficiency* BG for gammaBG = 1','Color',UserValues.Look.Fore);
    
    h.Corrections.ThreeCMFD.axes_gammaBR_threecolor=  axes(...
        'Parent',h.MainTabCorrectionsThreeCMFDPanel,...
        'Units','normalized',...
        'Position',[0.05 0.05 0.4 0.25],...
        'Tag','Main_Tab_Corrections_Plot_gammaBG_threecolor',...
        'Box','on',...
        'XColor',Look.Fore,...
        'YColor',Look.Fore,...
        'LineWidth', Look.AxWidth,...
        'FontSize',12,...
        'nextplot','add',...
                           'XGrid','on',...
        'YGrid','on',...
        'GridAlpha',0.5,...
        'View',[0 90],...
        'UIContextMenu', h.Corrections_Menu);
    xlabel(h.Corrections.ThreeCMFD.axes_gammaBR_threecolor,'FRET Efficiency* BR','Color',UserValues.Look.Fore);
    ylabel(h.Corrections.ThreeCMFD.axes_gammaBR_threecolor,'1/Stoichiometry* BR','Color',UserValues.Look.Fore);
    title(h.Corrections.ThreeCMFD.axes_gammaBR_threecolor,'1/Stoichiometry* BR vs. FRET Efficiency* BR for gammaBR = 1','Color',UserValues.Look.Fore);
    
    %%% 07-2015 Disable Gamma from populations since it does not work
    h.Corrections.ThreeCMFD.axes_gammaBR_threecolor.Visible = 'off';
    h.Corrections.ThreeCMFD.axes_gammaBG_threecolor.Visible = 'off';
    
    h.Corrections.ThreeCMFD.axes_gamma_threecolor_lifetime =  axes(...
        'Parent',h.MainTabCorrectionsThreeCMFDPanel,...
        'Units','normalized',...
        'Position',[0.5 0.05 0.45 0.575],...
        'Tag','Main_Tab_Corrections_Plot_gamma_threecolor_lifetime',...
        'Box','on',...
        'XColor',Look.Fore,...
        'YColor',Look.Fore,...
        'LineWidth', Look.AxWidth,...
        'FontSize',12,...
        'nextplot','add',...
                           'XGrid','on',...
        'YGrid','on',...
        'GridAlpha',0.5,...
        'View',[0 90],...
        'UIContextMenu', h.Corrections_Menu);
    xlabel(h.Corrections.ThreeCMFD.axes_gamma_threecolor_lifetime,'Lifetime BB [ns]','Color',UserValues.Look.Fore);
    ylabel(h.Corrections.ThreeCMFD.axes_gamma_threecolor_lifetime,'FRET Efficiency B->G+R','Color',UserValues.Look.Fore);
    title(h.Corrections.ThreeCMFD.axes_gamma_threecolor_lifetime,'FRET Efficiency B->G+R vs. Lifetime BB','Color',UserValues.Look.Fore);
    %% Define Axes in Lifetime Tab
    s.ProgressRatio = 0.9;
    %%% Make Tabs for all plots and one for selecting individual plots for
    %%% inspection in detail
    % context menu for All tab lifetimes
    h.LifeTime_Menu = uicontextmenu;
    h.ExportLifetime_Menu = uimenu(...
        'Parent',h.LifeTime_Menu,...
        'Label','Export Lifetime Plots',...
        'Tag','ExportLifetime_Menu',...
        'Callback',@ExportGraphs);
%     h.ExportEvsTau_Menu = uimenu(...
%         'Parent',h.LifeTime_Menu,...
%         'Label','Export E vs TauGG Plot',...
%         'Tag','ExportEvsTau_Menu',...
%         'Callback',@ExportGraphs);
%     h.ExportEvsTauBB_Menu = uimenu(...
%         'Parent',h.LifeTime_Menu,...
%         'Label','Export E(B->G+R) vs TauBB Plot',...
%         'Tag','ExportEvsTauBB_Menu',...
%         'Callback',@ExportGraphs,...
%         'Visible','off');
    h.LifetimePanelAll.UIContextMenu = h.LifeTime_Menu;
    
    h.axes_EvsTauGG =  axes(...
        'Parent',h.LifetimePanelAll,...
        'Units','normalized',...
        'Position',[0.075 0.57 0.4 0.4],...
        'Tag','Main_Tab_Corrections_Plot_EvsTauGG',...
        'Box','on',...
        'XColor',Look.Fore,...
        'YColor',Look.Fore,...
        'LineWidth', Look.AxWidth,...
        'FontSize',12,...
        'nextplot','add',...
                           'XGrid','on',...
        'YGrid','on',...
        'GridAlpha',0.5,...
        'View',[0 90],...
        'UIContextMenu', h.LifeTime_Menu);
    ylabel(h.axes_EvsTauGG,'FRET Efficiency','Color',UserValues.Look.Fore);
    xlabel(h.axes_EvsTauGG,'\tau_{D(A)} [ns]','Color',UserValues.Look.Fore);
    
    h.axes_EvsTauRR =  axes(...
        'Parent',h.LifetimePanelAll,...
        'Units','normalized',...
        'Position',[0.575 0.57 0.4 0.4],...
        'Tag','Main_Tab_Corrections_Plot_EvsTauRR',...
        'Box','on',...
        'XColor',Look.Fore,...
        'YColor',Look.Fore,...
        'LineWidth', Look.AxWidth,...
        'FontSize',12,...
        'nextplot','add',...
                                   'XGrid','on',...
        'YGrid','on',...
        'GridAlpha',0.5,...
        'View',[0 90],...
        'UIContextMenu', h.LifeTime_Menu);
    ylabel(h.axes_EvsTauRR,'FRET Efficiency','Color',UserValues.Look.Fore);
    xlabel(h.axes_EvsTauRR,'\tau_{A} [ns]','Color',UserValues.Look.Fore);
    
    h.axes_rGGvsTauGG =  axes(...
        'Parent',h.LifetimePanelAll,...
        'Units','normalized',...
        'Position',[0.075 0.07 0.4 0.4],...
        'Tag','Main_Tab_Corrections_Plot_rGGvsTauGG',...
        'Box','on',...
        'XColor',Look.Fore,...
        'YColor',Look.Fore,...
        'LineWidth', Look.AxWidth,...
        'FontSize',12,...
        'nextplot','add',...
                           'XGrid','on',...
        'YGrid','on',...
        'GridAlpha',0.5,...
        'View',[0 90],...
        'UIContextMenu', h.LifeTime_Menu);
    ylabel(h.axes_rGGvsTauGG,'r_{D}','Color',UserValues.Look.Fore,'Rotation',0,'Units', 'Normalized', 'Position', [-0.075, 0.5, 0]);
    xlabel(h.axes_rGGvsTauGG,'\tau_{D(A)} [ns]','Color',UserValues.Look.Fore);
    title(h.axes_rGGvsTauGG,'Anisotropy D vs. Lifetime D','Color',UserValues.Look.Fore);
    h.axes_rGGvsTauGG.YLabel.Position(1) = h.axes_rGGvsTauGG.YLabel.Position(1)-0.01;
    
    h.axes_rRRvsTauRR=  axes(...
        'Parent',h.LifetimePanelAll,...
        'Units','normalized',...
        'Position',[0.575 0.07 0.4 0.4],...
        'Tag','Main_Tab_Corrections_Plot_rRRvsTauRR',...
        'Box','on',...
        'XColor',Look.Fore,...
        'YColor',Look.Fore,...
        'LineWidth', Look.AxWidth,...
        'FontSize',12,...
        'nextplot','add',...
                           'XGrid','on',...
        'YGrid','on',...
        'GridAlpha',0.5,...
        'View',[0 90],...
        'UIContextMenu', h.LifeTime_Menu);
    ylabel(h.axes_rRRvsTauRR,'r_{A}','Color',UserValues.Look.Fore,'Rotation',0,'Units', 'Normalized', 'Position', [-0.075, 0.5, 0]);
    xlabel(h.axes_rRRvsTauRR,'\tau_{A} [ns]','Color',UserValues.Look.Fore);
    title(h.axes_rRRvsTauRR,'Anisotropy A vs. Lifetime A','Color',UserValues.Look.Fore);
    
    %%% Define Axes for 3C
    %%% (For 3C, the four axes of 2C are shifted to the left and two
    %%% additional axes are made visible)
    h.axes_E_BtoGRvsTauBB =  axes(...
        'Parent',h.Hide_Stuff,...
        'Units','normalized',...
        'Position',[(0.15+0.8*2/3)+0.025 0.57 0.8/3 0.4],...
        'Tag','Main_Tab_Corrections_Plot_EBtoGRvsTauBB',...
        'Box','on',...
        'XColor',Look.Fore,...
        'YColor',Look.Fore,...
        'LineWidth', Look.AxWidth,...
        'FontSize',12,...
        'nextplot','add',...
                           'XGrid','on',...
        'YGrid','on',...
        'GridAlpha',0.5,...
        'View',[0 90],...
        'UIContextMenu', h.LifeTime_Menu);
    ylabel(h.axes_E_BtoGRvsTauBB,'FRET Efficiency B->G+R','Color',UserValues.Look.Fore);
    xlabel(h.axes_E_BtoGRvsTauBB,'\tau_{BB} [ns]','Color',UserValues.Look.Fore);
    title(h.axes_E_BtoGRvsTauBB,'FRET Efficiency B->G+R vs. Lifetime BB','Color',UserValues.Look.Fore);
    
    h.axes_rBBvsTauBB=  axes(...
        'Parent',h.Hide_Stuff,...
        'Units','normalized',...
        'Position',[(0.15+0.8*2/3)+0.025 0.07 0.8/3 0.4],...
        'Tag','Main_Tab_Corrections_Plot_rBBvsTauBB',...
        'Box','on',...
        'XColor',Look.Fore,...
        'YColor',Look.Fore,...
        'LineWidth', Look.AxWidth,...
        'FontSize',12,...
        'nextplot','add',...
                           'XGrid','on',...
        'YGrid','on',...
        'GridAlpha',0.5,...
        'View',[0 90],...
        'UIContextMenu', h.LifeTime_Menu);
    ylabel(h.axes_rBBvsTauBB,'r_{BB}','Color',UserValues.Look.Fore,'Rotation',0,'Units', 'Normalized', 'Position', [-0.12, 0.5, 0]);
    xlabel(h.axes_rBBvsTauBB,'\tau_{BB} [ns]','Color',UserValues.Look.Fore);
    title(h.axes_rBBvsTauBB,'Anisotropy BB vs. Lifetime BB','Color',UserValues.Look.Fore);
    
    %%% Axes in Lifetime Ind Tab
    %define uicontextmenu
    h.ExportGraphLifetime_Menu = uicontextmenu('Parent',h.BurstBrowser);

    h.Export2DLifetime_Menu = uimenu(...
        'Parent',h.ExportGraphLifetime_Menu,...
        'Label','Export Graph',...
        'Tag','Export2DLifetime_Menu',...
        'Callback',@ExportGraphs);
    h.LifetimePanelInd.UIContextMenu = h.ExportGraphLifetime_Menu;
    
    %define 2d axis
    h.axes_lifetime_ind_2d =  axes(...
        'Parent',h.LifetimePanelInd,...
        'Units','normalized',...
        'Position',[0.07 0.06 0.71 0.73],...
        'Box','on',...
        'Tag','axes_lifetime_ind_2d',...
        'FontSize',12,...
        'View',[0 90],...
        'XColor',Look.Fore,...
        'YColor',Look.Fore,...
        'LineWidth', Look.AxWidth,...
        'XGrid','on',...
        'YGrid','on',...
        'GridAlpha',0.5,...
        'nextplot','add',...
        'Color',Look.Axes,...
        'UIContextMenu',h.ExportGraphLifetime_Menu);
    %%% add a text box on top of axis for plotting of e.g. lifetime values
    %%% in phasor
    h.axes_lifetime_ind_2d_textbox= uicontrol(...
        'style','text',...
        'Parent',h.LifetimePanelInd,...
        'Units','normalized',...
        'Position',[0.8 0.94 0.2 0.06],...
        'BackgroundColor',Look.Back,...
        'String','',...
        'HorizontalAlignment','left',...
        'ForegroundColor',Look.Fore);
    %display popupmenu for selection
    h.lifetime_ind_popupmenu = uicontrol(...
        'Style','listbox',...
        'Parent',h.LifetimePanelInd,...
        'Tag','lifetime_ind_popupmenu',...
        'Units','normalized',...
        'FontSize',12,...
        'String',{'<html>E vs &tau;<sub>D(A)</sub></html>','<html>E vs &tau;<sub>A</sub></html>','<html>r<sub>D</sub> vs &tau;<sub>D(A)</sub></html>','<html>r<sub>A</sub> vs &tau;<sub>A</sub></html>'},...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Callback',@PlotLifetimeInd,...
        'Position',[0.81 0.81 0.16 0.13],...
        'UIContextMenu',h.ExportGraphLifetime_Menu);
%     %%% export button
%     h.lifetime_ind_export_button = uicontrol(...
%         'Style','pushbutton',...
%         'Parent',h.LifetimePanelInd,...
%         'Tag','lifetime_ind_export_button',...
%         'Units','normalized',...
%         'FontSize',12,...
%         'String','Export Graph',...
%         'BackgroundColor', Look.Control,...
%         'ForegroundColor', Look.Fore,...
%         'Callback',@ExportGraphs,...
%         'Position',[0.81 0.96 0.16 0.025]);
    
    %define 1d axes
    h.axes_lifetime_ind_1d_x =  axes(...
        'Parent',h.LifetimePanelInd,...
        'Units','normalized',...
        'Position',[0.07 0.79 0.71, 0.15],...
        'Box','on',...
        'Tag','axes_lifetime_ind_1d_x',...
        'FontSize',12,...
        'XAxisLocation','top',...
        'nextplot','add',...
        'View',[0 90],...
                           'XGrid','on',...
        'YGrid','on',...
        'GridAlpha',0.5,...
        'XColor',Look.Fore,...
        'YColor',Look.Fore,...
        'LineWidth', Look.AxWidth,...
        'UIContextMenu',h.ExportGraphLifetime_Menu);
    ylabel(h.axes_lifetime_ind_1d_x, 'counts','Color',Look.Fore);
    
    h.axes_lifetime_ind_1d_y =  axes(...
        'Parent',h.LifetimePanelInd,...
        'Units','normalized',...
        'Position',[0.78 0.06 0.15, 0.73],...
        'Tag','axes_lifetime_ind_1d_y',...
        'Box','on',...
        'FontSize',12,...
        'XAxisLocation','top',...
        'nextplot','add',...
        'XColor',Look.Fore,...
        'YColor',Look.Fore,...
        'LineWidth', Look.AxWidth,...
                           'XGrid','on',...
        'YGrid','on',...
        'GridAlpha',0.5,...
        'View',[90 90],...
        'XDir','reverse',...
        'UIContextMenu',h.ExportGraphLifetime_Menu);
    ylabel(h.axes_lifetime_ind_1d_y, 'counts','Color',Look.Fore);
    %% Define Axes in filtered FCS tab
    h.fFCS_axes_tab = uitabgroup(...
        'Parent',h.MainTabfFCSPanel,...
        'Units','normalized',...
        'Position',[0 0.45 1 0.45],...
        'Tag','fFCS_axes_tab');
    
    h.fFCS_axes_decay_tab = uitab(...
        'Parent',h.fFCS_axes_tab,...
        'Units','normalized',...
        'Title','Microtime patterns',...
        'BackgroundColor', Look.Back,...
        'Tag','fFCS_axes_decay_tab');
    
    h.axes_fFCS_DecayPar =  axes(...
        'Parent',h.fFCS_axes_decay_tab,...
        'Units','normalized',...
        'Position',[0.06 0.12 0.42 0.83],...
        'Tag','Main_Tab_fFCS_Decays_Par',...
        'Box','on',...
        'XColor',Look.Fore,...
        'YColor',Look.Fore,...
        'LineWidth', Look.AxWidth,...
        'XGrid','on',...
        'YGrid','on',...
        'GridAlpha',0.5,...
        'FontSize',12,...
        'nextplot','add');
    xlabel(h.axes_fFCS_DecayPar,'TCSPC bin','Color',UserValues.Look.Fore);
    ylabel(h.axes_fFCS_DecayPar,'Probability','Color',UserValues.Look.Fore);
    
    h.axes_fFCS_DecayPerp =  axes(...
        'Parent',h.fFCS_axes_decay_tab,...
        'Units','normalized',...
        'Position',[0.56 0.12 0.42 0.83],...
        'Tag','Main_Tab_fFCS_Decays_Perp',...
        'Box','on',...
        'XColor',Look.Fore,...
        'YColor',Look.Fore,...
        'LineWidth', Look.AxWidth,...
        'XGrid','on',...
        'YGrid','on',...
        'GridAlpha',0.5,...
        'FontSize',12,...
        'nextplot','add');
    xlabel(h.axes_fFCS_DecayPerp,'TCSPC bin','Color',UserValues.Look.Fore);
    ylabel(h.axes_fFCS_DecayPerp,'Probability','Color',UserValues.Look.Fore);
    
    h.fFCS_axes_result_tab = uitab(...
        'Parent',h.fFCS_axes_tab,...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'Title','fFCS result',...
        'Tag','fFCS_axes_decay_tab');
    
    h.axes_fFCS_Result =  axes(...
        'Parent',h.fFCS_axes_result_tab,...
        'Units','normalized',...
        'Position',[0.07 0.135 0.92 0.815],...
        'Tag','axes_fFCS_Result',...
        'Box','on',...
        'XColor',Look.Fore,...
        'YColor',Look.Fore,...
        'LineWidth', Look.AxWidth,...
        'XGrid','on',...
        'YGrid','on',...
        'GridAlpha',0.5,...
        'FontSize',12,...
        'nextplot','add',...
        'XScale','log');
    xlabel(h.axes_fFCS_Result,'time lag \tau [s]','Color',UserValues.Look.Fore);
    ylabel(h.axes_fFCS_Result,'G(\tau)','Color',UserValues.Look.Fore);
    
     h.fFCS_save_result_button = uicontrol(...
        'Style','pushbutton',...
        'Tag','fFCS_save_result_button',...
        'Parent',h.fFCS_axes_result_tab,...
        'Units','normalized',...
        'Position',[0.85 0.825 0.125 0.1],...
        'String','Save result',...
        'ForegroundColor',Look.Fore,...
        'BackgroundColor',Look.Control,...
        'FontSize',12,...
        'Callback',@Save_fFCS);
    %%% settings panel
    h.fFCS_settings_panel = uibuttongroup(...
        'Parent',h.MainTabfFCSPanel,...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'HighlightColor', Look.Fore,...
        'ShadowColor', Look.Shadow,...
        'Position',[0 0.9 1 0.1],...
        'Tag','fFCS_settings_panel');
    
    %%% Popupmenus for selection of species
    h.fFCS_Species1_text = uicontrol('Style','text',...
        'Parent',h.fFCS_settings_panel,...
        'Units','normalized',...
        'Position',[0.03 0.6 0.15 0.3],...
        'String','Species 1:',...
        'BackgroundColor',Look.Back,...
        'ForegroundColor',Look.Fore,...
        'FontSize',12);
    
    h.fFCS_Species1_popupmenu = uicontrol(...
        'Style','popupmenu',...
        'Tag','fFCS_Species1_popupmenu',...
        'Parent',h.fFCS_settings_panel,...
        'Units','normalized',...
        'ForegroundColor',Look.Fore,...
        'BackgroundColor',Look.Control,...
        'Position',[0.18 0.6 0.15 0.3],...
        'String',{'-'},...
        'Value',1,...
        'Callback',@Update_fFCS_GUI,...
        'FontSize',12);
    
    h.fFCS_Species2_text = uicontrol('Style','text',...
        'Parent',h.fFCS_settings_panel,...
        'Units','normalized',...
        'Position',[0.03 0.1 0.15 0.3],...
        'String','Species 2:',...
        'BackgroundColor',Look.Back,...
        'ForegroundColor',Look.Fore,...
        'FontSize',12);
    
    h.fFCS_Species2_popupmenu = uicontrol(...
        'Style','popupmenu',...
        'Tag','fFCS_Species2_popupmenu',...
        'Parent',h.fFCS_settings_panel,...
        'ForegroundColor',Look.Fore,...
        'BackgroundColor',Look.Control,...
        'Units','normalized',...
        'Position',[0.18 0.1 0.15 0.3],...
        'String',{'-'},...
        'Callback',@Update_fFCS_GUI,...
        'Value',1,...
        'FontSize',12);
    
    %%% Button to Update Microtime Histograms
    h.Plot_Microtimes_button = uicontrol(...
        'Style','pushbutton',...
        'Tag','Plot_Microtimes_button',...
        'Parent',h.fFCS_settings_panel,...
        'Units','normalized',...
        'Position',[0.725 0.675 0.25 0.25],...
        'String','Plot Microtimes',...
        'FontSize',12,...
        'ForegroundColor',Look.Fore,...
        'BackgroundColor',Look.Control,...
        'Callback',@Update_MicrotimeHistogramsfFCS);
    
    %%% Button to calculate filters
    h.Calc_fFCS_Filter_button = uicontrol(...
        'Style','pushbutton',...
        'Tag','Calc_fFCS_Filter_button',...
        'Parent',h.fFCS_settings_panel,...
        'Units','normalized',...
        'Position',[0.725 0.375 0.25 0.25],...
        'String','Calculate Filters',...
        'FontSize',12,...
        'Enable','off',...
        'ForegroundColor',Look.Fore,...
        'BackgroundColor',Look.Control,...
        'Callback',@Calc_fFCS_Filters);
    
    %%% Button to do correlation
    h.Do_fFCS_button = uicontrol(...
        'Style','pushbutton',...
        'Tag','Do_fFCS_button',...
        'Parent',h.fFCS_settings_panel,...
        'Units','normalized',...
        'Position',[0.725 0.075 0.25 0.25],...
        'String','Do fFCS',...
        'FontSize',12,...
        'Enable','off',...
        'ForegroundColor',Look.Fore,...
        'BackgroundColor',Look.Control,...
        'Callback',@Do_fFCS);
    
    %%% fFCS options
    %%% Option to check/uncheck downsampling for fFCS
    h.Downsample_fFCS = uicontrol('Style','checkbox',...
        'Parent',h.fFCS_settings_panel,...
        'String','Increase TCSPC bin width',...
        'Tag','Downsample_fFCS',...
        'Value', UserValues.BurstBrowser.Settings.Downsample_fFCS,...
        'Units','normalized',...
        'Position',[0.35 0.075 0.2 0.25],...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Callback',@UpdateOptions...
        );
    
    h.Downsample_fFCS_edit = uicontrol('Style','edit',...
        'Parent',h.fFCS_settings_panel,...
        'Tag','Downsample_fFCS',...
        'String', num2str(UserValues.BurstBrowser.Settings.Downsample_fFCS_Time),...
        'Units','normalized',...
        'Position',[0.55 0.075 0.1 0.25],...
        'FontSize',12,...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Callback',@UpdateOptions...
        );
    h.Downsample_fFCS_text = uicontrol('Style','text',...
        'Parent',h.fFCS_settings_panel,...
        'Tag','Downsample_fFCS',...
        'String','ps',...
        'Units','normalized',...
        'Position',[0.65 0.075 0.05 0.25],...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore...
        );
    
    if UserValues.BurstBrowser.Settings.Downsample_fFCS
        h.Downsample_fFCS_edit.Enable = 'on';
    else
        h.Downsample_fFCS_edit.Enable = 'off';
    end
    h.fFCS_selectmode_text = uicontrol('Style','text',...
        'Parent',h.fFCS_settings_panel,...
        'Tag','fFCS_selectmode_text',...
        'String','fFCS mode:',...
        'Units','normalized',...
        'HorizontalAlignment','left',...
        'Position',[0.35 0.675 0.1 0.25],...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore...
        );
    
    h.fFCS_selectmode_popupmenu = uicontrol('Style','popupmenu',...
        'Parent',h.fFCS_settings_panel,...
        'Tag','fFCS_selectmode_text',...
        'String',{'burstwise','burstwise with time window','continuous photon stream','continuous photon stream with donor only'},...
        'Units','normalized',...
        'Value',UserValues.BurstBrowser.Settings.fFCS_Mode,...
        'Position',[0.45 0.675 0.25 0.25],...
        'FontSize',12,...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Callback',@UpdateOptions...
        );
    
    h.fFCS_UseIRF = uicontrol('Style','checkbox',...
        'Parent',h.fFCS_settings_panel,...
        'String','Include Scatter Pattern',...
        'Tag','fFCS_UseIRF',...
        'Value', UserValues.BurstBrowser.Settings.fFCS_UseIRF,...
        'Units','normalized',...
        'Position',[0.35 0.375 0.175 0.25],...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Callback',@UpdateOptions...
        );
    
    h.fFCS_UseFRET = uicontrol('Style','checkbox',...
        'Parent',h.fFCS_settings_panel,...
        'String','Include FRET Channel',...
        'Tag','fFCS_UseFRET',...
        'Value', UserValues.BurstBrowser.Settings.fFCS_UseFRET,...
        'Units','normalized',...
        'Position',[0.4975 0.375 0.175 0.25],...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Callback',@UpdateOptions...
        );
    %     h.fFCS_UseTimeWindow = uicontrol('Style','checkbox',...
    %         'Parent',h.fFCS_settings_panel,...
    %         'String','Include Time Window for fFCS',...
    %         'Tag','fFCS_UseTimeWindow',...
    %         'Value', UserValues.BurstBrowser.Settings.fFCS_UseTimewindow,...
    %         'Units','normalized',...
    %         'Position',[0.1 0.58 0.5 0.07],...
    %         'FontSize',12,...
    %         'BackgroundColor', Look.Back,...
    %         'ForegroundColor', Look.Fore,...
    %         'Callback',@UpdateOptions...
    %         );
    
    %%% Axes for fFCS
    h.axes_fFCS_FilterPar =  axes(...
        'Parent',h.fFCS_SubTabParFilterPanel,...
        'Units','normalized',...
        'Position',[0.12 0.12 0.855 0.855],...
        'Tag','Sub_Tab_fFCS_Filter_Par',...
        'Box','on',...
        'XColor',Look.Fore,...
        'YColor',Look.Fore,...
        'LineWidth', Look.AxWidth,...
        'FontSize',12,...
                           'XGrid','on',...
        'YGrid','on',...
        'GridAlpha',0.5,...
        'nextplot','add');
    ylabel(h.axes_fFCS_FilterPar,'Filter value','Color',UserValues.Look.Fore);
    xlabel(h.axes_fFCS_FilterPar,'TCSPC bin','Color',UserValues.Look.Fore);
    
    h.axes_fFCS_FilterPerp =  axes(...
        'Parent',h.fFCS_SubTabPerpFilterPanel,...
        'Units','normalized',...
        'Position',[0.12 0.12 0.855 0.855],...
        'Tag','Sub_Tab_fFCS_Filter_Perp',...
        'Box','on',...
        'XColor',Look.Fore,...
        'YColor',Look.Fore,...
        'LineWidth', Look.AxWidth,...
        'FontSize',12,...
                           'XGrid','on',...
        'YGrid','on',...
        'GridAlpha',0.5,...
        'nextplot','add');
    ylabel(h.axes_fFCS_FilterPerp,'Filter value','Color',UserValues.Look.Fore);
    xlabel(h.axes_fFCS_FilterPerp,'TCSPC bin','Color',UserValues.Look.Fore);
    
    h.axes_fFCS_ReconstructionPar =  axes(...
        'Parent',h.fFCS_SubTabParReconstructionPanel,...
        'Units','normalized',...
        'Position',[0.12 0.12 0.855 0.705],...
        'Tag','Sub_Tab_fFCS_Reconstruction_Par',...
        'Box','on',...
        'XColor',Look.Fore,...
        'YColor',Look.Fore,...
        'LineWidth', Look.AxWidth,...
        'FontSize',12,...
                           'XGrid','on',...
        'YGrid','on',...
        'GridAlpha',0.5,...
        'nextplot','add');
    ylabel(h.axes_fFCS_ReconstructionPar,'Counts','Color',UserValues.Look.Fore);
    xlabel(h.axes_fFCS_ReconstructionPar,'TCSPC bin','Color',UserValues.Look.Fore);
    
    h.axes_fFCS_ReconstructionParResiduals =  axes(...
        'Parent',h.fFCS_SubTabParReconstructionPanel,...
        'Units','normalized',...
        'Position',[0.12 0.825 0.855 0.15],...
        'Tag','Sub_Tab_fFCS_Reconstruction_Par_Residuals',...
        'Box','on',...
        'XColor',Look.Fore,...
        'YColor',Look.Fore,...
        'LineWidth', Look.AxWidth,...
        'FontSize',12,...
                           'XGrid','on',...
        'YGrid','on',...
        'GridAlpha',0.5,...
        'nextplot','add',...
        'XTickLabel',[]);
    ylabel(h.axes_fFCS_ReconstructionParResiduals,'w_{res}','Color',UserValues.Look.Fore);
    
    h.axes_fFCS_ReconstructionPerp =  axes(...
        'Parent',h.fFCS_SubTabPerpReconstructionPanel,...
        'Units','normalized',...
        'Position',[0.12 0.12 0.855 0.705],...
        'Tag','Sub_Tab_fFCS_Reconstruction_Perp',...
        'Box','on',...
        'XColor',Look.Fore,...
        'YColor',Look.Fore,...
        'LineWidth', Look.AxWidth,...
                           'XGrid','on',...
        'YGrid','on',...
        'GridAlpha',0.5,...
        'FontSize',12,...
        'nextplot','add');
    ylabel(h.axes_fFCS_ReconstructionPerp,'Counts','Color',UserValues.Look.Fore);
    xlabel(h.axes_fFCS_ReconstructionPerp,'TCSPC bin','Color',UserValues.Look.Fore);
    
    h.axes_fFCS_ReconstructionPerpResiduals =  axes(...
        'Parent',h.fFCS_SubTabPerpReconstructionPanel,...
        'Units','normalized',...
        'Position',[0.12 0.825 0.855 0.15],...
        'Tag','Sub_Tab_fFCS_Reconstruction_Perp_Residuals',...
        'Box','on',...
        'XColor',Look.Fore,...
        'YColor',Look.Fore,...
        'LineWidth', Look.AxWidth,...
                           'XGrid','on',...
        'YGrid','on',...
        'GridAlpha',0.5,...
        'FontSize',12,...
        'nextplot','add',...
        'XTickLabel',[]);
    ylabel(h.axes_fFCS_ReconstructionPerpResiduals,'w_{res}','Color',UserValues.Look.Fore);
    
    %% Mac upscaling of Font Sizes
    if ismac
        scale_factor = 1.2;
        fields = fieldnames(h); %%% loop through h structure
        for i = 1:numel(fields)
            if isprop(h.(fields{i}),'FontSize')
                h.(fields{i}).FontSize = (h.(fields{i}).FontSize)*scale_factor;
            end
            if isprop(h.(fields{i}),'Style')
                if strcmp(h.(fields{i}).Style,'popupmenu')
                    h.(fields{i}).BackgroundColor = [1 1 1];
                    h.(fields{i}).ForegroundColor = [0 0 0];
                end
            end
        end
    end
    %% add keypress function to all gui elements
    fields = fieldnames(h); %%% loop through h structure
    for i = 1:numel(fields)
        if isprop(h.(fields{i}),'KeyPressFcn')
            if isempty(h.(fields{i}).KeyPressFcn)
                h.(fields{i}).KeyPressFcn = @BurstBrowser_KeyPress;
            end
        end
    end
    %% Store GUI data
    guidata(h.BurstBrowser,h);
    BurstMeta.SelectedFile = 1;
    BurstMeta.Database = UserValues.BurstBrowser.Database;
    %%% Clear BurstData if it still exists from editing in PAM
    global BurstData
    if isstruct(BurstData)
        BurstData = [];
    end
    %%% Initialize Plots
    Initialize_Plots(1);
    UpdateOptions(h.Fit_NGaussian_Popupmenu,[],h);
    UpdateGUIOptions(h.PlotGridAboveDataCheckbox,[],h);
    ChangePlotType([],[],h);
    %% set UserValues in GUI
    UpdateCorrections([],[],h);
    %%% Update ColorMap
    if ischar(UserValues.BurstBrowser.Display.ColorMap)
        if ~UserValues.BurstBrowser.Display.ColorMapFromWhite
            colormap(h.BurstBrowser,UserValues.BurstBrowser.Display.ColorMap);
        else
            if ~strcmp(UserValues.BurstBrowser.Display.ColorMap,'jet')
                colormap(h.BurstBrowser,colormap_from_white(UserValues.BurstBrowser.Display.ColorMap));
            else %%% jet is a special case, use jetvar colormap
                colormap(h.BurstBrowser,jetvar);
            end
        end
    else
        colormap(UserValues.BurstBrowser.Display.ColorMap);
    end
    %%% Re-Enable Menu
    h.File_Menu.Enable = 'on';
    
    h.BurstBrowser.Visible = 'on';
    
    delete(s);
else
    figure(hfig);
end

clearvars -global BurstData BurstTCSPCData
if ~isempty(findobj('Tag','Pam'))
    h_pam = guidata(findobj('Tag','Pam'));
    %%% Reset loaded file textbox
    h_pam.Burst_LoadedFile_Text.String = '';
    h_pam.Burst_LoadedFile_Text.TooltipString = '';
    %%% Set Analysis Buttons in Pam
    %%% set the text of the BurstSearch Button to green color to indicate that
    %%% a burst search has been done
    h_pam.Burst_Button.ForegroundColor = Look.Fore;
    %%% Disable Lifetime and 2CDE Button
    h_pam.BurstLifetime_Button.Enable = 'off';
    h_pam.BurstLifetime_Button.ForegroundColor = Look.Fore;
    h_pam.NirFilter_Button.Enable = 'off';
    h_pam.NirFilter_Button.ForegroundColor = Look.Fore;
end

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%% Close Function: Clear global Variable on closing  %%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function Close_BurstBrowser(obj,~)
global BurstData UserValues BurstTCSPCData PhotonStream BurstMeta
if ~isempty(BurstData) && UserValues.BurstBrowser.Settings.SaveOnClose
    %%% Ask for saving
    choice = questdlg('Save Changes?','Save before closing','Yes','Discard','Cancel','Discard');
    switch choice
        case 'Yes'
            Save_Analysis_State_Callback([],[]);
        case 'Cancel'
            return;
    end
end

CloseWindow(obj,[]);