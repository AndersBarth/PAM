function GlobalTauFit(obj,~)
global UserValues FCSData FCSMeta PathToApp
h.FCSFit=findobj('Tag','FCSFit');

addpath(genpath(['.' filesep 'functions']));

if isempty(PathToApp)
    GetAppFolder();
end

addpath(genpath(['.' filesep 'functions']));
LSUserValues(0);
method = '';
%%% If called from command line, or from Launcher
if (nargin < 1 && isempty(gcbo)) || (nargin < 1 && strcmp(get(gcbo,'Tag'),'FCSFit_Launcher'))
    if ~isempty(findobj('Tag','FCSFit'))
        CloseWindow(findobj('Tag','FCSFit'))
    end
    %disp('Call TauFit from Pam or BurstBrowser instead of command line!');
    %return;
    FCSData.Who = 'External';
    method = 'ensemble';
    obj = false;
end

if ~isempty(h.FCSFit)
    % Close TauFit cause it might be called from somewhere else than before
    CloseWindow(h.FCSFit);
end
if ~isempty(findobj('Tag','Pam'))
    ph = guidata(findobj('Tag','Pam'));
end
if ~isempty(findobj('Tag','BurstBrowser'))
    bh = guidata(findobj('Tag','BurstBrowser'));
end




if isempty(h.FCSFit) % Creates new figure, if none exists
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Figure generation %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%   
    %%% Disables uitabgroup warning
    warning('off','MATLAB:uitabgroup:OldVersion');   
    %%% Loads user profile    
    [~,~]=LSUserValues(0);
    %%% To save typing
    Look=UserValues.Look;    
    %%% Generates the FCSFit figure
    h.FCSFit = figure(...
        'Units','normalized',...
        'Tag','FCSFit',...
        'Name','FCSFit',...
        'NumberTitle','off',...
        'Menu','none',...
        'defaultUicontrolFontName',Look.Font,...
        'defaultAxesFontName',Look.Font,...
        'defaultTextFontName',Look.Font,...
        'Toolbar','figure',...
        'UserData',[],...
        'OuterPosition',[0.01 0.1 0.98 0.9],...
        'CloseRequestFcn',@CloseWindow,...
        'Visible','on');
    %h.FCSFit.Visible='off';
    %%% Remove unneeded items from toolbar
    toolbar = findall(h.FCSFit,'Type','uitoolbar');
    toolbar_items = findall(toolbar);
    if verLessThan('matlab','9.5') %%% toolbar behavior changed in MATLAB 2018b
        delete(toolbar_items([2:7 9 13:17]));
    else %%% 2018b and upward
        %%% just remove the tool bar since the options are now in the axis
        %%% (e.g. axis zoom etc)
        delete(toolbar_items);
    end
    %%% Sets background of axes and other things
    whitebg(Look.Axes);
    %%% Changes Pam background; must be called after whitebg
    h.FCSFit.Color=Look.Back;
    
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Menubar %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%     
    %%% File menu with loading, saving and exporting functions
    h.File = uimenu(...
        'Parent',h.FCSFit,...
        'Tag','File',...
        'Label','File');
    %%% Menu to load new Cor file
    h.LoadCor = uimenu(h.File,...
        'Tag','LoadCor',...
        'Label','Load New Files',...
        'Callback',{@Load_Cor,1});
    %%% Menu to add Cor files to existing
    h.AddCor = uimenu(h.File,...
        'Tag','AddCor',...
        'Label','Add Files',...
        'Callback',{@Load_Cor,2});
    %%% Menu to load fit function
    h.LoadFit = uimenu(h.File,...
        'Tag','LoadFit',...
        'Label','Load Fit Function',...
        'Callback',{@Load_Fit,1});
    %%% Menu to load fit function
    h.LoadSession = uimenu(h.File,...
        'Tag','LoadSession',...
        'Label','Load FCSFit Session',...
        'Separator','on',...
        'Callback',@LoadSave_Session);
     h.SaveSession = uimenu(h.File,...
        'Tag','SaveSession',...
        'Label','Save FCSFit Session',...
        'Callback',@LoadSave_Session);
    %%% Menu to merge loaded Cor files
    h.MergeCor = uimenu(h.File,...
        'Tag','MergeCor',...
        'Label','Merge Loaded Cor Files',...
        'Separator','on',...
        'Callback',@Merge_Cor);
    
    %%% File menu to stop fitting
    h.AbortFit = uimenu(...
        'Parent',h.FCSFit,...
        'Tag','AbortFit',...
        'Label',' Stop....'); 
    h.StopFit = uimenu(...
        'Parent',h.AbortFit,...
        'Tag','StopFit',...
        'Label','...Fit',...
        'Callback',@Stop_FCSFit);   
    %%% File menu for fitting
    h.StartFit = uimenu(...
        'Parent',h.FCSFit,...
        'Tag','StartFit',...
        'Label','Start...');
    h.DoFit = uimenu(...
        'Parent',h.StartFit,...
        'Tag','Fit',...
        'Label','...Fit',...
        'Callback',@Do_FCSFit);
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Fitting parameters Tab %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    h.FitParams_Tab = uitabgroup(...
        'Parent',h.FCSFit,...
        'Tag','FitParams_Tab',...
        'Units','normalized',...
        'Position',[0.005 0.01 0.99 0.24]);
    %% Fit function tab %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %%% Tab for fit function inputs
    h.Fit_Function_Tab= uitab(...
        'Parent',h.FitParams_Tab,...
        'Tag','Fit_Function_Tab',...
        'Title','Fit');    
    %%% Panel for fit function inputs
    h.Fit_Function_Panel = uibuttongroup(...
        'Parent',h.Fit_Function_Tab,...
        'Tag','Fit_Function_Panel',...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'HighlightColor', Look.Control,...
        'ShadowColor', Look.Shadow,...
        'Position',[0 0 1 1]);
    %%% Fitting table
    h.Fit_Table = uitable(...
        'Parent',h.Fit_Function_Panel,...
        'Tag','Fit_Table',...
        'Units','normalized',...
        'ForegroundColor',Look.TableFore,...
        'BackgroundColor',[Look.Table1;Look.Table2],...
        'FontSize',10,...
        'Position',[0 0 1 1],...
        'CellEditCallback',{@Update_Table,3},...
        'CellSelectionCallback',{@Update_Table,3});
    h.Fit_Table_Menu = uicontextmenu;
    h.Fit_Table.UIContextMenu = h.Fit_Table_Menu;
    %%% Button for exporting excel sheet of results
    h.Export_Clipboard = uimenu(...
        'Parent',h.Fit_Table_Menu,...
        'Label','Copy Results to Clipboard',...
        'Callback',{@Plot_Menu_Callback,4});  
    %% Tab containing settings
h.Settings_Tab = uitab(...
    'Parent',h.FitParams_Tab,...
    'Title','Settings',...
    'Tag','Settings_Tab');

h.Settings_Panel = uibuttongroup(...
    'Parent',h.Settings_Tab,...
    'Units','normalized',...
    'BackgroundColor',Look.Back,...
    'ForegroundColor',Look.Fore,...
    'HighlightColor',Look.Control,...
    'ShadowColor',Look.Shadow,...
    'Position',[0 0 1 1],...
    'Tag','Settings_Panel');

h.IRF_Cleanup_Panel = uibuttongroup(...
    'Parent',h.Settings_Panel,...
    'Units','normalized',...
    'BackgroundColor',Look.Back,...
    'ForegroundColor',Look.Fore,...
    'HighlightColor',Look.Control,...
    'ShadowColor',Look.Shadow,...
    'Position',[0 0 1 0.5],...
    'FontSize',12,...
    'Tag','IRF_Cleanup_Panel',...
    'Title','IRF cleanup');

h.ConvolutionType_Text = uicontrol(...
    'Style','text',...
    'Parent',h.Settings_Panel,...
    'Units','normalized',...
    'BackgroundColor',Look.Back,...
    'ForegroundColor',Look.Fore,...
    'Position',[0 0.9 0.1 0.07],...
    'String','Convolution Type',...
    'FontSize',10,...
    'Tag','ConvolutionType_Text');

h.ConvolutionType_Menu = uicontrol(...
    'Style','popupmenu',...
    'Parent',h.Settings_Panel,...
    'Units','normalized',...
    'Position',[0.15 0.9 0.15 0.07],...
    'String',{'linear','circular'},...
    'Value',find(strcmp({'linear','circular'},UserValues.TauFit.ConvolutionType)),...
    'Tag','ConvolutionType_Menu');

h.LineStyle_Text = uicontrol(...
    'Style','text',...
    'Parent',h.Settings_Panel,...
    'Units','normalized',...
    'BackgroundColor',Look.Back,...
    'ForegroundColor',Look.Fore,...
    'Position',[0.3 0.9 0.45 0.07],...
    'String','Line Style (Result)',...
    'FontSize',10,...
    'Tag','LineStyle_Text');
h.LineStyle_Menu = uicontrol(...
    'Style','popupmenu',...
    'Parent',h.Settings_Panel,...
    'Units','normalized',...
    'Position',[0.60 0.9 0.15 0.07],...
    'String',{'line','dots'},...
    'Value',find(strcmp({'line','dots'},UserValues.TauFit.LineStyle)),...
    'Callback',@UpdateOptions,...
    'Tag','LineStyle_Menu');

h.AutoFit_Menu = uicontrol(...
    'Style','checkbox',...
    'Parent',h.Settings_Panel,...
    'Units','normalized',...
    'BackgroundColor',Look.Back,...
    'ForegroundColor',Look.Fore,...
    'Position',[0.03 0.75 0.7 0.07],...
    'String','Automatic fit',...
    'FontSize',10,...
    'Tag','AutoFit_Menu',...
    'Callback',@Update_Plots);
h.NormalizeScatter_Menu = uicontrol(...
    'Style','checkbox',...
    'Parent',h.Settings_Panel,...
    'Units','normalized',...
    'BackgroundColor',Look.Back,...
    'ForegroundColor',Look.Fore,...
    'Position',[0.10 0.75 0.45 0.07],...
    'String','Scatter offset = 0',...
    'FontSize',10,...
    'Tag','NormalizeScatter_Menu',...
    'Callback',@Update_Plots);

h.UseWeightedResiduals_Menu = uicontrol(...
    'Style','checkbox',...
    'Parent',h.Settings_Panel,...
    'Units','normalized',...
    'BackgroundColor',Look.Back,...
    'ForegroundColor',Look.Fore,...
    'Position',[0.495 0.75 0.45 0.07],...
    'String','Use weighted residuals',...
    'Value',UserValues.TauFit.use_weighted_residuals,...
    'FontSize',10,...
    'Tag','UseWeightedResiduals_Menu',...
    'Callback',@UpdateOptions);
h.WeightedResidualsType_Menu = uicontrol(...
    'Style','popupmenu',...
    'Parent',h.Settings_Panel,...
    'Units','normalized',...
    'Position',[0.60 0.75 0.15 0.07],...
    'String',{'Gaussian','Poissonian'},...
    'Value',find(strcmp({'Gaussian','Poissonian'},UserValues.TauFit.WeightedResidualsType)),...
    'Tag','WeightedResidualsType_Menu');
h.MCMC_Error_Estimation_Menu = uicontrol(...
    'Style','checkbox',...
    'Parent',h.Settings_Panel,...
    'Units','normalized',...
    'BackgroundColor',Look.Back,...
    'ForegroundColor',Look.Fore,...
    'Position',[0.03 0.55 0.45 0.07],...
    'String','Perform MCMC error estimation?',...
    'FontSize',10,...
    'TooltipString',sprintf('Performs Markov Chain Monte Carlo sampling using the Metropolis-Hasting algorithm\nto estimate the posterior distribution of the model parameters.'),...
    'Tag','NormalizeScatter_Menu',...
    'Callback',[]);
h.Cleanup_IRF_Menu = uicontrol(...
    'Style','checkbox',...
    'Parent',h.Settings_Panel,...
    'Units','normalized',...
    'BackgroundColor',Look.Back,...
    'ForegroundColor',Look.Fore,...
    'Position',[0.495 0.55 0.45 0.07],...
    'String','Clean up IRF by fitting to Gamma distribution',...
    'Value',UserValues.TauFit.cleanup_IRF,...
    'FontSize',10,...
    'Tag','Cleanup_IRF_Menu',...
    'Callback',@UpdateOptions);

h.Cleanup_IRF_axes = axes('Parent',h.IRF_Cleanup_Panel,...
    'Position',[0.125,0.2,0.83,0.77],'Units','normalized','FontSize',10,'XColor',Look.Fore,'YColor',Look.Fore);
normaldist = 1./(sqrt(2*pi)*2).*exp(-((1:100)-20).^2./(2*2^2));
h.Plots.IRF_cleanup.IRF_data = plot(h.Cleanup_IRF_axes,1:1:100,normaldist,'LineStyle','none','Marker','.','MarkerSize',10);
hold on;
normaldist = 1./(sqrt(2*pi)*2).*exp(-((1:0.1:100)-20).^2./(2*2^2));
h.Plots.IRF_cleanup.IRF_fit = plot(h.Cleanup_IRF_axes,1:0.1:100,normaldist,'LineStyle','-','Marker','none','MarkerSize',10,'LineWidth',2);
h.Cleanup_IRF_axes.XLabel.String = 'Time [ns]';
h.Cleanup_IRF_axes.YLabel.String = 'PDF';
h.Cleanup_IRF_axes.XColor = Look.Fore;
h.Cleanup_IRF_axes.YColor = Look.Fore;
h.Cleanup_IRF_axes.XLabel.Color = Look.Fore;
h.Cleanup_IRF_axes.YLabel.Color = Look.Fore;

%% %% Settings tab %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Sliders
%%% Define the container
%%%%%%%% CHANGE SLIDER WIDTH AND MOVE TEXT TO MIDDLE OF SLIDER
h.Tau_Parameter_Tab= uitab(...
        'Parent',h.FitParams_Tab,...
        'Tag','Tau_Parameter_Tab',...
        'Title','Curve parameters');    
    
h.Slider_Panel = uibuttongroup(...
    'Parent',h.Tau_Parameter_Tab,...
    'Units','normalized',...
    'BackgroundColor', Look.Back,...
    'ForegroundColor', Look.Fore,...
    'HighlightColor', Look.Control,...
    'ShadowColor', Look.Shadow,...
    'Position',[0 0 1 1],...
    'Tag','Slider_Panel');

%%% Individual sliders for:
%%% 1) Start
%%% 2) Length
%%% 3) Shift of perpendicular channel
%%% 4) Shift of IRF
%%% 5) IRF length to consider
%%%
%%% Slider for Selection of Start
h.StartPar_Slider = uicontrol(...
    'Style','slider',...
    'Parent',h.Slider_Panel,...
    'Units','normalized',...
    'BackgroundColor', Look.Back,...
    'ForegroundColor', Look.Fore,...
    'Position',[0.17 0.825 0.32 0.125],...
    'Tag','StartPar_Slider',...
    'Callback',@Update_Plots);

h.StartPar_Edit = uicontrol(...
    'Parent',h.Slider_Panel,...
    'Style','edit',...
    'Tag','StartPar_Edit',...
    'Units','normalized',...
    'Position',[0.11 0.825 0.05 0.15],...
    'String','0',...
    'BackgroundColor', Look.Control,...
    'ForegroundColor', Look.Fore,...
    'FontSize',9,...
    'Callback',@Update_Plots);

h.StartPar_Text = uicontrol(...
    'Style','text',...
    'Parent',h.Slider_Panel,...
    'Units','normalized',...
    'BackgroundColor', Look.Back,...
    'ForegroundColor', Look.Fore,...
    'HorizontalAlignment','left',...
    'FontSize',9,...
    'String','Start',...
    'TooltipString','Start Value for the Parallel Channel',...
    'Position',[0.01 0.825 0.1 0.175],...
    'Tag','StartPar_Text');

%%% Slider for Selection of Length
h.Length_Slider = uicontrol(...
    'Style','slider',...
    'Parent',h.Slider_Panel,...
    'Units','normalized',...
    'BackgroundColor', Look.Back,...
    'ForegroundColor', Look.Fore,...
    'Position',[0.17 0.625 0.32 0.125],...
    'Tag','Length_Slider',...
    'Callback',@Update_Plots);

h.Length_Edit = uicontrol(...
    'Parent',h.Slider_Panel,...
    'Style','edit',...
    'Tag','Length_Edit',...
    'Units','normalized',...
    'Position',[0.11 0.625 0.05 0.15],...
    'String','0',...
    'BackgroundColor', Look.Control,...
    'ForegroundColor', Look.Fore,...
    'FontSize',9,...
    'Callback',@Update_Plots);

h.Length_Text = uicontrol(...
    'Style','text',...
    'Parent',h.Slider_Panel,...
    'Units','normalized',...
    'BackgroundColor', Look.Back,...
    'ForegroundColor', Look.Fore,...
    'HorizontalAlignment','left',...
    'FontSize',9,...
    'String','Length',...
    'TooltipString','Length of the Microtime Histogram',...
    'Position',[0.01 0.625 0.1 0.175],...
    'Tag','Length_Text');

%%% Slider for Selection of IRF Length
h.IRFLength_Slider = uicontrol(...
    'Style','slider',...
    'Parent',h.Slider_Panel,...
    'Units','normalized',...
    'BackgroundColor', Look.Back,...
    'ForegroundColor', Look.Fore,...
    'Position',[0.17 0.425 0.32 0.125],...
    'Tag','IRFLength_Slider',...
    'Callback',@Update_Plots);

h.IRFLength_Edit = uicontrol(...
    'Parent',h.Slider_Panel,...
    'Style','edit',...
    'Tag','IRFLength_Edit',...
    'Units','normalized',...
    'Position',[0.11 0.425 0.05 0.15],...
    'String','0',...
    'BackgroundColor', Look.Control,...
    'ForegroundColor', Look.Fore,...
    'FontSize',9,...
    'Callback',@Update_Plots);

h.IRFLength_Text = uicontrol(...
    'Style','text',...
    'Parent',h.Slider_Panel,...
    'Units','normalized',...
    'BackgroundColor', Look.Back,...
    'ForegroundColor', Look.Fore,...
    'HorizontalAlignment','left',...
    'FontSize',9,...
    'String','IRF Length',...
    'TooltipString','Length of the IRF',...
    'Position',[0.01 0.425 0.1 0.175],...
    'Tag','IRFLength_Text');

%%% Slider for Selection of IRF Shift
h.IRFShift_Slider = uicontrol(...
    'Style','slider',...
    'Parent',h.Slider_Panel,...
    'Units','normalized',...
    'BackgroundColor', Look.Back,...
    'ForegroundColor', Look.Fore,...
    'Position',[0.17 0.225 0.32 0.125],...
    'Tag','IRFShift_Slider',...
    'Callback',@Update_Plots);

h.IRFShift_Edit = uicontrol(...
    'Parent',h.Slider_Panel,...
    'Style','edit',...
    'Tag','IRFShift_Edit',...
    'Units','normalized',...
    'Position',[0.11 0.225 0.05 0.15],...
    'String','0',...
    'BackgroundColor', Look.Control,...
    'ForegroundColor', Look.Fore,...
    'FontSize',9,...
    'Callback',@Update_Plots);

h.IRFShift_Text = uicontrol(...
    'Style','text',...
    'Parent',h.Slider_Panel,...
    'Units','normalized',...
    'BackgroundColor', Look.Back,...
    'ForegroundColor', Look.Fore,...
    'HorizontalAlignment','left',...
    'FontSize',9,...
    'String','IRF Shift',...
    'TooltipString','Shift of the IRF',...
    'Position',[0.01 0.225 0.1 0.175],...
    'Tag','IRFShift_Text');

%%% Slider for Selection of Scat Shift
h.ScatShift_Slider = uicontrol(...
    'Style','slider',...
    'Parent',h.Slider_Panel,...
    'Units','normalized',...
    'BackgroundColor', Look.Back,...
    'ForegroundColor', Look.Fore,...
    'Position',[0.17 0.025 0.32 0.125],...
    'Tag','ScatShift_Slider',...
    'Callback',@Update_Plots);

h.ScatShift_Edit = uicontrol(...
    'Parent',h.Slider_Panel,...
    'Style','edit',...
    'Tag','ScatShift_Edit',...
    'Units','normalized',...
    'Position',[0.11 0.025 0.05 0.15],...
    'String','0',...
    'BackgroundColor', Look.Control,...
    'ForegroundColor', Look.Fore,...
    'FontSize',9,...
    'Callback',@Update_Plots);

h.ScatShift_Text = uicontrol(...
    'Style','text',...
    'Parent',h.Slider_Panel,...
    'Units','normalized',...
    'BackgroundColor', Look.Back,...
    'ForegroundColor', Look.Fore,...
    'HorizontalAlignment','left',...
    'FontSize',9,...
    'String','Scat Shift',...
    'TooltipString','Shift of the Scat',...
    'Position',[0.01 0.025 0.1 0.175],...
    'Tag','ScatShift_Text');

%%% Slider for Selection of Perpendicular Shift
h.ShiftPer_Slider = uicontrol(...
    'Style','slider',...
    'Parent',h.Slider_Panel,...
    'Units','normalized',...
    'BackgroundColor', Look.Back,...
    'ForegroundColor', Look.Fore,...
    'Position',[0.67 0.825 0.32 0.125],...
    'Tag','ShiftPer_Slider',...
    'Callback',@Update_Plots);

h.ShiftPer_Edit = uicontrol(...
    'Parent',h.Slider_Panel,...
    'Style','edit',...
    'Tag','ShiftPer_Edit',...
    'Units','normalized',...
    'Position',[0.61 0.825 0.05 0.15],...
    'String','0',...
    'BackgroundColor', Look.Control,...
    'ForegroundColor', Look.Fore,...
    'FontSize',9,...
    'Callback',@Update_Plots);

h.ShiftPer_Text = uicontrol(...
    'Style','text',...
    'Parent',h.Slider_Panel,...
    'Units','normalized',...
    'BackgroundColor', Look.Back,...
    'ForegroundColor', Look.Fore,...
    'HorizontalAlignment','left',...
    'FontSize',9,...
    'String','Perp Shift',...
    'TooltipString','Shift of the Perpendicular Channel',...
    'Position',[0.51 0.825 0.1 0.175],...
    'Tag','ShiftPer_Text');

%%% RIGHT SLIDERS %%%
%%% Slider for Selection of Ignore Region in the Beginning
h.Ignore_Slider = uicontrol(...
    'Style','slider',...
    'Parent',h.Slider_Panel,...
    'Units','normalized',...
    'BackgroundColor', Look.Back,...
    'ForegroundColor', Look.Fore,...
    'Position',[0.67 0.625 0.32 0.125],...
    'Tag','Ignore_Slider',...
    'Callback',@Update_Plots);

h.Ignore_Edit = uicontrol(...
    'Parent',h.Slider_Panel,...
    'Style','edit',...
    'Tag','Ignore_Edit',...
    'Units','normalized',...
    'Position',[0.61 0.625 0.05 0.15],...
    'String','0',...
    'BackgroundColor', Look.Control,...
    'ForegroundColor', Look.Fore,...
    'FontSize',9,...
    'Callback',@Update_Plots);

h.Ignore_Text = uicontrol(...
    'Style','text',...
    'Parent',h.Slider_Panel,...
    'Units','normalized',...
    'BackgroundColor', Look.Back,...
    'ForegroundColor', Look.Fore,...
    'HorizontalAlignment','left',...
    'FontSize',9,...
    'String','Ignore Length',...
    'TooltipString','Length of the Ignore Region in the Beginning',...
    'Position',[0.51 0.625 0.1 0.175],...
    'Tag','Ignore_Text');

%%% Slider for Selection of relative IRF Shift
h.IRFrelShift_Slider = uicontrol(...
    'Style','slider',...
    'Parent',h.Slider_Panel,...
    'Units','normalized',...
    'BackgroundColor', Look.Back,...
    'ForegroundColor', Look.Fore,...
    'Position',[0.67 0.225 0.32 0.125],...
    'Tag','IRFrelShift_Slider',...
    'Callback',@Update_Plots);

h.IRFrelShift_Edit = uicontrol(...
    'Parent',h.Slider_Panel,...
    'Style','edit',...
    'Tag','IRFrelShift_Edit',...
    'Units','normalized',...
    'Position',[0.61 0.225 0.05 0.15],...
    'String','0',...
    'BackgroundColor', Look.Control,...
    'ForegroundColor', Look.Fore,...
    'FontSize',9,...
    'Callback',@Update_Plots);

h.IRFrelShift_Text = uicontrol(...
    'Style','text',...
    'Parent',h.Slider_Panel,...
    'Units','normalized',...
    'BackgroundColor', Look.Back,...
    'ForegroundColor', Look.Fore,...
    'HorizontalAlignment','left',...
    'FontSize',9,...
    'String','Perp IRF Shift',...
    'TooltipString','Shift of the IRF perpendicular with respect to the parallel IRF',...
    'Position',[0.51 0.225 0.1 0.175],...
    'Tag','IRFrelShift_Text');

%%% Slider for Selection of relative Scat Shift
h.ScatrelShift_Slider = uicontrol(...
    'Style','slider',...
    'Parent',h.Slider_Panel,...
    'Units','normalized',...
    'BackgroundColor', Look.Back,...
    'ForegroundColor', Look.Fore,...
    'Position',[0.67 0.025 0.32 0.125],...
    'Tag','ScatrelShift_Slider',...
    'Callback',@Update_Plots);

h.ScatrelShift_Edit = uicontrol(...
    'Parent',h.Slider_Panel,...
    'Style','edit',...
    'Tag','ScatrelShift_Edit',...
    'Units','normalized',...
    'Position',[0.61 0.025 0.05 0.15],...
    'String','0',...
    'BackgroundColor', Look.Control,...
    'ForegroundColor', Look.Fore,...
    'FontSize',9,...
    'Callback',@Update_Plots);

h.ScatrelShift_Text = uicontrol(...
    'Style','text',...
    'Parent',h.Slider_Panel,...
    'Units','normalized',...
    'BackgroundColor', Look.Back,...
    'ForegroundColor', Look.Fore,...
    'HorizontalAlignment','left',...
    'FontSize',9,...
    'String','Perp Scat Shift',...
    'TooltipString','Shift of the Scat perpendicular with respect to the parallel Scat',...
    'Position',[0.51 0.025 0.1 0.175],...
    'Tag','ScatrelShift_Text');



 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %% %% %% %% PIE Channel Selection and general Buttons
    
h.PIE_File_Select_Tab= uitab(...
    'Parent',h.FitParams_Tab,...
    'Tag','PIE_Channel_Tab',...
    'Title','Data from PAM');    
    
h.PIEChannel_Panel = uibuttongroup(...
    'Parent',h.PIE_File_Select_Tab,...
    'Units','normalized',...
    'BackgroundColor', Look.Back,...
    'ForegroundColor', Look.Fore,...
    'HighlightColor', Look.Control,...
    'ShadowColor', Look.Shadow,...
    'Position',[0 0 1 1],...
    'Tag','PIEChannel_Panel');

%%% Button to determine G-factor
h.Determine_GFactor_Button = uicontrol(...
    'Parent',h.PIEChannel_Panel,...
    'Style','pushbutton',...
    'Tag','Determine_GFactor_Button',...
    'Units','normalized',...
    'BackgroundColor', Look.Control,...
    'ForegroundColor', Look.Fore,...
    'Position',[0.65 0.05 0.29 0.12],...
    'String','Determine G factor',...
    'Callback',@DetermineGFactor);

%%% Popup Menu for Fit Method Selection
h.FitMethods = {'Single Exponential','Biexponential','Three Exponentials','Four Exponentials','Stretched Exponential',...
    'Distribution','Distribution plus Donor only','Two Distributions plus Donor only','Distribution Fit - Global Model'...
    'Fit Anisotropy',...
    'Fit Anisotropy (2 exp lifetime)','Fit Anisotropy (2 exp rot)',...
    'Fit Anisotropy (2 exp lifetime, 2 exp rot)',...
    'Fit Anisotropy (2 exp lifetime with independent anisotropy)'...
    };
if exist('ph','var')
    if isobject(obj)
        switch obj
            case ph.Menu.OpenTauFit
                FCSData.Who = 'GlobalTauFit';
                % user called TauFit from Pam
                % fit a lifetime from data in a PIE channel
                method = 'ensemble';
            case {ph.Burst.BurstLifetime_Button, ph.Burst.Button}
                FCSData.Who = 'Burstwise';
                %%% User Clicks Burstwise Lifetime button in Pam, Burst 
                %%% Analysis button in Pam with lifetime checkbox checked or 
                %%% Burst Analysis on database tab in Pam, with lifetime
                %%% checkbox checked
                h.ChannelSelect_Text = uicontrol(...
                    'Parent',h.PIEChannel_Panel,...
                    'Style','Text',...
                    'Tag','ChannelSelect_Text',...
                    'Units','normalized',...
                    'Position',[0.05 0.85 0.4 0.1],...
                    'BackgroundColor', Look.Back,...
                    'ForegroundColor', Look.Fore,...
                    'HorizontalAlignment','left',...
                    'FontSize',10,...
                    'String','Select Channel',...
                    'ToolTipString','Selection of Channel');%%% Popup menus for PIE Channel Selection
                switch PamMeta.BurstData.BAMethod
                    case {1,2,5}
                        Channel_String = {'DD','AA'};
                    case {3,4}
                        Channel_String = {'BB','GG','RR'};
                end
                h.ChannelSelect_Popupmenu = uicontrol(...
                    'Parent',h.PIEChannel_Panel,...
                    'Style','Popupmenu',...
                    'Tag','ChannelSelect_Popupmenu',...
                    'Units','normalized',...
                    'Position',[0.5 0.85 0.4 0.1],...
                    'String',Channel_String,...
                    'Value', 1,...
                    'Callback',@Update_Plots);
                %%% Popup Menu for Fit Method Selection
                %h.FitMethods = {'Single Exponential','Biexponential'};
                %%% checkbox for background estimate inclusion
                h.BackgroundInclusion_checkbox = uicontrol(...
                    'Parent',h.PIEChannel_Panel,...
                    'Style','checkbox',...
                    'Tag','BackgroundInclusion_checkbox',...
                    'Units','normalized',...
                    'BackgroundColor', Look.Back,...
                    'ForegroundColor', Look.Fore,...
                    'Position',[0.05 0.6 0.75 0.1],...
                    'String','Use background estimation',...
                    'ToolTipString','Includes a static scatter contribution into the fit. The contribution is estimated from background countrate and burst duration.',...
                    'Value',1,...
                    'Callback',[]);
                %%% checkbox to include the channel in lifetime fitting
                h.IncludeChannel_checkbox = uicontrol(...
                    'Parent',h.PIEChannel_Panel,...
                    'Style','checkbox',...
                    'Tag','IncludeChannel_checkbox',...
                    'Units','normalized',...
                    'BackgroundColor', Look.Back,...
                    'ForegroundColor', Look.Fore,...
                    'Position',[0.55 0.6 0.75 0.1],...
                    'String','fit channel',...
                    'ToolTipString','Include the channel during burstwise fitting.',...
                    'Value',UserValues.TauFit.IncludeChannel(1),...
                    'Callback',@IncludeChannel);
                %%% Button tostart fitting
                h.BurstWiseFit_Button = uicontrol(...
                    'Parent',h.PIEChannel_Panel,...
                    'Style','pushbutton',...
                    'Tag','BurstWiseFit_Button',...
                    'Units','normalized',...
                    'BackgroundColor', Look.Control,...
                    'ForegroundColor', Look.Fore,...
                    'Position',[0.05 0.05 0.5 0.12],...
                    'String','Burstwise Fit',...
                    'ToolTipString','Perform the burstwise fitting (sliders should be correct!',...
                    'Callback',@BurstWise_Fit);
               %%% hide the ignore slider, we don't need it for burstwise fitting
                set([h.Ignore_Slider,h.Ignore_Edit,h.Ignore_Text],'Visible','off');
                for i = 1:3
                    UserValues.TauFit.Ignore{i} = 1;
                end
                set(h.Determine_GFactor_Button,'Visible','off');
                %%% add checkbox for saving images of fit arrangement
                h.Save_Figures = uicontrol(...
                    'Parent',h.PIEChannel_Panel,...
                    'style','checkbox',...
                    'units','normalized',...
                    'BackgroundColor', Look.Back,...
                    'ForegroundColor', Look.Fore,...
                    'Callback',@UpdateOptions,...
                    'String','Auto-save images of plots',...
                    'Value',UserValues.BurstSearch.BurstwiseLifetime_SaveImages,...
                    'Position',[0.57,0.02,0.4,0.12]);
                %%% add checkbox for burstwise phasor calculation
                h.Calc_Burstwise_Phasor = uicontrol(...
                    'Parent',h.PIEChannel_Panel,...
                    'style','checkbox',...
                    'units','normalized',...
                    'BackgroundColor', Look.Back,...
                    'ForegroundColor', Look.Fore,...
                    'Callback',@UpdateOptions,...
                    'String','Burst-wise Phasor',...
                    'Value',UserValues.BurstSearch.CalculateBurstwisePhasor,...
                    'Position',[0.57,0.28,0.4,0.12]);
                %%% add popupmenu for selecting the reference for burstwise
                %%% phasor
                h.Select_Burstwise_Phasor_Reference = uicontrol(...
                    'Parent',h.PIEChannel_Panel,...
                    'style','popupmenu',...
                    'units','normalized',...
                    'Callback',@UpdateOptions,...
                    'Visible','off',...
                    'String',{'IRF reference','Lifetime reference'},...
                    'Value',UserValues.BurstSearch.PhasorReference,...
                    'Position',[0.57,0.15,0.4,0.12]);
                if UserValues.BurstSearch.CalculateBurstwisePhasor
                    h.Select_Burstwise_Phasor_Reference.Visible = 'on';
                end
                %%% radio buttons to select the plotted data (decay or
                %%% anisotropy)
                h.ShowDecay_radiobutton = uicontrol('Style','radiobutton',...
                  'Parent',h.PIEChannel_Panel,...
                  'String','Decay',...
                  'Units','normalized',...
                  'Value',1,...
                  'Callback',@Update_Plots,...
                  'ForegroundColor',UserValues.Look.Fore,...
                  'BackgroundColor',UserValues.Look.Back,...
                  'Position',[0.01 0.32 0.27 0.07],...
                  'Visible','off');
                h.ShowDecaySum_radiobutton = uicontrol('Style','radiobutton',...
                  'Parent',h.PIEChannel_Panel,...
                  'String','Decay (Sum)',...
                  'Units','normalized',...
                  'Value',0,...
                  'Callback',@Update_Plots,...
                  'ForegroundColor',UserValues.Look.Fore,...
                  'BackgroundColor',UserValues.Look.Back,...
                  'Position',[0.01 0.25 0.27 0.07],...
                  'Visible','off');
                h.ShowAniso_radiobutton = uicontrol('Style','radiobutton',...
                  'Parent',h.PIEChannel_Panel,...
                  'String','Anisotropy',...
                  'Units','normalized',...
                  'Value',0,...
                  'ForegroundColor',UserValues.Look.Fore,...
                  'BackgroundColor',UserValues.Look.Back,...
                  'Callback',@Update_Plots,...
                  'Position',[0.01 0.18 0.27 0.07],...
                  'Visible','off');
        end
    end
end
%% if strcmp(method,'ensemble')
    %%% this occurs if we either called from PAM or directly from
    %%% command-line (i.e. operating on processed data *.dec files)
    
    %%% Popup menus for PIE Channel Selection
    h.PIEChannelPar_Popupmenu = uicontrol(...
        'Parent',h.PIEChannel_Panel,...
        'Style','Popupmenu',...
        'Tag','PIEChannelPar_Popupmenu',...
        'Units','normalized',...
        'Position',[0.5 0.85 0.4 0.1],...
        'String',UserValues.PIE.Name,...
        'Callback',@Channel_Selection);
    h.PIEChannelPar_Text = uicontrol(...switch
        'Parent',h.PIEChannel_Panel,...
        'Style','Text',...
        'Tag','PIEChannelPar_Text',...
        'Units','normalized',...
        'Position',[0.05 0.85 0.4 0.1],...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'HorizontalAlignment','left',...
        'FontSize',10,...
        'String','Parallel Channel',...
        'ToolTipString','Selection for the Parallel Channel');
    h.PIEChannelPer_Popupmenu = uicontrol(...
        'Parent',h.PIEChannel_Panel,...
        'Style','Popupmenu',...
        'Tag','PIEChannelPer_Popupmenu',...
        'Units','normalized',...
        'Position',[0.5 0.7 0.4 0.1],...
        'String',UserValues.PIE.Name,...
        'Callback',@Channel_Selection);
    h.PIEChannelPer_Text = uicontrol(...
        'Parent',h.PIEChannel_Panel,...
        'Style','Text',...
        'Tag','PIEChannelPer_Text',...
        'Units','normalized',...
        'Position',[0.05 0.7 0.4 0.1],...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'HorizontalAlignment','left',...
        'FontSize',10,...
        'String','Perpendicular Channel',...
        'ToolTipString','Selection for the Perpendicular Channel');

    %%% Set the Popupmenus according to UserValues
    h.PIEChannelPar_Popupmenu.Value = find(strcmp(UserValues.PIE.Name,UserValues.TauFit.PIEChannelSelection{1}));
    h.PIEChannelPer_Popupmenu.Value = find(strcmp(UserValues.PIE.Name,UserValues.TauFit.PIEChannelSelection{2}));
    if isempty(h.PIEChannelPar_Popupmenu.Value)
        h.PIEChannelPar_Popupmenu.Value = 1;
    end
    if isempty(h.PIEChannelPer_Popupmenu.Value)
        h.PIEChannelPer_Popupmenu.Value = 1;
    end
    %%% Popup Menu for Fit Method Selection
    % = {'Single Exponential','Biexponential','Three Exponentials','Four Exponentials','Stretched Exponential',...
    %'Distribution','Distribution plus Donor only','Two Distributions plus Donor only',...
    %'Fit Anisotropy','Fit Anisotropy (2 exp lifetime)','Fit Anisotropy (2 exp rot)',...
    %'Fit Anisotropy (2 exp lifetime, 2 exp rot)','Fit Anisotropy (2 exp lifetime with independent anisotropy)'};
    %%% Button for loading the selected PIE Channels
    h.LoadData_Button = uicontrol(...
        'Parent',h.PIEChannel_Panel,...
        'Style','pushbutton',...
        'Tag','LoadData_Button',...
        'Units','normalized',...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.05 0.52 0.4 0.12],...
        'String','Import Data from PAM',...
        'Callback',@Load_Data);
    %%% Button to start fitting
    h.Fit_Button = uicontrol(...
        'Parent',h.PIEChannel_Panel,...
        'Style','pushbutton',...
        'Tag','Fit_Button',...
        'Units','normalized',...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.35 0.22 0.5 0.12],...
        'String','Perform reconvolution fit',...
        'Callback',@Start_Fit);
    h.Fit_Button_Menu = uicontextmenu;
    %%% Button for Maximum Entropy Method (MEM) analysis
    h.Fit_Button_MEM_Tau = uimenu('Parent',h.Fit_Button_Menu,...
        'Label','MEM analysis (Lifetime Distribution)',...
        'Checked','off',...
        'Callback',@Start_Fit);
        h.Fit_Button_MEM_dist = uimenu('Parent',h.Fit_Button_Menu,...
        'Label','MEM analysis (Distance Distribution)',...
        'Checked','off',...
        'Callback',@Start_Fit);
    h.Fit_Button.UIContextMenu = h.Fit_Button_Menu;
    h.Fit_Button_MEM_Tau.Visible = 'off'; h.Fit_Button_MEM_dist.Visible = 'off';% only turn visible after a fit has been performed
    %%% Button to start tail fitting
    h.Fit_Tail_Button = uicontrol(...
        'Parent',h.PIEChannel_Panel,...
        'Style','pushbutton',...
        'Tag','Fit_Tail_Button',...
        'Units','normalized',...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.05 0.05 0.29 0.12],...
        'String','Perform tail fit',...
        'Callback',@Start_Fit);
    h.Fit_Tail_Menu = uicontextmenu;
    h.Fit_Tail_2exp = uimenu('Parent',h.Fit_Tail_Menu,...
        'Label','2 exponentials',...
        'Checked','off',...
        'Callback',@Start_Fit);
    h.Fit_Tail_3exp = uimenu('Parent',h.Fit_Tail_Menu,...
        'Label','3 exponentials',...
        'Checked','off',...
        'Callback',@Start_Fit);
    h.Fit_Tail_Button.UIContextMenu = h.Fit_Tail_Menu;
    %%% Button to fit Time resolved anisotropy
    h.Fit_Aniso_Button = uicontrol(...
        'Parent',h.PIEChannel_Panel,...
        'Style','pushbutton',...
        'Tag','Fit_Button',...
        'Units','normalized',...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.35 0.05 0.29 0.12],...
        'String','Fit anisotropy',...
        'Callback',@Start_Fit);
    h.Fit_Aniso_Menu = uicontextmenu;
    h.Fit_Aniso_2exp = uimenu('Parent',h.Fit_Aniso_Menu,...
        'Label','2 exponentials',...
        'Checked','off',...
        'Callback',@Start_Fit);
    h.Fit_DipAndRise = uimenu('Parent',h.Fit_Aniso_Menu,...
        'Label','Fit Anisotropy (2 exp lifetime with independent anisotropy)',...
        'Checked','off',...
        'Callback',@Start_Fit);
    h.Fit_Aniso_Button.UIContextMenu = h.Fit_Aniso_Menu;

    %%% radio buttons to select the plotted data (decay or
    %%% anisotropy)
    h.ShowDecay_radiobutton = uicontrol('Style','radiobutton',...
      'Parent',h.PIEChannel_Panel,...
      'String','Decay',...
      'Units','normalized',...
      'Value',1,...
      'Callback',@Update_Plots,...
      'ForegroundColor',UserValues.Look.Fore,...
      'BackgroundColor',UserValues.Look.Back,...
      'Position',[0.01 0.32 0.27 0.07]);
    h.ShowDecaySum_radiobutton = uicontrol('Style','radiobutton',...
      'Parent',h.PIEChannel_Panel,...
      'String','Decay (Sum)',...
      'Units','normalized',...
      'Value',0,...
      'Callback',@Update_Plots,...
      'ForegroundColor',UserValues.Look.Fore,...
      'BackgroundColor',UserValues.Look.Back,...
      'Position',[0.01 0.25 0.27 0.07]);
    h.ShowAniso_radiobutton = uicontrol('Style','radiobutton',...
      'Parent',h.PIEChannel_Panel,...
      'String','Anisotropy',...
      'Units','normalized',...
      'Value',0,...
      'ForegroundColor',UserValues.Look.Fore,...
      'BackgroundColor',UserValues.Look.Back,...
      'Callback',@Update_Plots,...
      'Position',[0.01 0.18 0.27 0.07]);
  
    if strcmp(FCSData.Who,'External')
        %%% hide buttons that relate to loading data from PAM
        h.PIEChannelPar_Popupmenu.Value = 1;
        h.PIEChannelPer_Popupmenu.Value = 1;
        h.PIEChannelPar_Popupmenu.String = {''};
        h.PIEChannelPer_Popupmenu.String = {''};
        h.LoadData_Button.String = 'Plot Selection';
        h.LoadData_Button.Enable = 'off';
        h.Menu.Save_To_Dec.Visible = 'off';
    end
if exist('bh','var')
    if bh.SendToTauFit.equals(obj) || obj == bh.Send_to_TauFit_Button
        FCSData.Who = 'BurstBrowser';
        global BurstMeta BurstData
        % User clicked Send Species to TauFit in BurstBrowser
        % fit a lifetime to the bulk data from selected bursts
        %%% display which species user transferred to TauFit
        h.ChannelSelect_Text = uicontrol(...
            'Parent',h.PIEChannel_Panel,...
            'Style','Text',...
            'Tag','ChannelSelect_Text',...
            'Units','normalized',...
            'Position',[0.05 0.85 0.4 0.1],...
            'BackgroundColor', Look.Back,...
            'ForegroundColor', Look.Fore,...
            'HorizontalAlignment','left',...
            'FontSize',10,...
            'String','Select Channel',...
            'ToolTipString','Selection of Channel');%%% Popup menus for PIE Channel Selection
        switch BurstData{BurstMeta.SelectedFile}.BAMethod
            case {1,2}
                Channel_String = {'DD','AA','DA','Donor only'};
            case {3,4}
                Channel_String = {'BB','GG','RR'};
            case {5}
                Channel_String = {'DD','AA','DA'};
        end
        h.ChannelSelect_Popupmenu = uicontrol(...
            'Parent',h.PIEChannel_Panel,...
            'Style','Popupmenu',...
            'Tag','ChannelSelect_Popupmenu',...
            'Units','normalized',...
            'Position',[0.5 0.85 0.4 0.1],...
            'String',Channel_String,...
            'Value', 1,...
            'Callback',@Update_Plots);
        
        str = ['Selected File: ' BurstData{BurstMeta.SelectedFile}.FileName(1:end-4)];
        if BurstData{BurstMeta.SelectedFile}.SelectedSpecies(1) ~= 0
            TauData.SpeciesName = BurstData{BurstMeta.SelectedFile}.SpeciesNames{BurstData{BurstMeta.SelectedFile}.SelectedSpecies(1),1};
            if BurstData{BurstMeta.SelectedFile}.SelectedSpecies(2) > 1 %%% subspecies selected
                TauData.SpeciesName = [TauData.SpeciesName ' - ' BurstData{BurstMeta.SelectedFile}.SpeciesNames{BurstData{BurstMeta.SelectedFile}.SelectedSpecies(1),BurstData{BurstMeta.SelectedFile}.SelectedSpecies(2)}];
            end
            str = [str, '\nSelected Species: ' TauData.SpeciesName];
        else
            TauData.SpeciesName = BurstData{BurstMeta.SelectedFile}.FileName(1:end-4);
        end
        h.SpeciesSelect_Text = uicontrol('Style','text',...
            'Tag','TauFit_SpeciesSelect_text',...
            'Parent',h.PIEChannel_Panel,...
            'Units','normalized',...
            'Position',[0.025 0.55 0.95 0.28],...
            'HorizontalAlignment','left',...
            'String',sprintf(str),...
            'TooltipString',sprintf(str),...
            'BackgroundColor',Look.Back,...
            'ForegroundColor',Look.Fore,...
            'FontSize',10);
        %%% Button to start fitting
        h.Fit_Button = uicontrol(...
            'Parent',h.PIEChannel_Panel,...
            'Style','pushbutton',...
            'Tag','Fit_Button',...
            'Units','normalized',...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.38 0.25 0.5 0.12],...
            'String','Perform reconvolution fit',...
            'Callback',@Start_Fit);
        h.Fit_Button_Menu = uicontextmenu;
        %%% Button for Maximum Entropy Method (MEM) analysis
        h.Fit_Button_MEM_Tau = uimenu('Parent',h.Fit_Button_Menu,...
            'Label','MEM analysis (Lifetime Distribution)',...
            'Checked','off',...
            'Callback',@Start_Fit);
        h.Fit_Button_MEM_dist = uimenu('Parent',h.Fit_Button_Menu,...
            'Label','MEM analysis (Distance Distribution)',...
            'Checked','off',...
            'Callback',@Start_Fit);
        h.Fit_Button.UIContextMenu = h.Fit_Button_Menu;
        h.Fit_Button_MEM_Tau.Visible = 'off'; h.Fit_Button_MEM_dist.Visible = 'off'; % only turn visible after a fit has been performed
        %%% Button to start tail fitting
        h.Fit_Tail_Button = uicontrol(...
            'Parent',h.PIEChannel_Panel,...
            'Style','pushbutton',...
            'Tag','Fit_Tail_Button',...
            'Units','normalized',...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.05 0.05 0.29 0.12],...
            'String','Perform tail fit',...
            'Callback',@Start_Fit);
        h.Fit_Tail_Menu = uicontextmenu;
        h.Fit_Tail_2exp = uimenu('Parent',h.Fit_Tail_Menu,...
            'Label','2 exponentials',...
            'Checked','off',...
            'Callback',@Start_Fit);
        h.Fit_Tail_3exp = uimenu('Parent',h.Fit_Tail_Menu,...
            'Label','3 exponentials',...
            'Checked','off',...
            'Callback',@Start_Fit);
        h.Fit_Tail_Button.UIContextMenu = h.Fit_Tail_Menu;
        %%% Button to fit Time resolved anisotropy
        h.Fit_Aniso_Button = uicontrol(...
            'Parent',h.PIEChannel_Panel,...
            'Style','pushbutton',...
            'Tag','Fit_Button',...
            'Units','normalized',...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.35 0.05 0.29 0.12],...
            'String','Fit anisotropy',...
            'Callback',@Start_Fit);
        h.Fit_Aniso_Menu = uicontextmenu;
        h.Fit_Aniso_2exp = uimenu('Parent',h.Fit_Aniso_Menu,...
            'Label','2 exponentials',...
            'Checked','off',...
            'Callback',@Start_Fit);
        h.Fit_DipAndRise = uimenu('Parent',h.Fit_Aniso_Menu,...
            'Label','Fit Anisotropy (2 exp lifetime with independent anisotropy)',...
            'Checked','off',...
            'Callback',@Start_Fit);
        h.Fit_Aniso_Button.UIContextMenu = h.Fit_Aniso_Menu;
        
        %%% Dropdown menu to select source of donor-only reference
        %%% (either from stored reference or taken from the burst data)
        h.DonorOnlyReference_Text = uicontrol('Style','text',...
            'Tag','TauFit_SpeciesSelect_text',...
            'Parent',h.PIEChannel_Panel,...
            'Units','normalized',...
            'Position',[0.65 0.15 0.35 0.1],...
            'HorizontalAlignment','left',...
            'String','Donor-only reference:',...
            'BackgroundColor',Look.Back,...
            'ForegroundColor',Look.Fore,...
            'Visible','off',...
            'FontSize',8);
        h.DonorOnlyReference_Popupmenu = uicontrol(...
            'Parent',h.PIEChannel_Panel,...
            'Style','Popupmenu',...
            'Tag','DonorOnlyReference_Popupmenu',...
            'Units','normalized',...
            'Position',[0.65 0.1 0.35 0.05],...
            'String',{'DOnly population','Stored reference'},...
            'Value', UserValues.TauFit.DonorOnlyReferenceSource,...
            'Visible','off',...
            'FontSize',8,...
            'Callback',@UpdateOptions);
        
        %%% radio buttons to select the plotted data (decay or
        %%% anisotropy)
        h.ShowDecay_radiobutton = uicontrol('Style','radiobutton',...
          'Parent',h.PIEChannel_Panel,...
          'String','Decay',...
          'Units','normalized',...
          'Value',1,...
          'Callback',@Update_Plots,...
          'ForegroundColor',UserValues.Look.Fore,...
          'BackgroundColor',UserValues.Look.Back,...
          'Position',[0.01 0.32 0.27 0.07]);
        h.ShowDecaySum_radiobutton = uicontrol('Style','radiobutton',...
          'Parent',h.PIEChannel_Panel,...
          'String','Decay (Sum)',...
          'Units','normalized',...
          'Value',0,...
          'Callback',@Update_Plots,...
          'ForegroundColor',UserValues.Look.Fore,...
          'BackgroundColor',UserValues.Look.Back,...
          'Position',[0.01 0.25 0.27 0.07]);
        h.ShowAniso_radiobutton = uicontrol('Style','radiobutton',...
          'Parent',h.PIEChannel_Panel,...
          'String','Anisotropy',...
          'Units','normalized',...
          'Value',0,...
          'ForegroundColor',UserValues.Look.Fore,...
          'BackgroundColor',UserValues.Look.Back,...
          'Callback',@Update_Plots,...
          'Position',[0.01 0.18 0.27 0.07]);
        
        set(h.Determine_GFactor_Button,'Visible','off');
        
        if any(TauData.BAMethod == [1,2])
            %%% Add menu for Kappa2 simulation
            h.Menu.Extra_Menu = uimenu(h.TauFit,'Label','Extra...');
            h.Menu.Sim_Kappa2_Menu = uimenu(h.Menu.Extra_Menu,'Label','Simulate Kappa2 distribution','Callback',@Kappa2_Sim);
        end
    end
end
h.FitMethod_Popupmenu = uicontrol(...
    'Parent',h.PIEChannel_Panel,...
    'Style','Popupmenu',...
    'Tag','FitMethod_Popupmenu',...
    'Units','normalized',...
    'Position',[0.27 0.4 0.72 0.095],...
    'String',h.FitMethods,...
    'Callback',@Method_Selection);


h.FitMethod_Text = uicontrol(...
    'Parent',h.PIEChannel_Panel,...
    'Style','Text',...
    'Tag','FitMethod_Text',...
    'Units','normalized',...
    'Position',[0.01 0.4 0.25 0.095],...
    'BackgroundColor', Look.Back,...
    'ForegroundColor', Look.Fore,...
    'HorizontalAlignment','left',...
    'FontSize',10,...
    'String','Model Function:',...
    'ToolTipString','Select the Model Function');


%% %% %% %%% Edit Boxes for Correction Factors

h.GFactor_Tab = uitab(...
    'Parent',h.FitParams_Tab,...
    'Title','G Factor',...
    'Tag','Settings_Tab');


h.GFactor_Panel = uibuttongroup(...
    'Parent',h.GFactor_Tab,...
    'Units','normalized',...
    'BackgroundColor',Look.Back,...
    'ForegroundColor',Look.Back,...
    'HighlightColor',Look.Control,...
    'ShadowColor',Look.Shadow,...
    'Position',[0 0 1 1],...
    'Tag','FitPar_Panel');

h.G_factor_text = uicontrol(...
    'Parent',h.GFactor_Panel,...
    'Style','text',...
    'Units','normalized',...
    'Position',[0.05 0.9 0.35 0.07],...
    'String','G Factor',...
    'FontSize',10,...
    'BackgroundColor', Look.Back,...
    'ForegroundColor', Look.Fore,...
    'HorizontalAlignment','left',...
    'Tag','G_factor_text');

h.G_factor_edit = uicontrol(...
    'Parent',h.GFactor_Panel,...
    'Style','edit',...
    'Units','normalized',...
    'Position',[0.17 0.9 0.2 0.07],...
    'String','1',...
    'FontSize',10,...
    'Tag','G_factor_edit',...
    'Callback',@UpdateOptions);

h.l1_text = uicontrol(...
    'Parent',h.GFactor_Panel,...
    'Style','text',...
    'Units','normalized',...
    'Position',[0.05 0.8 0.35 0.06],...
    'String','l1',...
    'FontSize',10,...
    'BackgroundColor', Look.Back,...
    'ForegroundColor', Look.Fore,...
    'HorizontalAlignment','left',...
    'Tag','l1_text');

h.l1_edit = uicontrol(...
    'Parent',h.GFactor_Panel,...
    'Style','edit',...
    'Units','normalized',...
    'Position',[0.17 0.8 0.2 0.06],...
    'String',num2str(UserValues.TauFit.l1),...
    'FontSize',10,...
    'Tag','l1_edit',...
    'Callback',@UpdateOptions);

h.l2_text = uicontrol(...
    'Parent',h.GFactor_Panel,...
    'Style','text',...
    'Units','normalized',...
    'Position',[0.05 0.7 0.35 0.06],...
    'String','l2',...
    'FontSize',10,...
    'BackgroundColor', Look.Back,...
    'ForegroundColor', Look.Fore,...
    'HorizontalAlignment','left',...
    'Tag','l2_text');

h.l2_edit = uicontrol(...
    'Parent',h.GFactor_Panel,...
    'Style','edit',...
    'Units','normalized',...
    'Position',[0.17 0.7 0.2 0.06],...
    'String',num2str(UserValues.TauFit.l2),...
    'FontSize',10,...
    'Tag','l2_edit',...
    'Callback',@UpdateOptions);

h.Output_Panel = uibuttongroup(...
    'Parent',h.GFactor_Panel,...
    'Units','normalized',...
    'Position',[0.4 0 0.6 1],...
    'Title','Status message',...
    'FontSize',10,...
    'BackgroundColor', Look.Back,...
    'ForegroundColor', Look.Fore,...
    'Tag','Output_Panel');

ToolTip_average_lifetime = '<html><b>Mean Lifetime Fraction</b> is the amplitude-weighted average lifetime, given by:<br>&lt;&tau;&gt;<sub>amp</sub> = &Sigma;&alpha;<sub>i</sub>&tau;<sub>i</sub>, where &alpha; is the amplitude.<br><b>Mean Lifetime Int</b> is the intensity-weighted average lifetime.<br>Every lifetime species is weighted by the intensity fraction given by:<br>f<sub>i</sub>= &alpha;<sub>i</sub>&tau;<sub>i</sub>/&Sigma;&alpha;<sub>j</sub>&tau;<sub>j</sub><br>i.e.&lt;&tau;&gt;<sub>int</sub> = &Sigma;f<sub>i</sub>&tau;<sub>i</sub></html>';
h.Output_Text = uicontrol(...
    'Parent',h.Output_Panel,...
    'Style','text',...
    'Units','normalized',...
    'Position',[0 0 1 1],...
    'String','',...
    'FontSize',9,...
    'BackgroundColor', Look.Back,...
    'ForegroundColor', Look.Fore,...
    'TooltipString',ToolTip_average_lifetime,...
    'HorizontalAlignment','left',...
    'Tag','Output_Text');


%% Plotting style tab %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %%% Tab for fit function inputs
    h.Style_Tab= uitab(...
        'Parent',h.FitParams_Tab,...
        'Tag','Style_Tab',...
        'Title','Plotting style');    
    %%% Panel for fit function inputs
    h.Style_Panel = uibuttongroup(...
        'Parent',h.Style_Tab,...
        'Tag','Style_Panel',...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'HighlightColor', Look.Control,...
        'ShadowColor', Look.Shadow,...
        'Position',[0 0 1 1]);
    
    %%% Fitting table
    h.Style_Table_Menu = uicontextmenu;
    h.Style_Table_Autocolor = uimenu('Parent',h.Style_Table_Menu,'Label','Autocolor',...
        'Callback',{@Update_Style,3});
    h.Style_Table_Rainbow = uimenu('Parent',h.Style_Table_Menu,'Label','Use Rainbow',...
        'Callback',{@Update_Style,3});
    h.Style_Table = uitable(...
        'Parent',h.Style_Panel,...
        'Tag','Fit_Table',...
        'Units','normalized',...
        'ForegroundColor',Look.TableFore,...
        'BackgroundColor',[Look.Table1;Look.Table2],...
        'FontSize',8,...
        'Position',[0 0 1 1],...
        'CellEditCallback',{@Update_Style,2},...
        'CellSelectionCallback',{@Update_Style,2},...
        'UIContextMenu',h.Style_Table_Menu);
    %% File History tab %%%%%%%%%%%%%%%%
    h.Fit_Function_Tab= uitab(...
        'Parent',h.FitParams_Tab,...
        'Tag','Fit_Function_Tab',...
        'Title','File History');
    h.FileHistory = FileHistory(h.Fit_Function_Tab,'FCSFit',@(x) Load_Cor('FileHistory',[],1,x));
%% %% Main Plots %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %%% Panel for fit plots
    h.Fit_Plots_Panel = uibuttongroup(...
        'Parent',h.FCSFit,...
        'Tag','Fit_Plots_Panel',...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'HighlightColor', Look.Control,...
        'ShadowColor', Look.Shadow,...
        'Position',[0.005 0.26 0.99 0.73]);
    
    %%% Right-click menu for plot changes
h.Microtime_Plot_Menu_MIPlot = uicontextmenu;
h.Microtime_Plot_ChangeYScaleMenu_MIPlot = uimenu(...
    h.Microtime_Plot_Menu_MIPlot,...
    'Label','Y Logscale',...
    'Checked', UserValues.TauFit.YScaleLog,...
    'Tag','Plot_YLogscale_MIPlot',...
    'Callback',@ChangeScale);
h.Microtime_Plot_ChangeXScaleMenu_MIPlot = uimenu(...
    h.Microtime_Plot_Menu_MIPlot,...
    'Label','X Logscale',...
    'Checked', UserValues.TauFit.XScaleLog,...
    'Tag','Plot_XLogscale_MIPlot',...
    'Callback',@ChangeScale);

h.Microtime_Plot_Export = uimenu(...
    h.Microtime_Plot_Menu_MIPlot,...
    'Label','Export Plot',...
    'Tag','Microtime_Plot_Export',...
    'Callback',@ExportGraph);

h.Microtime_Plot_Menu_ResultPlot = uicontextmenu;
h.Microtime_Plot_ChangeYScaleMenu_ResultPlot = uimenu(...
    h.Microtime_Plot_Menu_ResultPlot,...
    'Label','Y Logscale',...
    'Tag','Plot_YLogscale_ResultPlot',...
    'Callback',@ChangeScale);
h.Microtime_Plot_ChangeXScaleMenu_ResultPlot = uimenu(...
    h.Microtime_Plot_Menu_ResultPlot,...
    'Label','X Logscale',...
    'Tag','Plot_XLogscale_ResultPlot',...
    'Callback',@ChangeScale);
h.Export_Result = uimenu(...
    h.Microtime_Plot_Menu_ResultPlot,...
    'Label','Export Plot',...
    'Tag','Export_Result',...
    'Callback',@ExportGraph);

%%% Main Microtime Plot
h.Microtime_Plot = axes(...
    'Parent',h.Fit_Plots_Panel,...
    'Units','normalized',...
    'Position',[0.075 0.075 0.9 0.775],...
    'Tag','Microtime_Plot',...
    'XColor',Look.Fore,...
    'YColor',Look.Fore,...
    'Box','on',...
    'UIContextMenu',h.Microtime_Plot_Menu_MIPlot);

%%% Create Graphs
hold on;
h.Plots.Scat_Sum = plot([0 1],[0 0],'.r','Color',[0.5 0.5 0.5],'MarkerSize',5,'DisplayName','Scatter (sum)');
h.Plots.Scat_Par = plot([0 1],[0 0],'LineStyle',':','Color',[0.5 0.5 0.5],'LineWidth',1,'DisplayName','Scatter (par)');
h.Plots.Scat_Per = plot([0 1],[0 0],'LineStyle',':','Color',[0.3 0.3 0.3],'LineWidth',1,'DisplayName','Scatter (perp)');
h.Plots.Decay_Sum = plot([0 1],[0 0],'-k','LineWidth',1,'DisplayName','Decay (sum)');
h.Plots.Decay_Par = plot([0 1],[0 0],'Color',[0.8510,0.3294,0.1020],'LineWidth',1,'DisplayName','Decay (par)');
h.Plots.Decay_Per = plot([0 1],[0 0],'Color',[0,0.4510,0.7412],'LineWidth',1,'DisplayName','Decay (perp)');
h.Plots.IRF_Sum = plot([0 1],[0 0],'.r','Color',[0,0.4510,0.7412],'MarkerSize',5,'DisplayName','IRF (sum)');
h.Plots.IRF_Par = plot([0 1],[0 0],'.r','MarkerSize',5,'DisplayName','IRF (par)');
h.Plots.IRF_Per = plot([0 1],[0 0],'.b','MarkerSize',5,'DisplayName','IRF (perp)');
h.Ignore_Plot = plot([0 0],[1e-6 1],'Color','k','Visible','off','LineWidth',1,'DisplayName','Decay (ignore)');
h.Plots.Aniso_Preview = plot([0 1],[0 0],'-k','LineWidth',1,'DisplayName','Anisotropy');
h.Microtime_Plot.XLim = [0 1];
h.Microtime_Plot.YLim = [0 1];
h.Microtime_Plot.XLabel.Color = Look.Fore;
h.Microtime_Plot.XLabel.String = 'Time [ns]';
h.Microtime_Plot.YLabel.Color = Look.Fore;
h.Microtime_Plot.YLabel.String = 'Intensity [counts]';
h.Microtime_Plot.XGrid = 'on';
h.Microtime_Plot.YGrid = 'on';

%%% Residuals Plot
h.Residuals_Plot = axes(...
    'Parent',h.Fit_Plots_Panel,...
    'Units','normalized',...
    'Position',[0.075 0.85 0.9 0.12],...
    'Tag','Residuals_Plot',...
    'XColor',Look.Fore,...
    'YColor',Look.Fore,...
    'XTickLabel',[],...
    'Box','on');
hold on;
h.Plots.Residuals = plot([0 1],[0 0],'-k','LineWidth',1);
h.Plots.Residuals_ignore = plot([0 1],[0 0],'LineStyle','--','Color',[0.4 0.4 0.4],'Visible','off','LineWidth',1);
h.Plots.Residuals_Perp = plot([0 1],[0 0],'-b','Visible','off','LineWidth',1);
h.Plots.Residuals_Perp_ignore = plot([0 1],[0 0],'LineStyle','--','Color',[0 0 0.4],'Visible','off','LineWidth',1);

h.Plots.Residuals_ZeroLine = plot([0 1],[0 0],'-k','Visible','off','LineWidth',1);
h.Residuals_Plot.YLabel.Color = Look.Fore;
h.Residuals_Plot.YLabel.String = 'w_{res}';
h.Residuals_Plot.XGrid = 'on';
h.Residuals_Plot.YGrid = 'on';

%%% Result Plot (Replaces Microtime Plot after fit is done)
h.Result_Plot = axes(...
    'Parent',h.Fit_Plots_Panel,...
    'Units','normalized',...
    'Position',[0.075 0.075 0.9 0.775],...
    'Tag','Microtime_Plot',...
    'XColor',Look.Fore,...
    'YColor',Look.Fore,...
    'Box','on',...
    'Visible','on',...
    'UIContextMenu',h.Microtime_Plot_Menu_ResultPlot);
h.Result_Plot_Text = text(...
    0,0,'',...
    'Parent',h.Result_Plot,...
    'FontSize',10,...
    'FontWeight','bold',...
    'BackgroundColor','none',...
    'Units','normalized',...
    'Color',Look.AxesFore,...
    'BackgroundColor',Look.Axes,...
    'VerticalAlignment','top','HorizontalAlignment','left');

h.Result_Plot.XLim = [0 1];
h.Result_Plot.YLim = [0 1];
h.Result_Plot.XLabel.Color = Look.Fore;
h.Result_Plot.XLabel.String = 'Time [ns]';
h.Result_Plot.YLabel.Color = Look.Fore;
h.Result_Plot.YLabel.String = 'Intensity [counts]';
h.Result_Plot.XGrid = 'on';
h.Result_Plot.YGrid = 'on';
h.Result_Plot_Text.Position = [0.8 0.9];
hold on;
h.Plots.IRFResult = plot([0 1],[0 0],'LineStyle','none','Marker','.','Color',[0.6 0.6 0.6],'LineWidth',1,'MarkerSize',8,'DisplayName','IRF');
h.Plots.IRFResult_Perp = plot([0 1],[0 0],'LineStyle','none','Marker','.','Color',[0 0 0.6],'Visible','off','LineWidth',1,'MarkerSize',5,'DisplayName','IRF (perp)');
h.Plots.DecayResult = plot([0 1],[0 0],'-k','LineWidth',1,'DisplayName','Decay','MarkerSize',8);
h.Plots.DecayResult_ignore = plot([0 1],[0 0],'LineStyle','--','Color',[0.4 0.4 0.4],'Visible','off','LineWidth',1,'DisplayName','Decay (ignore)','MarkerSize',8);
h.Plots.DecayResult_Perp = plot([0 1],[0 0],'LineStyle','-','Color',[0 0.4471 0.7412],'Visible','off','LineWidth',1,'DisplayName','Decay (perp)','MarkerSize',8);
h.Plots.DecayResult_Perp_ignore = plot([0 1],[0 0],'LineStyle','--','Color',[0 0.2 0.375],'Visible','off','LineWidth',1,'DisplayName','Decay (ignore perp)','MarkerSize',8);
h.Plots.FitResult = plot([0 1],[0 0],'r','LineWidth',2,'DisplayName','Fit');
h.Plots.FitResult_ignore = plot([0 1],[0 0],'--r','Visible','off','LineWidth',2,'DisplayName','Fit (ignore)');
h.Plots.FitResult_Perp = plot([0 1],[0 0],'b','LineWidth',2,'Visible','off','DisplayName','Fit (perp)');
h.Plots.FitResult_Perp_ignore = plot([0 1],[0 0],'--b','Visible','off','LineWidth',2,'DisplayName','Fit (ignore perp)');

%%% Result Plot (Replaces Microtime Plot after fit is done)
h.Result_Plot_Aniso = axes(...
    'Parent',h.Fit_Plots_Panel,...
    'Units','normalized',...
    'Position',[0.075 0.075 0.9 0.775],...
    'Tag','Result_Plot_Aniso',...
    'XColor',Look.Fore,...
    'YColor',Look.Fore,...
    'Box','on',...
    'Visible','on');

h.Result_Plot_Aniso.XLim = [0 1];
h.Result_Plot_Aniso.YLim = [0 1];
h.Result_Plot_Aniso.XLabel.Color = Look.Fore;
h.Result_Plot_Aniso.XLabel.String = 'Time [ns]';
h.Result_Plot_Aniso.YLabel.Color = Look.Fore;
h.Result_Plot_Aniso.YLabel.String = 'Anisotropy';
h.Result_Plot_Aniso.XGrid = 'on';
h.Result_Plot_Aniso.YGrid = 'on';
hold on;
h.Plots.AnisoResult = plot([0 1],[0 0],'-k','LineWidth',1,'DisplayName','Anisotropy','MarkerSize',10);
h.Plots.AnisoResult_ignore = plot([0 1],[0 0],'LineStyle','--','Color',[0.4 0.4 0.4],'LineWidth',1,'DisplayName','Anisotropy (ignore)','MarkerSize',10);
h.Plots.FitAnisoResult = plot([0 1],[0 0],'-r','LineWidth',2,'DisplayName','Fit');
h.Plots.FitAnisoResult_ignore = plot([0 1],[0 0],'--r','LineWidth',2,'DisplayName','Fit (ignore)');

linkaxes([h.Result_Plot, h.Residuals_Plot],'x');

%%% dummy panel to hide plots
h.HidePanel = uibuttongroup(...
    'Visible','off',...
    'Parent',h.Fit_Plots_Panel,...
    'Tag','HidePanel');

%%% Hide Result Plot and Result Aniso Plot
h.Result_Plot.Parent = h.HidePanel;
h.Result_Plot_Aniso.Parent = h.HidePanel;

if strcmp(h.Microtime_Plot_ChangeYScaleMenu_MIPlot.Checked,'on')
    h.Microtime_Plot.YScale = 'log';
    h.Result_Plot.YScale = 'log';
    %h.Result_Plot_Aniso.YScale = 'log';
end
if strcmp(h.Microtime_Plot_ChangeXScaleMenu_MIPlot.Checked,'on')
    h.Microtime_Plot.XScale = 'log';
    h.Result_Plot.XScale = 'log';
    %h.Result_Plot_Aniso.YScale = 'log';
end
%% Mac upscaling of Font Sizes
if ismac
    scale_factor = 1.2;
    fields = fieldnames(h); %%% loop through h structure
    for i = 1:numel(fields)
        if isprop(h.(fields{i}),'FontSize')
            h.(fields{i}).FontSize = (h.(fields{i}).FontSize)*scale_factor;
        end
        if isprop(h.(fields{i}),'Style')
            if strcmp(h.(fields{i}).Style,'popupmenu')
                h.(fields{i}).BackgroundColor = [1 1 1];
                h.(fields{i}).ForegroundColor = [0 0 0];
            end
        end
    end   
end
    
%% Initializes global variables %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    FCSData=[];
    FCSData.Data=[];
    FCSData.FileName=[];
    FCSMeta=[];
    FCSMeta.Data=[];
    FCSMeta.Params=[];
    FCSMeta.Confidence_Intervals = cell(1,1);
    FCSMeta.Plots=cell(0);
    FCSMeta.Model=[];
    FCSMeta.Fits=[];
    FCSMeta.Color=[1 1 0; 0 0 1; 1 0 0; 0 0.5 0; 1 0 1; 0 1 1];
    FCSMeta.FitInProgress = 0;    
    FCSMeta.DataType = 'FCS averaged';
    
    h.CurrentGui = 'FCS';
    guidata(h.FCSFit,h); 
    Load_Fit([],[],0);
     
else
    figure(h.FCSFit); % Gives focus to Pam figure  
end



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Function to load .cor files %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function Load_Cor(obj,~,~,mode,filenames)
global UserValues FCSData FCSMeta
h = guidata(findobj('Tag','FCSFit'));

if nargin > 3 %%% called from file history
    %%% only implemented for loading of *.mcor files at the moment, remove
    %%% all other files
    Type = 1;
    %%% split filenames into FileName and pathname
    for j = 1:numel(filenames)
        [PathName{j},FileName{j},ext] = fileparts(filenames{j});
        FileName{j} = [FileName{j} ext];
    end
else
    %%% there is an issue with selecting multiple files on MacOS Catalina,
    %%% where only the first filter (.mcor) works, and no other file types 
    %%% can be selected.
    %%% As a workaround, we avoid using the system file selection for now.
    %%% 11/2019    
    if ~ismac | ~(ismac & strcmp(get_macos_version(),'10.15'))
        %%% Choose files to load
        [FileName,path,Type] = uigetfile({'*.dec','Pam decay file (*.dec)'},...
                                          'Choose GlobalTau data files',...
                                          UserValues.File.FCSPath,... 
                                          'MultiSelect', 'on');
    else
        %%% use workaround
        %%% Choose files to load
        [FileName, path, Type] = uigetfile_with_preview({'*.dec','Pam decay file (*.dec)'},...
                                          UserValues.File.FCSPath,... 
                                          '',... % empty callback
                                          true); % Multiselect on
    end
    %%% Tranforms to cell array, if only one file was selected
    if ~iscell(FileName)
        FileName = {FileName};
    end
    %%% assign path to each filename
    for j = 1:numel(FileName)
        PathName{j} = path;
    end
end


%%% Only esecutes, if at least one file was selected
if all(FileName{1}==0)
    return
end

%%% Saves pathname to uservalues
UserValues.File.FCSPath=PathName{1};
LSUserValues(1);
%%% Deletes loaded data

    FCSData=[];
    FCSData.Data=[];
    FCSData.FileName=[];
    cellfun(@delete,FCSMeta.Plots);
    FCSMeta.Data=[];
    FCSMeta.Params=[];
    FCSMeta.Plots=cell(0);
    %h.Fit_Table.RowName(1:end-3)=[];
    h.Fit_Table.Data(1:end-3,:)=[];
    h.Style_Table.RowName(1:end-1,:)=[];
    h.Style_Table.Data(1:end-1,:)=[];

                    FCSData.External = struct;
                    FCSData.External.MI_Hist = {};
                    FCSData.External.IRF = {};
                    FCSData.External.Scat = {};
                    
if obj == h.LoadCor
        for j=1:numel(FileName)              
                 %%% read other data
                 decay_data = dlmread(fullfile(path,FileName{j}),'\t',6,0);
                 fid = fopen(fullfile(path,FileName{j}),'r');
                 TAC = textscan(fid,'TAC range [ns]:\t%f\n'); FCSData.Data.TACRange = TAC{1}*1E-9;
                 MI_Bins = textscan(fid,'Microtime Bins:\t%f\n'); FCSData.Data.MI_Bins = MI_Bins{1};
                 TACChannelWidth = textscan(fid,'Resolution [ps]:\t%f\n'); FCSData.TACChannelWidth = TACChannelWidth{1}*1E-3;
                 fid = fopen(fullfile(path,FileName{j}),'r');
               for j = 1:5
                   line = fgetl(fid);
               end
               PIEchans{j} = strsplit(line,'\t');
               PIEchans{j}(cellfun(@isempty,PIEchans{j})) = [];
                if numel(FileName) > 1 %%% multiple files loaded, append the file name to avoid confusion of identically named PIE channels
                   for i = 1:numel(PIEchans{j})
                       PIEchans{j}{i} = [PIEchans{j}{i} ' - ' FileName{j}(1:end-4)];
                   end
               end
              %%% sort data into TauFitData structure (MI,IRF,Scat)
              
               for i = 1:(size(decay_data,2)/3)
                   FCSData.External.MI_Hist{end+1} = decay_data(:,3*(i-1)+1);
                   FCSData.External.IRF{end+1} = decay_data(:,3*(i-1)+2);
                   FCSData.External.Scat{end+1} = decay_data(:,3*(i-1)+3);
               end
               PIEchans = horzcat(PIEchans{:});
                    %%% update PIE channel selection with available PIE channels
                    h.PIEChannelPar_Popupmenu.String = PIEchans;
                    h.PIEChannelPer_Popupmenu.String = PIEchans;
                    %%% mark TauFit mode as external
                    FCSData.Who = 'External';
                    FCSData.FileName = fullfile(path,FileName{1});
                    if numel(PIEchans) == 1
                        PIEChannel_Par = 1; PIEChannel_Per = 1;
                    else
                        PIEChannel_Par = 1; PIEChannel_Per = 2;
                    end
                    h.PIEChannelPar_Popupmenu.Value = PIEChannel_Par;
                    h.PIEChannelPer_Popupmenu.Value = PIEChannel_Per;  
                    
            FCSData.FileName = FileName{1};
        end
end
        

        
%%% set the channel variable
    chan = 4; FCSData.chan = chan; 
             
%%% Microtime Histograms
    FCSData.hMI_Par{chan} = FCSData.External.MI_Hist{PIEChannel_Par};
    FCSData.hMI_Per{chan} = FCSData.External.MI_Hist{PIEChannel_Per};

%%% Read out the Microtime Histograms of the IRF for the two channels
    FCSData.hIRF_Par{chan} = FCSData.External.IRF{PIEChannel_Par}';
    FCSData.hIRF_Per{chan} = FCSData.External.IRF{PIEChannel_Per}';
%%% Normalize IRF for better Visibility
    FCSData.hIRF_Par{chan} = (FCSData.hIRF_Par{chan}./max(FCSData.hIRF_Par{chan})).*max(FCSData.hMI_Par{chan});
    FCSData.hIRF_Per{chan} = (FCSData.hIRF_Per{chan}./max(FCSData.hIRF_Per{chan})).*max(FCSData.hMI_Per{chan});
%%% Read out the Microtime Histograms of the Scatter Measurement for the two channels
    FCSData.hScat_Par{chan} = FCSData.External.Scat{PIEChannel_Par}';
    FCSData.hScat_Per{chan} = FCSData.External.Scat{PIEChannel_Per}';
%%% Normalize Scatter for better Visibility
    if ~(sum(FCSData.hScat_Par{chan})==0)
        FCSData.hScat_Par{chan} = (FCSData.hScat_Par{chan}./max(FCSData.hScat_Par{chan})).*max(FCSData.hMI_Par{chan});
    end
    if ~(sum(FCSData.hScat_Per{chan})==0)
        FCSData.hScat_Per{chan} = (FCSData.hScat_Per{chan}./max(FCSData.hScat_Per{chan})).*max(FCSData.hMI_Per{chan});
    end
%%% Generate XData
    FCSData.XData_Par{chan} = 1:numel(FCSData.hMI_Par{chan});%ToFromPar - ToFromPar(1);
    FCSData.XData_Per{chan} = 1:numel(FCSData.hMI_Per{chan});%ToFromPer - ToFromPer(1);
    
%%% Update PIEchannelSelection
    UserValues.TauFit.PIEChannelSelection{1} = h.PIEChannelPar_Popupmenu.String{h.PIEChannelPar_Popupmenu.Value};
    UserValues.TauFit.PIEChannelSelection{2} = h.PIEChannelPer_Popupmenu.String{h.PIEChannelPer_Popupmenu.Value};        

%%% disable reconvolution fitting if no IRF is defined
if all(isnan(FCSData.hIRF_Par{chan})) || all(isnan(FCSData.hIRF_Per{chan}))
    disp('IRF undefined, disabling reconvolution fitting.');
    h.Fit_Button.Enable = 'off';
elseif all(isnan(FCSData.hScat_Par{chan})) || all(isnan(FCSData.hScat_Per{chan}))
    disp('Scatter pattern undefined, using IRF instead.');
    FCSData.hScat_Par{chan} = FCSData.hIRF_Par{chan};
    FCSData.hScat_Per{chan} = FCSData.hIRF_Per{chan};
else
    h.Fit_Button.Enable = 'on';
end

%%% fix wrong length of IRF or Scatter pattern
len = numel(FCSData.hMI_Par{chan});
if numel(FCSData.hIRF_Par{chan}) < len
    FCSData.hIRF_Par{chan} = [FCSData.hIRF_Par{chan},zeros(1,len-numel(FCSData.hIRF_Par{chan}))];
elseif numel(FCSData.hIRF_Par{chan}) > len
    FCSData.hIRF_Par{chan} = FCSData.hIRF_Par{chan}(1:len);
end
if numel(FCSData.hIRF_Per{chan}) < len
    FCSData.hIRF_Per{chan} = [FCSData.hIRF_Per{chan},zeros(1,len-numel(FCSData.hIRF_Per{chan}))];
elseif numel(FCSData.hIRF_Per{chan}) > len
    FCSData.hIRF_Per{chan} = FCSData.hIRF_Per{chan}(1:len);
end
if numel(FCSData.hScat_Par{chan}) < len
    FCSData.hScat_Par{chan} = [FCSData.hScat_Par{chan},zeros(1,len-numel(FCSData.hScat_Par{chan}))];
elseif numel(FCSData.hScat_Par{chan}) > len
    FCSData.hScat_Par{chan} = FCSData.hScat_Par{chan}(1:len);
end
if numel(FCSData.hScat_Per{chan}) < len
    FCSData.hScat_Per{chan} = [FCSData.hScat_Per{chan},zeros(1,len-numel(FCSData.hScat_Per{chan}))];
elseif numel(FCSData.hScat_Per{chan}) > len
    FCSData.hScat_Per{chan} = FCSData.hScat_Per{chan}(1:len);
end



%%% Updates table and plot data and style to new size
Update_Plots(obj)
Update_Table([],[],1);


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Function to save merged .cor file %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function Merge_Cor(~,~)
global UserValues FCSData FCSMeta
h = guidata(findobj('Tag','FCSFit'));

%%% Merge only the active files
active = find(cell2mat(h.Fit_Table.Data(1:end-3,1)));
%%% check for length difference
len = zeros(1,numel(active));
k = 1;
for i = active'
    len(k) = numel(FCSData.Data{i}.Cor_Times);
    k = k+1;
end
minlen = min(len);
minlen_ix = find(len == min(len));

Valid = [];
Cor_Array = [];
Header = cell(0);
Counts = [0,0];
switch FCSMeta.DataType
    case 'FCS averaged'
        % multiple averaged file were loaded
        Cor_Times = FCSData.Data{active(minlen_ix(1))}.Cor_Times; % Take Cor_Times from first file, should be same for all.
        for i = active'
            Valid = [Valid, FCSData.Data{i}.Valid];
            Cor_Array = [Cor_Array, FCSData.Data{i}.Cor_Array(1:minlen,:)];
            Header{end+1} = FCSData.Data{i}.Header;
            Counts = Counts + FCSData.Data{i}.Counts;
        end
    case 'FCS individual'
        % individual curves from 1 file were loaded
        Cor_Times = FCSMeta.Data{active(minlen_ix(1)),1}; % Take Cor_Times from first file, should be same for all.
        for i = active'
            Valid = [Valid, 1];
            Cor_Array = [Cor_Array, FCSMeta.Data{i,2}(1:minlen,:)];
            Header{end+1} = FCSData.Data{i}.Header;
            Counts = Counts + FCSData.Data{i}.Counts;
        end
end
Counts = Counts./numel(active);

%%% Recalculate Average and SEM
Cor_Average=mean(Cor_Array,2);
%%% Averages files before saving to reduce errorbars
Amplitude=sum(Cor_Array,1);
Cor_Norm=Cor_Array./repmat(Amplitude,[size(Cor_Array,1),1])*mean(Amplitude);
Cor_SEM=std(Cor_Norm,0,2)/sqrt(size(Cor_Array,2));
%%% Pick FileName
[FileName,PathName] = uiputfile({'*.mcor'},'Choose a filename for the merged file',fullfile(UserValues.File.FCSPath,FCSData.FileName{active(1)}));
if FileName == 0
    m = msgbox('No valid filepath specified... Canceling');
    pause(1);
    delete(m);
    return;
end
Current_FileName = fullfile(PathName,FileName);
%%% Save
save(Current_FileName,'Header','Counts','Valid','Cor_Times','Cor_Average','Cor_SEM','Cor_Array');  

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Changes fit function %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function Load_Fit(~,~,mode)
global FCSMeta UserValues PathToApp
h = guidata(findobj('Tag','FCSFit'));
FileName=[];
FilterIndex = 1;
if mode
    %% Select a new model to load
    [FileName,PathName,FilterIndex]= uigetfile('.txt', 'Choose a fit model', [PathToApp filesep 'Models']);
    FileName=fullfile(PathName,FileName);
elseif isempty(UserValues.File.FCS_Standard) || ~exist(UserValues.File.FCS_Standard,'file') 
    %% Opens the first model in the folder at the start of the program
    Models=dir([PathToApp filesep 'Models']);
    Models=Models(~cell2mat({Models.isdir}));
    while isempty(FileName) && ~isempty(Models)
       if strcmp(Models(1).name(end-3:end),'.txt') 
           FileName=[PathToApp filesep 'Models' filesep Models(1).name];
           UserValues.File.FCS_Standard=FileName;
       else
           Models(1)=[];
       end
    end
else
    %% Opens last model used before closing program
    FileName=UserValues.File.FCS_Standard;
end

if ~isempty(FileName) && ~(FilterIndex == 0)
    UserValues.File.FCS_Standard=FileName;
    LSUserValues(1);
    
    %%% change encoding on mac
    if ismac
        feature('DefaultCharacterSet', 'windows-1252');
    end
    %%% Reads in the selected fit function file
    fid = fopen(FileName);
    Text=textscan(fid,'%s', 'delimiter', '\n','whitespace', '');
    Text=Text{1};
    
    %%% Finds line, at which model description starts
    Desc_Start = find(~cellfun(@isempty,strfind(Text,'-MODEL DESCRIPTION-')),1);
    %%% Finds line, at which parameter definition starts
    Param_Start=find(~cellfun(@isempty,strfind(Text,'-PARAMETER DEFINITION-')),1);
    %%% Finds line, at which function definition starts
    Fun_Start=find(~cellfun(@isempty,strfind(Text,'-FIT FUNCTION-')),1);
    B_Start=find(~cellfun(@isempty,strfind(Text,'-BRIGHTNESS DEFINITION-')),1);
    %%% Read model description
    if Param_Start - Desc_Start > 1 %%% at least one line of description
        description = Text(Desc_Start+1:Param_Start-1);
    else
        description = {};
    end
    %%% Defines the number of parameters
    NParams=B_Start-Param_Start-1;
    FCSMeta.Model=[];
    FCSMeta.Model.Name=FileName;
    FCSMeta.Model.Description = description;
    FCSMeta.Model.Brightness=Text{B_Start+1};
    %%% Concaternates the function string
    FCSMeta.Model.Function=[];
    for i=Fun_Start+1:numel(Text)
        FCSMeta.Model.Function=[FCSMeta.Model.Function Text(i)];
    end
    FCSMeta.Model.Function=cell2mat(FCSMeta.Model.Function);
    %%% Convert to function handle
    FunctionStart = strfind(FCSMeta.Model.Function,'=');
    eval(['FCSMeta.Model.Function = @(P,x) ' FCSMeta.Model.Function((FunctionStart(1)+1):end) ';']);
    %%% Extracts parameter names and initial values
    FCSMeta.Model.Params=cell(NParams,1);
    FCSMeta.Model.Value=zeros(NParams,1);
    FCSMeta.Model.LowerBoundaries = zeros(NParams,1);
    FCSMeta.Model.UpperBoundaries = zeros(NParams,1);
    FCSMeta.Model.State = zeros(NParams,1);
    %%% Reads parameters and values from file
    for i=1:NParams
        Param_Pos=strfind(Text{i+Param_Start},' ');
        FCSMeta.Model.Params{i}=Text{i+Param_Start}((Param_Pos(1)+1):(Param_Pos(2)-1));
        Start = strfind(Text{i+Param_Start},'=');
        %Stop = strfind(Text{i+Param_Start},';');
        % Filter more specifically (this enables the use of html greek
        % letters like &mu; etc.)
        [~, Stop] = regexp(Text{i+Param_Start},'(\d+;|Inf;)');
        FCSMeta.Model.Value(i) = str2double(Text{i+Param_Start}(Start(1)+1:Stop(1)-1));
        FCSMeta.Model.LowerBoundaries(i) = str2double(Text{i+Param_Start}(Start(2)+1:Stop(2)-1));   
        FCSMeta.Model.UpperBoundaries(i) = str2double(Text{i+Param_Start}(Start(3)+1:Stop(3)-1));
        if numel(Text{i+Param_Start})>Stop(3) && any(strfind(Text{i+Param_Start}(Stop(3):end),'g'))
            FCSMeta.Model.State(i) = 2;
        elseif numel(Text{i+Param_Start})>Stop(3) && any(strfind(Text{i+Param_Start}(Stop(3):end),'f'))
            FCSMeta.Model.State(i) = 1;
        end
    end    
    FCSMeta.Params=repmat(FCSMeta.Model.Value,[1,size(FCSMeta.Data,1)]);
    
    %%% Updates table to new model
    Update_Table([],[],0);
    %%% Updates model text
    [~,name,~] = fileparts(FCSMeta.Model.Name);
    name_text = {'Loaded Fit Model:';name;};
    h.Loaded_Model_Name.String = sprintf('%s\n',name_text{:});
    h.Loaded_Model_Description.String = sprintf('%s\n',description{:});
    h.Loaded_Model_Description.TooltipString = sprintf('%s\n',description{:});
end

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Function that updates fit table %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function Update_Table(~,e,mode)
h = guidata(findobj('Tag','FCSFit'));
global FCSMeta FCSData
switch mode
    case 0 %%% Updates whole table (Load Fit etc.)
        
        %%% Disables cell callbacks, to prohibit double callback
        h.Fit_Table.CellEditCallback=[];        
        %%% Generates column names and resized them
        Columns=cell(3*numel(FCSMeta.Model.Params)+5,1);
        Columns{1} = '<HTML><b>File</b>';
        Columns{2}='<HTML><b>Active</b>';
        Columns{3}='<HTML><b>Counts [kHz]</b>';
        Columns{4}='<HTML><b>Brightness [kHz]</b>';
        for i=1:numel(FCSMeta.Model.Params)
            Columns{3*i+2}=['<HTML><b>' FCSMeta.Model.Params{i} '</b>'];
            Columns{3*i+3}='<HTML><b>F</b>';
            Columns{3*i+4}='<HTML><b>G</b>';
        end
        Columns{end}='<HTML><b>Chi2</b>';
        ColumnWidth=cell(1,numel(Columns));
        %ColumnWidth(4:3:end-1)=cellfun('length',FCSMeta.Model.Params).*7;
        ColumnWidth(5:3:end-1) = {80};
        %ColumnWidth(ColumnWidth>0 & ColumnWidth<30)=45;
        ColumnWidth(6:3:end-1)={20};
        ColumnWidth(7:3:end-1)={20};
        ColumnWidth(1) = {100};
        ColumnWidth(2)={40};
        ColumnWidth(3)={80};
        ColumnWidth(4)={100};
        ColumnWidth(end)={40};
        h.Fit_Table.ColumnName=Columns;
        h.Fit_Table.ColumnWidth = ColumnWidth;
        %h.Fit_Table.ColumnWidth=num2cell(ColumnWidth');        
        %%% Sets row names to file names 
        Rows=cell(numel(FCSData.Data)+3,1);
        tmp = FCSData.FileName;
        for i = 1:numel(tmp)
            tmp{i} = ['<HTML><b>' tmp{i} '</b>'];
        end
        Rows(1:numel(FCSData.Data))=deal(tmp);
        Rows{end-2}='<HTML><b>ALL</b>';
        Rows{end-1}='<HTML><b>Lower bound</b>';
        Rows{end}='<HTML><b>Upper bound</b>';
        h.Fit_Table.RowName=[];         
        %%% Creates table data:
        %%% 1: Checkbox to activate/deactivate files
        %%% 2: Countrate of file
        %%% 3: Brightness if file
        %%% 4:3:end: Parameter value
        %%% 5:3:end: Checkbox to fix parameter
        %%% 6:3:end: Checkbox to fit parameter globaly
        Data=num2cell(zeros(numel(Rows),numel(Columns)-1));
        for i=1:(numel(Rows)-3)
            %%% Distinguish between Autocorrelation (only take Counts of
            %%% Channel) and Crosscorrelation (take sum of Channels)
            if FCSData.Data{i}.Counts(1) == FCSData.Data{i}.Counts(2)
                %%% Autocorrelation
                Data{i,2}=num2str(FCSData.Data{i}.Counts(1));
            elseif FCSData.Data{i}.Counts(1) ~= FCSData.Data{i}.Counts(2)
                %%% Crosscorrelation
                Data{i,2}=num2str(sum(FCSData.Data{i}.Counts));
            end
        end
        Data(1:end-3,4:3:end-1)=deal(num2cell(FCSMeta.Params)');
        Data(end-2,4:3:end-1)=deal(num2cell(FCSMeta.Model.Value)');
        Data(end-1,4:3:end-1)=deal(num2cell(FCSMeta.Model.LowerBoundaries)');
        Data(end,4:3:end-1)=deal(num2cell(FCSMeta.Model.UpperBoundaries)');
        Data=cellfun(@num2str,Data,'UniformOutput',false);
        Data(1:end-2,5:3:end-1) = repmat(num2cell(FCSMeta.Model.State==1)',size(Data,1)-2,1);        
        Data(end-1:end,5:3:end-1)=deal({[]});
        Data(1:end-2,6:3:end-1) = repmat(num2cell(FCSMeta.Model.State==2)',size(Data,1)-2,1);
        Data(end-1:end,6:3:end-1)=deal({[]});
        Data(1:end-2,1)=deal({true});
        Data(end-1:end,1)=deal({[]});
        Data(1:end-2,end)=deal({'0'});
        Data(end-1:end,end)=deal({[]});
        h.Fit_Table.Data=[Rows,Data];
        h.Fit_Table.ColumnEditable=[false,true,false,false,true(1,numel(Columns)-5),false];  
        h.Fit_Table.ColumnWidth(1) = {7*max(cellfun('prodofsize',Rows))};
        %%% Enables cell callback again
        h.Fit_Table.CellEditCallback={@Update_Table,3};
    case 1 %%% Updates tables when new data is loaded
        h.Fit_Table.CellEditCallback=[];
        %%% Sets row names to file names
        Rows=cell(numel(FCSData)+3,1);
        tmp = FCSData.FileName;
        Rows(1:numel(tmp))=cellstr(tmp);
        Rows{end-2}='ALL';
        Rows{end-1}='Lower bound';
        Rows{end}='Upper bound';
        %h.Fit_Table.RowName=Rows;
        
        Data=cell(numel(Rows),size(h.Fit_Table.Data,2)-1);
        %%% Set last 3 row to ALL, lb and ub
        Data(1:(size(h.Fit_Table.Data,1)-3),:)=h.Fit_Table.Data(1:end-3,2:end);
        %%% Sets previous files
        Data(end-2:end,:)=h.Fit_Table.Data(end-2:end,2:end);
        %%% Adds new files
        Data((size(h.Fit_Table.Data,1)-2):(end-3),:)=repmat(h.Fit_Table.Data(end-2,2:end),[numel(Rows)-(size(h.Fit_Table.Data,1)),1]);

        h.Fit_Table.Data=[Rows,Data];
        h.Fit_Table.ColumnWidth(1) = {7*max(cellfun('prodofsize',Rows))};
        %%% Enables cell callback again
        h.Fit_Table.CellEditCallback={@Update_Table,3};
    case 2 %%% Updates table after fit
        %%% Disables cell callbacks, to prohibit double callback
        h.Fit_Table.CellEditCallback=[];
        %%% Updates Brightness in Table
        for i=1:(size(h.Fit_Table.Data,1)-3)
            P=FCSMeta.Params(:,i);
            eval(FCSMeta.Model.Brightness);
            h.Fit_Table.Data{i,4}= num2str(str2double(h.Fit_Table.Data{i,3}).*B);
        end
        %%% Updates parameter values in table
        h.Fit_Table.Data(1:end-3,5:3:end-1)=cellfun(@num2str,num2cell(FCSMeta.Params)','UniformOutput',false);
        %%% Updates plots
        %Update_Plots        
        %%% Enables cell callback again        
        h.Fit_Table.CellEditCallback={@Update_Table,3};
    case 3 %%% Individual cells callbacks
        %%% Disables cell callbacks, to prohibit double callback
        h.Fit_Table.CellEditCallback=[];        
        if strcmp(e.EventName,'CellSelection') %%% No change in Value, only selected
            %%% detect click of "All" row, in which case the callback
            %%% should finish to update the values
            %%% problem in 2018a: Updating the other values causes the cell
            %%% selection to drop, making it impossible to set another
            %%% value.
            %%% The "All" row thus only updates if the user types a
            %%% different value, causing the EditCallback to fire.
            if ~isempty(e.Indices) && e.Indices(1) == size(h.Fit_Table.Data,1)-2
                %NewData = h.Fit_Table.Data{e.Indices(1),e.Indices(2)};
                h.Fit_Table.CellEditCallback={@Update_Table,3};
                return;
            else
                if isempty(e.Indices) % sometime, indices is empty
                    h.Fit_Table.CellEditCallback={@Update_Table,3};
                    return;
                end
                %%% if a lower boundary/upperboundary field of a logical
                %%% quantity was clicked (i.e. active/fixed/global)
                %%% make sure to deselect the field to prevent the user
                %%% from typing a value
                deselect = 0;
                if e.Indices(1) > size(h.Fit_Table.Data,1)-2 %%% clicked lb/ub field
                    if e.Indices(2) == 2 %%% clicked the "active" column
                        deselect = 1;
                    elseif e.Indices(2) == size(h.Fit_Table.Data,2) % clicked chi2 field
                        deselect = 1;
                    elseif mod(e.Indices(2)-5,3) ~= 0 % clicked fixed or global field
                        deselect = 1;
                    end
                end
                if deselect
                    %%% deselection of field is only possible by assigning
                    %%% a dummy to the data and re-assigning the original
                    %%% data afterwards
                    temp = h.Fit_Table.Data;
                    h.Fit_Table.Data = repmat({'dummy'},size(h.Fit_Table.Data));
                    h.Fit_Table.Data = temp;
                end
                %%% re-assign callback and exit
                h.Fit_Table.CellEditCallback={@Update_Table,3};
                return;
            end
            % previously, the following code was called that caused the GUI to get stuck in version 2018a and upwards
            %if isempty(e.Indices) || (e.Indices(1)~=(size(h.Fit_Table.Data,1)-2) && e.Indices(2)~=1)
            %    h.Fit_Table.CellEditCallback={@Update_Table,3};
            %    return;
            %end
            %NewData = h.Fit_Table.Data{e.Indices(1),e.Indices(2)};
        end
        if isprop(e,'NewData')
            NewData = e.NewData;
        end

        if e.Indices(1)==size(h.Fit_Table.Data,1)-2
            %% ALL row wase used => Applies to all files
            if e.Indices(2) > 1 %%% don't execute for name column
                h.Fit_Table.Data(1:end-2,e.Indices(2))=deal({NewData});
                if mod(e.Indices(2)-5,3)==0 && e.Indices(2)>=5
                    %% Value was changed => Apply value to global variables
                    FCSMeta.Params((e.Indices(2)-2)/3,:)=str2double(NewData);
                elseif mod(e.Indices(2)-6,3)==0 && e.Indices(2)>=6 && NewData==1
                    %% Value was fixed => Uncheck global
                    h.Fit_Table.Data(1:end-2,e.Indices(2)+1)=deal({false});
                elseif mod(e.Indices(2)-7,3)==0 && e.Indices(2)>=7 && NewData==1
                    %% Global was change
                    %%% Apply value to all files
                    h.Fit_Table.Data(1:end-2,e.Indices(2)-2)=h.Fit_Table.Data(e.Indices(1),e.Indices(2)-2);
                    %%% Apply value to global variables
                    FCSMeta.Params((e.Indices(2)-4)/3,:)=str2double(h.Fit_Table.Data{e.Indices(1),e.Indices(2)-2});
                    %%% Unfixes all files to prohibit fixed and global
                    h.Fit_Table.Data(1:end-2,e.Indices(2)-1)=deal({false});
                end
            end
        elseif mod(e.Indices(2)-7,3)==0 && e.Indices(2)>=7 && e.Indices(1)<size(h.Fit_Table.Data,1)-1
            %% Global was changed => Applies to all files
            h.Fit_Table.Data(1:end-2,e.Indices(2))=deal({NewData});
            if NewData
                %%% Apply value to all files
                h.Fit_Table.Data(1:end-2,e.Indices(2)-2)=h.Fit_Table.Data(e.Indices(1),e.Indices(2)-2);
                %%% Apply value to global variables
                FCSMeta.Params((e.Indices(2)-4)/3,:)=str2double(h.Fit_Table.Data{e.Indices(1),e.Indices(2)-2});
                %%% Unfixes all file to prohibit fixed and global
                h.Fit_Table.Data(1:end-2,e.Indices(2)-1)=deal({false});
            end
        elseif mod(e.Indices(2)-6,3)==0 && e.Indices(2)>=6 && e.Indices(1)<size(h.Fit_Table.Data,1)-1
            %% Value was fixed
            %%% Updates ALL row
            if all(cell2mat(h.Fit_Table.Data(1:end-3,e.Indices(2))))
                h.Fit_Table.Data{end-2,e.Indices(2)}=true;
            else
                h.Fit_Table.Data{end-2,e.Indices(2)}=false;
            end
            %%% Unchecks global to prohibit fixed and global
            h.Fit_Table.Data(1:end-2,e.Indices(2)+1)=deal({false;});
        elseif mod(e.Indices(2)-5,3)==0 && e.Indices(2)>=5 && e.Indices(1)<size(h.Fit_Table.Data,1)-1
            %% Value was changed
            if h.Fit_Table.Data{e.Indices(1),e.Indices(2)+2}
                %% Global => changes value of all files
                h.Fit_Table.Data(1:end-2,e.Indices(2))=deal({NewData});
                FCSMeta.Params((e.Indices(2)-2)/3,:)=str2double(NewData);
            else
                %% Not global => only changes value
                FCSMeta.Params((e.Indices(2)-2)/3,e.Indices(1))=str2double(NewData);
                
            end
        elseif e.Indices(2)==1
            %% Active was changed
            a = 1;
        end       
        %%% Enables cell callback again
        h.Fit_Table.CellEditCallback={@Update_Table,3};
end

%%% Updates plots to changes models
%Update_Plots;



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%  General Function to Update Plots when something changed %%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function Update_Plots(obj,~)
global UserValues FCSData
h = guidata(findobj('Tag','FCSFit'));


G = str2double(h.G_factor_edit.String);
l1 = str2double(h.l1_edit.String);
l2 = str2double(h.l2_edit.String);


% nanoseconds per microtime bin
TACtoTime = FCSData.TACChannelWidth;%1/TauFitData.MI_Bins*TauFitData.TACRange*1e9;


    %LoadData button or Burstwise lifetime button was pressed
    %%% Plot the Data
    h.Plots.Decay_Par.XData = FCSData.XData_Par{FCSData.chan}*TACtoTime; 
    h.Plots.Decay_Per.XData = FCSData.XData_Per{FCSData.chan}*TACtoTime; 
    h.Plots.IRF_Par.XData = FCSData.XData_Par{FCSData.chan}*TACtoTime;
    h.Plots.IRF_Per.XData = FCSData.XData_Per{FCSData.chan}*TACtoTime;
    h.Plots.Scat_Par.XData = FCSData.XData_Par{FCSData.chan}*TACtoTime;
    h.Plots.Scat_Per.XData = FCSData.XData_Per{FCSData.chan}*TACtoTime;
    h.Plots.Decay_Par.YData = FCSData.hMI_Par{FCSData.chan};
    h.Plots.Decay_Per.YData = FCSData.hMI_Per{FCSData.chan};
    h.Plots.IRF_Par.YData = FCSData.hIRF_Par{FCSData.chan};
    h.Plots.IRF_Per.YData = FCSData.hIRF_Per{FCSData.chan};
    h.Plots.Scat_Par.YData = FCSData.hScat_Par{FCSData.chan};
    h.Plots.Scat_Per.YData = FCSData.hScat_Per{FCSData.chan};

    h.Microtime_Plot.XLim = [min([FCSData.XData_Par{FCSData.chan}*TACtoTime FCSData.XData_Per{FCSData.chan}*TACtoTime]) max([FCSData.XData_Par{FCSData.chan}*TACtoTime FCSData.XData_Per{FCSData.chan}*TACtoTime])];
    
    try
        h.Microtime_Plot.YLim = [min([FCSData.hMI_Par{FCSData.chan}; FCSData.hMI_Per{FCSData.chan}]) 10/9*max([FCSData.hMI_Par{FCSData.chan}; FCSData.hMI_Per{FCSData.chan}])];
    catch
        % if there is no data, disable channel and stop
        h.IncludeChannel_checkbox.Value = 0;
        UserValues.TauFit.IncludeChannel(h.ChannelSelect_Popupmenu.Value) = 0;
        LSUserValues(1);
        return
    end
    %%% Define the Slider properties
    %%% Values to consider:
    %%% The length of the shortest PIE channel
    FCSData.MaxLength{FCSData.chan} = min([numel(FCSData.hMI_Par{FCSData.chan}) numel(FCSData.hMI_Per{FCSData.chan})]);
    
    %%% The Length Slider defaults to the length of the shortest PIE
    %%% channel and should not assume larger values
    h.Length_Slider.Min = 1;
    h.Length_Slider.Max = FCSData.MaxLength{FCSData.chan};
    h.Length_Slider.SliderStep =[1, 10]*(1/(h.Length_Slider.Max-h.Length_Slider.Min));
    if UserValues.TauFit.Length{FCSData.chan} > 0 && UserValues.TauFit.Length{FCSData.chan} < FCSData.MaxLength{FCSData.chan}+1
        tmp = UserValues.TauFit.Length{FCSData.chan};
    else
        tmp = FCSData.MaxLength{FCSData.chan};
    end
    h.Length_Slider.Value = tmp;
    FCSData.Length{FCSData.chan} = tmp;
    h.Length_Edit.String = num2str(tmp);
    
    %%% Start Parallel Slider can assume values from 0 (no shift) up to the
    %%% length of the shortest PIE channel minus the set length
    h.StartPar_Slider.Min = 0;
    h.StartPar_Slider.Max = floor(FCSData.MaxLength{FCSData.chan}/5);
    h.StartPar_Slider.SliderStep =[1, 10]*(1/(h.StartPar_Slider.Max-h.StartPar_Slider.Min));
    if UserValues.TauFit.StartPar{FCSData.chan} >= 0 && UserValues.TauFit.StartPar{FCSData.chan} <= floor(FCSData.MaxLength{FCSData.chan}/5)
        tmp = UserValues.TauFit.StartPar{FCSData.chan};
    else
        tmp = 0;
    end
    h.StartPar_Slider.Value = tmp;
    FCSData.StartPar{FCSData.chan} = tmp;
    h.StartPar_Edit.String = num2str(tmp);
    
    %%% Shift Perpendicular Slider can assume values from the difference in
    %%% start point between parallel and perpendicular up to the difference
    %%% between the end point of the parallel channel and the start point
    %%% of the perpendicular channel
    h.ShiftPer_Slider.Min = -floor(FCSData.MaxLength{FCSData.chan}/20);
    h.ShiftPer_Slider.Max = floor(FCSData.MaxLength{FCSData.chan}/20);
    %%% Note: (!)
    %%% While shift of < 1 (e.g. 0.1) are in principle possible, they
    %%% change the noise characteristics and thus the obtained chi2 is
    %%% wrong!
    h.ShiftPer_Slider.SliderStep = [1, 10]*(1/(h.ShiftPer_Slider.Max-h.ShiftPer_Slider.Min));%[0.1, 1]*(1/(h.ShiftPer_Slider.Max-h.ShiftPer_Slider.Min));
    if UserValues.TauFit.ShiftPer{FCSData.chan} >= -floor(FCSData.MaxLength{FCSData.chan}/20)...
            && UserValues.TauFit.ShiftPer{FCSData.chan} <= floor(FCSData.MaxLength{FCSData.chan}/20)
        tmp = round(UserValues.TauFit.ShiftPer{FCSData.chan});
    else
        tmp = 0;
    end
    h.ShiftPer_Slider.Value = tmp;
    FCSData.ShiftPer{FCSData.chan} = tmp;
    h.ShiftPer_Edit.String = num2str(tmp);

    %%% IRF Length has the same limits as the Length property
    h.IRFLength_Slider.Min = 1;
    h.IRFLength_Slider.Max = FCSData.MaxLength{FCSData.chan};
    h.IRFLength_Slider.SliderStep =[1, 10]*(1/(h.IRFLength_Slider.Max-h.IRFLength_Slider.Min));
    if UserValues.TauFit.IRFLength{FCSData.chan} >= 0 && UserValues.TauFit.IRFLength{FCSData.chan} <= FCSData.MaxLength{FCSData.chan}
        tmp = UserValues.TauFit.IRFLength{FCSData.chan};
    else
        tmp = FCSData.MaxLength{FCSData.chan};
    end
    h.IRFLength_Slider.Value = tmp;
    FCSData.IRFLength{FCSData.chan} = tmp;
    h.IRFLength_Edit.String = num2str(tmp);
    
    %%% IRF Shift has the same limits as the perp shift property
    h.IRFShift_Slider.Min = -floor(FCSData.MaxLength{FCSData.chan}/20);
    h.IRFShift_Slider.Max = floor(FCSData.MaxLength{FCSData.chan}/20);
    h.IRFShift_Slider.SliderStep =[0.1, 1]*(1/(h.IRFShift_Slider.Max-h.IRFShift_Slider.Min));
    tmp = UserValues.TauFit.IRFShift{FCSData.chan};
    
    limit_IRF_range = false; % reset to 0 if IRFshift does not make sense
    if limit_IRF_range
        if UserValues.TauFit.IRFShift{FCSData.chan} >= -floor(FCSData.MaxLength{FCSData.chan}/20)...
                && UserValues.TauFit.IRFShift{FCSData.chan} <= floor(FCSData.MaxLength{FCSData.chan}/20)
            tmp = UserValues.TauFit.IRFShift{FCSData.chan};
        else
            tmp = 0;
        end
    end
    
    h.IRFShift_Slider.Value = tmp;
    FCSData.IRFShift{FCSData.chan} = tmp;
    h.IRFShift_Edit.String = num2str(tmp);
    
    %%% IRF rel. Shift has the same limits as the perp shift property
    h.IRFrelShift_Slider.Min = -floor(FCSData.MaxLength{FCSData.chan}/20);
    h.IRFrelShift_Slider.Max = floor(FCSData.MaxLength{FCSData.chan}/20);
    h.IRFrelShift_Slider.SliderStep =[0.1, 1]*(1/(h.IRFrelShift_Slider.Max-h.IRFrelShift_Slider.Min));
    if UserValues.TauFit.IRFrelShift{FCSData.chan} >= -floor(FCSData.MaxLength{FCSData.chan}/20)...
            && UserValues.TauFit.IRFrelShift{FCSData.chan} <= floor(FCSData.MaxLength{FCSData.chan}/20)
        tmp = UserValues.TauFit.IRFrelShift{FCSData.chan};
    else
        tmp = 0;
    end
    h.IRFrelShift_Slider.Value = tmp;
    FCSData.IRFrelShift{FCSData.chan} = tmp;
    h.IRFrelShift_Edit.String = num2str(tmp);
    
    %%% Scat Shift has the same limits as the perp shift property
    h.ScatShift_Slider.Min = -floor(FCSData.MaxLength{FCSData.chan}/20);
    h.ScatShift_Slider.Max = floor(FCSData.MaxLength{FCSData.chan}/20);
    h.ScatShift_Slider.SliderStep =[0.1, 1]*(1/(h.ScatShift_Slider.Max-h.ScatShift_Slider.Min));
    if UserValues.TauFit.ScatShift{FCSData.chan} >= -floor(FCSData.MaxLength{FCSData.chan}/20)...
            && UserValues.TauFit.ScatShift{FCSData.chan} <= floor(FCSData.MaxLength{FCSData.chan}/20)
        tmp = UserValues.TauFit.ScatShift{FCSData.chan};
    else
        tmp = 0;
    end
    h.ScatShift_Slider.Value = tmp;
    FCSData.ScatShift{FCSData.chan} = tmp;
    h.ScatShift_Edit.String = num2str(tmp);
    
    %%% Scat rel. Shift has the same limits as the perp shift property
    h.ScatrelShift_Slider.Min = -floor(FCSData.MaxLength{FCSData.chan}/20);
    h.ScatrelShift_Slider.Max = floor(FCSData.MaxLength{FCSData.chan}/20);
    h.ScatrelShift_Slider.SliderStep =[0.1, 1]*(1/(h.ScatrelShift_Slider.Max-h.ScatrelShift_Slider.Min));
    if UserValues.TauFit.ScatrelShift{FCSData.chan} >= -floor(FCSData.MaxLength{FCSData.chan}/20)...
            && UserValues.TauFit.ScatrelShift{FCSData.chan} <= floor(FCSData.MaxLength{FCSData.chan}/20)
        tmp = UserValues.TauFit.ScatrelShift{FCSData.chan};
    else
        tmp = 0;
    end
    h.ScatrelShift_Slider.Value = tmp;
    FCSData.ScatrelShift{FCSData.chan} = tmp;
    h.ScatrelShift_Edit.String = num2str(tmp);
    
    %%% Ignore Slider reaches from 1 to maximum length
    h.Ignore_Slider.Min = 1;
    h.Ignore_Slider.Max = floor(FCSData.MaxLength{FCSData.chan}/5);
    h.Ignore_Slider.SliderStep =[1, 10]*(1/(h.Ignore_Slider.Max-h.Ignore_Slider.Min));
    if UserValues.TauFit.Ignore{FCSData.chan} >= 1 && UserValues.TauFit.Ignore{FCSData.chan} <= floor(FCSData.MaxLength{FCSData.chan}/5)
        tmp = UserValues.TauFit.Ignore{FCSData.chan};
    else
        tmp = 1;
    end
    h.Ignore_Slider.Value = tmp;
    FCSData.Ignore{FCSData.chan} = tmp;
    h.Ignore_Edit.String = num2str(tmp);
    
    % when the popup has changed, the table has to be updated with the
    % UserValues data
  % h.FitPar_Table.Data = GetTableData(h.FitMethod_Popupmenu.Value, chan);
    % G factor is channel specific
    h.G_factor_edit.String = UserValues.TauFit.G{FCSData.chan};


%%% Update Slider Values
if isobject(obj) % check if matlab object
    switch obj
        case {h.StartPar_Slider, h.StartPar_Edit}
            if obj == h.StartPar_Slider
                FCSData.StartPar{FCSData.chan} = floor(obj.Value);
            elseif obj == h.StartPar_Edit
                FCSData.StartPar{FCSData.chan} = floor(str2double(obj.String));
                obj.String = num2str(FCSData.StartPar{FCSData.chan});
            end
        case {h.Length_Slider, h.Length_Edit}
            %%% Update Value
            if obj == h.Length_Slider
                FCSData.Length{FCSData.chan} = floor(obj.Value);
            elseif obj == h.Length_Edit
                FCSData.Length{FCSData.chan} = floor(str2double(obj.String));
                obj.String = num2str(FCSData.Length{FCSData.chan});
            end
            %%% Correct if IRFLength exceeds the Length
            if FCSData.IRFLength{FCSData.chan} > FCSData.Length{FCSData.chan}
                FCSData.IRFLength{FCSData.chan} = FCSData.Length{FCSData.chan};
                h.IRFLength_Edit.String = num2str(FCSData.IRFLength{FCSData.chan});
                h.IRFLength_Slider.Value = FCSData.IRFLength{FCSData.chan};
            end
        case {h.ShiftPer_Slider, h.ShiftPer_Edit}
            %%% Update Value
            %%% Note: (!)
            %%% While shifts of < 1 (e.g. 0.1) are in principle possible, they
            %%% change the noise characteristics and thus the obtained chi2 is
            %%% wrong!
            if obj == h.ShiftPer_Slider
                FCSData.ShiftPer{FCSData.chan} = floor(obj.Value);%round(obj.Value*h.subresolution)/h.subresolution;
            elseif obj == h.ShiftPer_Edit
                FCSData.ShiftPer{FCSData.chan} = floor(str2double(obj.String));%round(str2double(obj.String)*h.subresolution)/h.subresolution;
                obj.String = num2str(FCSData.ShiftPer{FCSData.chan});
            end
        case {h.IRFLength_Slider, h.IRFLength_Edit}
            %%% Update Value
            if obj == h.IRFLength_Slider
                FCSData.IRFLength{FCSData.chan} = floor(obj.Value);
            elseif obj == h.IRFLength_Edit
                FCSData.IRFLength{FCSData.chan} = floor(str2double(obj.String));
                obj.String = num2str(FCSData.IRFLength{FCSData.chan});
            end
            %%% Correct if IRFLength exceeds the Length
            if FCSData.IRFLength{FCSData.chan} > FCSData.Length{FCSData.chan}
                FCSData.IRFLength{FCSData.chan} = FCSData.Length{FCSData.chan};
            end
        case {h.IRFShift_Slider, h.IRFShift_Edit}
            %%% Update Value
            if obj == h.IRFShift_Slider
                FCSData.IRFShift{FCSData.chan} = round(obj.Value*h.subresolution)/h.subresolution;
            elseif obj == h.IRFShift_Edit
                FCSData.IRFShift{FCSData.chan} = round(str2double(obj.String)*h.subresolution)/h.subresolution;
                obj.String = num2str(FCSData.IRFShift{FCSData.chan});
            end
        case {h.IRFrelShift_Slider, h.IRFrelShift_Edit}
            %%% Update Value
            if obj == h.IRFrelShift_Slider
                FCSData.IRFrelShift{FCSData.chan} = round(obj.Value*h.subresolution)/h.subresolution;
            elseif obj == h.IRFrelShift_Edit
                FCSData.IRFrelShift{FCSData.chan} = round(str2double(obj.String)*h.subresolution)/h.subresolution;
                obj.String = num2str(FCSData.IRFrelShift{FCSData.chan});
            end
        case {h.ScatShift_Slider, h.ScatShift_Edit}
            %%% Update Value
            if obj == h.ScatShift_Slider
                FCSData.ScatShift{FCSData.chan} = round(obj.Value*h.subresolution)/h.subresolution;
            elseif obj == h.ScatShift_Edit
                FCSData.ScatShift{FCSData.chan} = round(str2double(obj.String)*h.subresolution)/h.subresolution;
                obj.String = num2str(FCSData.ScatShift{FCSData.chan});
            end
        case {h.ScatrelShift_Slider, h.ScatrelShift_Edit}
            %%% Update Value
            if obj == h.ScatrelShift_Slider
                FCSData.ScatrelShift{FCSData.chan} = round(obj.Value*h.subresolution)/h.subresolution;
            elseif obj == h.ScatrelShift_Edit
                FCSData.ScatrelShift{FCSData.chan} = round(str2double(obj.String)*h.subresolution)/h.subresolution;
                obj.String = num2str(FCSData.ScatrelShift{FCSData.chan});
            end
        case {h.Ignore_Slider,h.Ignore_Edit}%%% Update Value
            if obj == h.Ignore_Slider
                FCSData.Ignore{FCSData.chan} = floor(obj.Value);
            elseif obj == h.Ignore_Edit
                if str2double(obj.String) <  1
                    FCSData.Ignore{FCSData.chan} = 1;
                    obj.String = '1';
                else
                    FCSData.Ignore{chan} = floor(str2double(obj.String));
                    obj.String = num2str(FCSData.Ignore{FCSData.chan});
                end
            end     
    end
end
%%% Update Edit Boxes if Slider was used and Sliders if Edit Box was used
if isprop(obj,'Style')
    switch obj.Style
        case 'slider'
            h.StartPar_Edit.String = num2str(FCSData.StartPar{FCSData.chan});
            h.Length_Edit.String = num2str(FCSData.Length{FCSData.chan});
            h.ShiftPer_Edit.String = num2str(FCSData.ShiftPer{FCSData.chan});
            h.IRFLength_Edit.String = num2str(FCSData.IRFLength{FCSData.chan});
            h.IRFShift_Edit.String = num2str(FCSData.IRFShift{FCSData.chan});
            h.IRFrelShift_Edit.String = num2str(FCSData.IRFrelShift{FCSData.chan});
            h.ScatShift_Edit.String = num2str(FCSData.ScatShift{FCSData.chan});
            h.ScatrelShift_Edit.String = num2str(FCSData.ScatrelShift{FCSData.chan});
            h.Fit_Table.Data{end,1} = FCSData.IRFShift{FCSData.chan};
            h.Ignore_Edit.String = num2str(FCSData.Ignore{FCSData.chan});
        case 'edit'
            h.StartPar_Slider.Value = FCSData.StartPar{FCSData.chan};
            h.Length_Slider.Value = FCSData.Length{FCSData.chan};
            h.ShiftPer_Slider.Value = FCSData.ShiftPer{FCSData.chan};
            h.IRFLength_Slider.Value = FCSData.IRFLength{FCSData.chan};
            h.IRFShift_Slider.Value = FCSData.IRFShift{FCSData.chan};
            h.IRFrelShift_Slider.Value = FCSData.IRFrelShift{FCSData.chan};
            h.ScatShift_Slider.Value = FCSData.ScatShift{FCSData.chan};
            h.ScatrelShift_Slider.Value = FCSData.ScatrelShift{FCSData.chan};
            h.Fit_Table.Data{end,1} = FCSData.IRFShift{FCSData.chan};
            h.Ignore_Slider.Value = FCSData.Ignore{FCSData.chan};
    end
    UserValues.TauFit.StartPar{FCSData.chan} = FCSData.StartPar{FCSData.chan};
    UserValues.TauFit.Length{FCSData.chan} = FCSData.Length{FCSData.chan};
    UserValues.TauFit.ShiftPer{FCSData.chan} = FCSData.ShiftPer{FCSData.chan};
    UserValues.TauFit.IRFLength{FCSData.chan} = FCSData.IRFLength{FCSData.chan};
    UserValues.TauFit.IRFShift{FCSData.chan} = FCSData.IRFShift{FCSData.chan};
    UserValues.TauFit.IRFrelShift{FCSData.chan} = FCSData.IRFrelShift{FCSData.chan};
    UserValues.TauFit.ScatShift{FCSData.chan} = FCSData.ScatShift{FCSData.chan};
    UserValues.TauFit.ScatrelShift{FCSData.chan} = FCSData.ScatrelShift{FCSData.chan};
    UserValues.TauFit.Ignore{FCSData.chan} = FCSData.Ignore{FCSData.chan};
    LSUserValues(1);
end


%%% Update Plot
%%% Make the Microtime Adjustment Plot Visible, hide Result
h.Microtime_Plot.Parent = h.Fit_Plots_Panel;
h.Result_Plot.Parent = h.HidePanel;
h.Result_Plot_Aniso.Parent = h.HidePanel;
%%% hide wres plot
set([h.Plots.Residuals,h.Plots.Residuals_ignore,h.Plots.Residuals_Perp,h.Plots.Residuals_Perp_ignore],'Visible','off');
%%% Apply the shift to the parallel channel
% if you change something here, change it too in Start_BurstWise Fit!
h.Plots.Decay_Par.XData = ((FCSData.StartPar{FCSData.chan}:(FCSData.Length{FCSData.chan}-1)) - FCSData.StartPar{FCSData.chan})*TACtoTime;
h.Plots.Decay_Par.YData = FCSData.hMI_Par{FCSData.chan}((FCSData.StartPar{FCSData.chan}+1):FCSData.Length{FCSData.chan})';
%%% Apply the shift to the perpendicular channel
h.Plots.Decay_Per.XData = ((FCSData.StartPar{FCSData.chan}:(FCSData.Length{FCSData.chan}-1)) - FCSData.StartPar{FCSData.chan})*TACtoTime;
%tmp = circshift(TauFitData.hMI_Per{chan},[TauFitData.ShiftPer{chan},0])';
tmp = shift_by_fraction(FCSData.hMI_Per{FCSData.chan}, FCSData.ShiftPer{FCSData.chan});
h.Plots.Decay_Per.YData = tmp((FCSData.StartPar{FCSData.chan}+1):FCSData.Length{FCSData.chan});
%%% Apply the shift to the parallel IRF channel
h.Plots.IRF_Par.XData = ((FCSData.StartPar{FCSData.chan}:(FCSData.IRFLength{FCSData.chan}-1)) - FCSData.StartPar{FCSData.chan})*TACtoTime;
%tmp = circshift(TauFitData.hIRF_Par{chan},[0,TauFitData.IRFShift{chan}])';
tmp = shift_by_fraction(FCSData.hIRF_Par{FCSData.chan},FCSData.IRFShift{FCSData.chan});
h.Plots.IRF_Par.YData = tmp((FCSData.StartPar{FCSData.chan}+1):FCSData.IRFLength{FCSData.chan});
%%% Apply the shift to the perpendicular IRF channel
h.Plots.IRF_Per.XData = ((FCSData.StartPar{FCSData.chan}:(FCSData.IRFLength{FCSData.chan}-1)) - FCSData.StartPar{FCSData.chan})*TACtoTime;
%tmp = circshift(TauFitData.hIRF_Per{chan},[0,TauFitData.IRFShift{chan}+TauFitData.ShiftPer{chan}+TauFitData.IRFrelShift{chan}])';
tmp = shift_by_fraction(FCSData.hIRF_Per{FCSData.chan},FCSData.IRFShift{FCSData.chan}+FCSData.ShiftPer{FCSData.chan}+FCSData.IRFrelShift{FCSData.chan});
h.Plots.IRF_Per.YData = tmp((FCSData.StartPar{FCSData.chan}+1):FCSData.IRFLength{FCSData.chan});
%%% Apply the shift to the parallel Scat channel
h.Plots.Scat_Par.XData = ((FCSData.StartPar{FCSData.chan}:(FCSData.Length{FCSData.chan}-1)) - FCSData.StartPar{FCSData.chan})*TACtoTime;
%tmp = circshift(TauFitData.hScat_Par{chan},[0,TauFitData.ScatShift{chan}])';
tmp = shift_by_fraction(FCSData.hScat_Par{FCSData.chan},FCSData.ScatShift{FCSData.chan});
if h.NormalizeScatter_Menu.Value
    % since the scatter pattern should not contain background, we subtract the constant offset
    maxscat = max(tmp);
    %subtract the constant offset and renormalize the amplitude to what it was
    tmp = (tmp-mean(tmp(end-floor(FCSData.MI_Bins/50):end)));
    tmp = tmp/max(tmp)*maxscat;
    %tmp(tmp < 0) = 0;
    tmp(isnan(tmp)) = 0;
end
h.Plots.Scat_Par.YData = tmp((FCSData.StartPar{FCSData.chan}+1):FCSData.Length{FCSData.chan});
%%% Apply the shift to the perpendicular Scat channel
h.Plots.Scat_Per.XData = ((FCSData.StartPar{FCSData.chan}:(FCSData.Length{FCSData.chan}-1)) - FCSData.StartPar{FCSData.chan})*TACtoTime;
%tmp = circshift(TauFitData.hScat_Per{chan},[0,TauFitData.ScatShift{chan}+TauFitData.ShiftPer{chan}+TauFitData.ScatrelShift{chan}])';
tmp = shift_by_fraction(FCSData.hScat_Per{FCSData.chan},FCSData.ScatShift{FCSData.chan}+FCSData.ShiftPer{FCSData.chan}+FCSData.ScatrelShift{FCSData.chan});
tmp = tmp((FCSData.StartPar{FCSData.chan}+1):FCSData.Length{FCSData.chan});
if h.NormalizeScatter_Menu.Value
    % since the scatter pattern should not contain background, we subtract the constant offset
    maxscat = max(tmp);
    tmp = tmp-mean(tmp(end-floor(FCSData.MI_Bins/50):end));
    tmp = tmp/max(tmp)*maxscat;
    tmp(isnan(tmp)) = 0;
    %tmp(tmp < 0) = 0;
end
h.Plots.Scat_Per.YData = tmp;
h.Ignore_Plot.Visible = 'off';
%%% check if anisotropy plot is selected
legend(h.Microtime_Plot,'off');
if h.ShowAniso_radiobutton.Value == 1
    %%% hide all IRF and Scatter plots
    set([h.Plots.IRF_Par, h.Plots.IRF_Per,h.Plots.Scat_Par,h.Plots.Scat_Per,h.Plots.Decay_Par,h.Plots.Decay_Per],'Visible','off');
    set([h.Plots.Decay_Sum,h.Plots.Aniso_Preview,h.Plots.IRF_Sum,h.Plots.Scat_Sum],'Visible','off');
    h.Plots.Aniso_Preview.Visible = 'on';
    %%% set parallel channel plot to anisotropy
    Decay = G*(1-3*l2)*h.Plots.Decay_Par.YData+(2-3*l1)*h.Plots.Decay_Per.YData;
    Aniso = (G*h.Plots.Decay_Par.YData - h.Plots.Decay_Per.YData)./Decay;
    h.Plots.Aniso_Preview.XData = h.Plots.Decay_Par.XData;
    h.Plots.Aniso_Preview.YData = Aniso;
    ylim(h.Microtime_Plot,[min([0,min(Aniso)-0.02]),max(Aniso)+0.02]);
    h.Microtime_Plot.YLabel.String = 'Anisotropy';
elseif h.ShowDecay_radiobutton.Value == 1
    %%% unihde all IRF and Scatter plots
    set([h.Plots.IRF_Par, h.Plots.IRF_Per,h.Plots.Scat_Par,h.Plots.Scat_Per,h.Plots.Decay_Par,h.Plots.Decay_Per],'Visible','on');
    set([h.Plots.Decay_Sum,h.Plots.Aniso_Preview,h.Plots.IRF_Sum,h.Plots.Scat_Sum],'Visible','off');
    h.Plots.Decay_Par.Color = [0.8510    0.3294    0.1020];
    h.Microtime_Plot.YLimMode = 'auto';
    h.Microtime_Plot.YLim(1) = 0;
    h.Microtime_Plot.YLabel.String = 'Intensity [counts]';
    if ~any(strcmp(FCSData.Who,{'BurstBrowser','Burstwise'}))
        if h.PIEChannelPar_Popupmenu.Value ~= h.PIEChannelPer_Popupmenu.Value
            %%% show legend
            l = legend([h.Plots.Decay_Par,h.Plots.Decay_Per], {'I_{||}','I_\perp'});
            l.Box = 'off';
        end
    else
        %%% show legend
        l = legend([h.Plots.Decay_Par,h.Plots.Decay_Per], {'I_{||}','I_\perp'});
        l.Box = 'off';
    end
elseif h.ShowDecaySum_radiobutton.Value == 1
    %%% unihde all IRF and Scatter plots
    set([h.Plots.Aniso_Preview,h.Plots.IRF_Par, h.Plots.IRF_Per,h.Plots.Scat_Par,h.Plots.Scat_Per,h.Plots.Decay_Per,h.Plots.Decay_Par],'Visible','off');
    set([h.Plots.Decay_Sum,h.Plots.IRF_Sum,h.Plots.Scat_Sum],'Visible','on');
    Decay = G*(1-3*l2)*h.Plots.Decay_Par.YData+(2-3*l1)*h.Plots.Decay_Per.YData;
    IRF = G*(1-3*l2)*h.Plots.IRF_Par.YData+(2-3*l1)*h.Plots.IRF_Per.YData;
    Scat = G*(1-3*l2)*h.Plots.Scat_Par.YData+(2-3*l1)*h.Plots.Scat_Per.YData;
    set([h.Plots.Decay_Sum,h.Plots.Scat_Sum],'XData',h.Plots.Decay_Par.XData);
    h.Plots.IRF_Sum.XData = h.Plots.IRF_Per.XData;
    h.Plots.Decay_Sum.YData = Decay;
    h.Plots.IRF_Sum.YData = IRF;
    h.Plots.Scat_Sum.YData = Scat;
    h.Microtime_Plot.YLimMode = 'auto';
    h.Microtime_Plot.YLim(1) = 0;
    h.Microtime_Plot.YLabel.String = 'Intensity [counts]';
end
axes(h.Microtime_Plot);
xlim([h.Plots.Decay_Par.XData(1),h.Plots.Decay_Par.XData(end)]);

%%% Update Ignore Plot
if FCSData.Ignore{FCSData.chan} > 1
    %%% Make plot visible
    h.Ignore_Plot.Visible = 'on';
    h.Ignore_Plot.XData = [FCSData.Ignore{FCSData.chan}*TACtoTime FCSData.Ignore{FCSData.chan}*TACtoTime];
    if strcmp(h.Microtime_Plot.YScale,'log')
        if h.ShowDecay_radiobutton.Value == 1
            ydat = [h.Plots.IRF_Par.YData,h.Plots.IRF_Per.YData,...
                h.Plots.Scat_Par.YData, h.Plots.Scat_Per.YData,...
                h.Plots.Decay_Par.YData,h.Plots.Decay_Per.YData];
        elseif h.ShowDecaySum_radiobutton.Value == 1
            ydat = [h.Plots.IRF_Sum.YData,h.Plots.Scat_Sum.YData,h.Plots.Decay_Sum.YData];
        elseif h.ShowAniso_radiobutton.Value == 1
            ydat = h.Plots.Aniso_Preview.YData;
        end
        ydat = ydat(ydat > 0);
        h.Ignore_Plot.YData = [...
            min(ydat),...
            h.Microtime_Plot.YLim(2)];
    else
        h.Ignore_Plot.YData = [...
            h.Microtime_Plot.YLim(1),...
            h.Microtime_Plot.YLim(2)];
    end
elseif FCSData.Ignore{FCSData.chan} == 1
    %%% Hide Plot Again
    h.Ignore_Plot.Visible = 'off';
end

if h.AutoFit_Menu.Value
    Start_Fit(h.Fit_Button)
end
% hide MEM button
h.Fit_Button_MEM_tau.Visible = 'off';
h.Fit_Button_MEM_dist.Visible = 'off';

drawnow;


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Context menu callbacks %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% 1: Change X scaling
%%% 2: Export to figure
%%% 3: Export to Workspace
%%% 4: Export Params to Clipboard
function Plot_Menu_Callback(Obj,~,mode)
h = guidata(findobj('Tag','FCSFit'));
global FCSMeta FCSData

switch mode
    case 1 %%% Change X scale
        if strcmp(Obj.Checked,'off')
            h.FCS_Axes.XScale='log';
            h.Residuals_Axes.XScale = 'log';
            Obj.Checked='on';
        else
            h.FCS_Axes.XScale='lin';
            h.Residuals_Axes.XScale = 'lin';
            Obj.Checked='off';
        end
    case 2 %%% Exports plots to new figure
        %% Sets parameters
        Size = [str2double(h.Export_XSize.String) str2double(h.Export_YSize.String) str2double(h.Export_YSizeRes.String)];
        FontSize = h.Export_Font.UserData.FontSize;
        
        if ~strcmp(FCSMeta.DataType,'FRET')
            Scale = [floor(log10(max(h.FCS_Axes.XLim(1),h.FCS_Axes.Children(1).XData(1)))), ceil(h.FCS_Axes.XLim(2))];
            XTicks = zeros(diff(Scale),1);
            XTickLabels = cell(diff(Scale),1);
            j=1;        
            for i=Scale(1):Scale(2)
                XTicks(j) = 10^i;
                XTickLabels{j} = ['10^{',num2str(i),'}'];
                j = j+1;
            end  
        end
        
        %% Creates new figure
        H.Fig=figure(...
            'Units','points',...
            'defaultUicontrolFontName',h.Export_Font.UserData.FontName,...
            'defaultAxesFontName',h.Export_Font.UserData.FontName,...
            'defaultTextFontName',h.Export_Font.UserData.FontName,...
            'defaultUicontrolFontSize',h.Export_Font.UserData.FontSize,...
            'defaultAxesFontSize',h.Export_Font.UserData.FontSize,...
            'defaultTextFontSize',h.Export_Font.UserData.FontSize,...
            'defaultUicontrolFontWeight',h.Export_Font.UserData.FontWeight,...
            'defaultAxesFontWeight',h.Export_Font.UserData.FontWeight,...
            'defaultTextFontWeight',h.Export_Font.UserData.FontWeight,...
            'defaultUicontrolFontAngle',h.Export_Font.UserData.FontAngle,...
            'defaultAxesFontAngle',h.Export_Font.UserData.FontAngle,...
            'defaultTextFontAngle',h.Export_Font.UserData.FontAngle,...
            'Position',[50 150 Size(1)+5*FontSize+25 Size(2)+Size(3)+6.5*FontSize]);
        whitebg([1 1 1]);   
        %% Creates axes for correlation and residuals
        if ~strcmp(FCSMeta.DataType,'FRET')
            H.FCS=axes(...
                'Parent',H.Fig,...
                'XScale','log',...
                'FontSize', FontSize,...
                'XTick',XTicks,...
                'XTickLabel',XTickLabels,...
                'Layer','bottom',...
                'Units','points',...
                'Position',[15+4.2*FontSize 3.5*FontSize Size(1) Size(2)],...
                'LineWidth',1.5);    
            if h.Export_Residuals.Value
                H.Residuals=axes(...
                    'Parent',H.Fig,...
                    'XScale','log',...
                    'FontSize', FontSize,...
                    'XTick',XTicks,...
                    'XTickLabel',[],...
                    'Layer','bottom',...
                    'Units','points',...
                    'Position',[15+4.2*FontSize 5*FontSize+Size(2) Size(1) Size(3)],...
                    'LineWidth',1.5);
            else
                H.FCS.Position(4) = H.FCS.Position(4)+Size(3)+1.5*FontSize;
            end
        else
            H.FCS=axes(...
                'Parent',H.Fig,...
                'XScale','lin',...
                'FontSize', FontSize,...
                'Layer','bottom',...
                'Units','points',...
                'Position',[15+4.2*FontSize 3.5*FontSize Size(1) Size(2)],...
                'LineWidth',1.5);    
            if h.Export_Residuals.Value
                H.Residuals=axes(...
                    'Parent',H.Fig,...
                    'XScale','lin',...
                    'FontSize', FontSize,...
                    'XTickLabel',[],...
                    'Layer','bottom',...
                    'Units','points',...
                    'Position',[15+4.2*FontSize 5*FontSize+Size(2) Size(1) Size(3)],...
                    'LineWidth',1.5);
            else
                H.FCS.Position(4) = H.FCS.Position(4)+Size(3)+1.5*FontSize;
            end
        end
            
        %% Copies objects to new figure
        Active = find(cell2mat(h.Fit_Table.Data(1:end-3,2)));
        % if h.Fit_Errorbars.Value
        %     UseCurves = sort(numel(h.FCS_Axes.Children)+1-[3*Active-2; 3*Active-1]);
        % else
        %    UseCurves = reshape(flip(sort(numel(h.FCS_Axes.Children)+1-[3*Active 3*Active-1;],1)',1),[],1);
        % end
        % UseCurves = sort(numel(h.FCS_Axes.Children)+1-[3*Active-2; 3*Active-1; 3*Active]);
        % H.FCS_Plots=copyobj(h.FCS_Axes.Children(UseCurves),H.FCS);
        
        if h.Fit_Errorbars.Value
            UseCurves = [1,2];
        else
            UseCurves = [4,2];
        end

        CopyCurves = FCSMeta.Plots(Active,UseCurves);
        H.FCS_Plots = [];
        for i = Active'
            for j = UseCurves
                H.FCS_Plots(i,j) = copyobj(FCSMeta.Plots{i,j},H.FCS);
            end
        end

        if h.Export_FitsLegend.Value
               H.FCS_Legend=legend(H.FCS,h.FCS_Legend.String,'Interpreter','none'); 
        else
            if isfield(h,'FCS_Legend')
                if h.FCS_Legend.isvalid
                    LegendString = h.FCS_Legend.String(1:2:end-1);
                    for i=1:numel(LegendString)
                        LegendString{i} = LegendString{i}(7:end);
                    end
                    if h.Fit_Errorbars.Value
                        H.FCS_Legend=legend(H.FCS,H.FCS_Plots(Active,UseCurves(1)),LegendString,'Interpreter','none');
                    else
                        H.FCS_Legend=legend(H.FCS,H.FCS_Plots(Active,UseCurves(1)),LegendString,'Interpreter','none');
                    end

                end
            end
        end
        if strcmp(FCSMeta.DataType,'FRET')
            %%% add invidividual plots
            UseCurves = [5:size(FCSMeta.Plots,2)];
            N = numel(H.FCS_Legend.String);
            for i = Active'
                for j = UseCurves
                    copyobj(FCSMeta.Plots{i,j},H.FCS);
                end
            end
            H.FCS_Legend.String = H.FCS_Legend.String(1:N);
        end
        if h.Export_Residuals.Value
            H.Residuals_Plots=copyobj(h.Residuals_Axes.Children(numel(h.Residuals_Axes.Children)+1-Active),H.Residuals);      
        end
        %% Sets axes parameters   
        set(H.FCS.Children,'LineWidth',1.5);
        if h.Export_Residuals.Value
            set(H.Residuals.Children,'LineWidth',1.5);
            linkaxes([H.FCS,H.Residuals],'x');
        end
        H.FCS.XLim=[h.FCS_Axes.XLim(1),h.FCS_Axes.XLim(2)];
        H.FCS.YLim=h.FCS_Axes.YLim;
        switch FCSMeta.DataType
            case {'FCS','FCS averaged'}
                H.FCS.XLabel.String = 'time lag {\it\tau{}} [s]';
                H.FCS.YLabel.String = 'G({\it\tau{}})'; 
            case 'FRET'
                H.FCS.XLabel.String = 'FRET efficiency';
                H.FCS.YLabel.String = 'PDF'; 
        end
        if h.Export_Residuals.Value
            H.Residuals.YLim=h.Residuals_Axes.YLim;
            switch h.Fit_Weights.Value
                case 1
                    H.Residuals.YLabel.String = {'weighted'; 'residuals'};
                case 0
                    H.Residuals.YLabel.String = {'residuals'};
            end
        end        
        %% Toggles box and grid
        if h.Export_Grid.Value
            grid(H.FCS,'on');
            if h.Export_Residuals.Value
                grid(H.Residuals,'on');
            end
        end
        if h.Export_MinorGrid.Value
            grid(H.FCS,'minor');
            if h.Export_Residuals.Value
                grid(H.Residuals,'minor');
            end
        else
            grid(H.FCS,'minor');
            grid(H.FCS,'minor');
            if h.Export_Residuals.Value
                grid(H.Residuals,'minor');
                grid(H.Residuals,'minor');
            end
        end
        if h.Export_Box.Value
            H.FCS.Box = 'on';
            if h.Export_Residuals.Value
                H.Residuals.Box = 'on';
            end
        else
            H.FCS.Box = 'off';
            if h.Export_Residuals.Value
                H.Residuals.Box = 'off';
            end
        end
        
        H.Fig.Color = [1 1 1];
        %%% Copies figure handles to workspace
        assignin('base','H',H);
    case 3 %%% Exports data to workspace
        Active = cell2mat(h.Fit_Table.Data(1:end-3,2));
        FCS=[];
        FCS.Model=FCSMeta.Model.Function;
        FCS.FileName=FCSData.FileName(Active)';
        FCS.Params=FCSMeta.Params(:,Active)';        
        time=FCSMeta.Data(Active,1);
        data=FCSMeta.Data(Active,2);
        error=FCSMeta.Data(Active,3);
        %Fit=cell(numel(FCS.Time),1); 
        FCS.Graphs=cell(numel(time)+1,1);
        FCS.Graphs{1}={'time', 'data', 'error', 'fit', 'res'};
        %%% Calculates y data for fit
        for i=1:numel(time)
            P=FCS.Params(i,:);
            %eval(FCSMeta.Model.Function);
            OUT = feval(FCSMeta.Model.Function,P,time{i});
            OUT=real(OUT);
            res=(data{i}-OUT)./error{i};
            FCS.Graphs{i+1} = [time{i}, data{i}, error{i}, OUT, res];
        end
        %%% Copies data to workspace
        assignin('base','FCS',FCS);
    case 4 %%% Exports Fit Result to Clipboard
        FitResult = cell(numel(FCSData.FileName),1);
        active = cell2mat(h.Fit_Table.Data(1:end-2,2));
        for i = 1:numel(FCSData.FileName)
            if active(i)
                FitResult{i} = cell(size(FCSMeta.Params,1)+2,1);
                FitResult{i}{1} = FCSData.FileName{i};
                FitResult{i}{2} = str2double(h.Fit_Table.Data{i,end});
                FitResult{i}{3} = str2double(h.Fit_Table.Data{i,4});
                for j = 4:(size(FCSMeta.Params,1)+3)
                    FitResult{i}{j} = FCSMeta.Params(j-3,i);
                end
            end
        end
        [~,ModelName,~] = fileparts(FCSMeta.Model.Name);
        Params = vertcat({ModelName;'Chi2';'Mol. Bright. [kHz]'},FCSMeta.Model.Params);
        if h.Conf_Interval.Value
            if isfield(FCSMeta,'Confidence_Intervals')
                for i = 1:numel(FCSData.FileName)
                    if active(i)
                        Nlow = FCSMeta.Confidence_Intervals{i}(1,1);
                        Nhigh = FCSMeta.Confidence_Intervals{i}(1,2);
                        N = FitResult{i}{4};
                        Blow = FitResult{i}{3}*Nlow/N;
                        Bhigh = FitResult{i}{3}*Nhigh/N;
                        FitResult{i} = horzcat(FitResult{i},vertcat({'lower','upper';'','';num2str(Blow),num2str(Bhigh)},num2cell([FCSMeta.Confidence_Intervals{i}])));
                    end
                end
            end
        end
        FitResult = horzcat(Params,horzcat(FitResult{:}));
        Mat2clip(FitResult');
end

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Stops fitting routine %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function Stop_FCSFit(~,~)
global FCSMeta
h = guidata(findobj('Tag','FCSFit'));
FCSMeta.FitInProgress = 0;
h.Fit_Table.Enable='on';
h.FCSFit.Name='FCS Fit';
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Executes fitting routine %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function Do_FCSFit(~,~)
global FCSMeta UserValues
h = guidata(findobj('Tag','FCSFit'));
%%% Indicates fit in progress
FCSMeta.FitInProgress = 1;
h.FCSFit.Name='FCS Fit  FITTING';
h.Fit_Table.Enable='off';
drawnow;
%%% Reads parameters from table
Fixed = cell2mat(h.Fit_Table.Data(1:end-3,6:3:end-1));
Global = cell2mat(h.Fit_Table.Data(end-2,7:3:end-1));
Active = cell2mat(h.Fit_Table.Data(1:end-3,2));
lb = h.Fit_Table.Data(end-1,5:3:end-1);
lb = cellfun(@str2double,lb);
ub = h.Fit_Table.Data(end,5:3:end-1);
ub = cellfun(@str2double,ub);
%%% Read fit settings and store in UserValues
MaxIter = str2double(h.Iterations.String);
TolFun = str2double(h.Tolerance.String);
UserValues.FCSFit.Max_Iterations = MaxIter;
UserValues.FCSFit.Fit_Tolerance = TolFun;
Use_Weights = h.Fit_Weights.Value;
UserValues.FCSFit.Use_Weights = Use_Weights;
LSUserValues(1);
%%% Optimization settings
opts=optimset('Display','off','TolFun',TolFun,'MaxIter',MaxIter);
%%% Performs fit
if sum(Global)==0
    %% Individual fits, not global
    for i=find(Active)'
        if ~FCSMeta.FitInProgress
            break;
        end
        %%% Reads in parameters
        XData=FCSMeta.Data{i,1};
        YData=FCSMeta.Data{i,2};
        EData=FCSMeta.Data{i,3};
        Min=find(XData>=str2double(h.Fit_Min.String),1,'first');
        Max=find(XData<=str2double(h.Fit_Max.String),1,'last');
        if ~isempty(Min) && ~isempty(Max)
            %%% Adjusts data to selected time region
            XData=XData(Min:Max);
            YData=YData(Min:Max);
            EData=EData(Min:Max);
            %%% Disables weights
            if ~Use_Weights
                EData(:)=1;
            end
            %%% Sets initial values and bounds for non fixed parameters
            Fit_Params=FCSMeta.Params(~Fixed(i,:),i);
            Lb=lb(~Fixed(i,:));
            Ub=ub(~Fixed(i,:));                      
            %%% Performs fit
            [Fitted_Params,~,weighted_residuals,Flag,~,~,jacobian]=lsqcurvefit(@Fit_Single,Fit_Params,{XData,EData,i,Fixed(i,:)},YData./EData,Lb,Ub,opts);
            %%% calculate confidence intervals
            if h.Conf_Interval.Value
                ConfInt = zeros(size(FCSMeta.Params,1),2);
                method = h.Conf_Interval_Method.Value;
                alpha = 0.05; %95% confidence interval
                if method == 1
                    %%% NOTE: nlparci confidence intervals are always
                    %%% symmetric, which can lead to non-sensical values
                    %%% for the error estimate (i.e. 10 +- 20).
                    %%% 
                    %%% One could also use nlinfit here to get access to
                    %%% the covariance matrix directly (instead of relying
                    %%% on the jacobian), but I found the two methods to be
                    %%% consistent.
                    ConfInt(~Fixed(i,:),:) = nlparci(Fitted_Params,weighted_residuals,'jacobian',jacobian,'alpha',alpha);
                elseif method == 2
                    disp('Running MCMC... This could take a minute.');tic;
                    confint = nlparci(Fitted_Params,weighted_residuals,'jacobian',jacobian,'alpha',alpha);
                    proposal = (confint(:,2)-confint(:,1))/2; proposal = (proposal/100)';
                    if any(isnan(proposal))
                        %%% nlparci may return NaN values. Set to 1% of the fit value
                        proposal(isnan(proposal)) = Fitted_Params(isnan(proposal))/100;
                    end
                    %%% define log-likelihood function, which is just the negative of the chi2 divided by two! (do not use reduced chi2!!!)
                    loglikelihood = @(x) (-1/2)*sum((Fit_Single(x,{XData,EData,i,Fixed(i,:)})-YData./EData).^2);
                    %%% Sample
                    nsamples = 1E4; spacing = 1E2;
                    [samples,prob,acceptance] =  MHsample(nsamples,loglikelihood,@(x) 1,proposal,Lb,Ub,Fitted_Params,zeros(1,numel(Fitted_Params)));
                    while acceptance < 0.01
                        disp(sprintf('Acceptance was too low! (%.4f)',acceptance));
                        disp('Running again with more narrow proposal distribution.');
                        proposal = proposal/10;
                        [samples,prob,acceptance] =  MHsample(nsamples,loglikelihood,@(x) 1,proposal,Lb,Ub,Fitted_Params,zeros(1,numel(Fitted_Params)));
                    end
                    %%% MCMC samples the posterior distribution, which can
                    %%% be asymmetric. In this case, the standard deviation
                    %%% is the wrong quantity, instead asymmetric
                    %%% confidence intervals can be reported based on the
                    %%% percentiles of the distribution!
                    
                    %%% New asymmetric confidence interval estimate
                    ConfInt(~Fixed(i,:),:) = prctile(samples(1:spacing:end,:),100*[alpha/2,1-alpha/2],1)';
                    
                    %%% This was the error estimate based on the standard
                    %%% deviation:
                    % v = numel(weighted_residuals)-numel(Fitted_Params); % number of degrees of freedom
                    % perc = tinv(1-alpha/2,v);
                    % ConfInt(~Fixed(i,:),:) = [(mean(samples(1:spacing:end,:))-perc*std(samples(1:spacing:end,:)))', (mean(samples(1:spacing:end,:))+perc*std(samples(1:spacing:end,:)))'];
                    
                    disp(sprintf('Done. Performed %d steps in %.2f seconds.',nsamples,toc));
                    % print variables to workspace
                    assignin('base',['Samples' num2str(i)],samples(1:spacing:end,:));
                    assignin('base',['acceptance' num2str(i)],acceptance);                    
                end
                FCSMeta.Confidence_Intervals{i} = ConfInt;  
                %%% we can also make a prediction for the curve based on
                %%% the confidence intervals, using the following code:
                % [y,delta] = nlpredci(@(x,xdat) Fit_Single(x,{xdat,EData,i,Fixed(i,:)}).*EData,XData,Fitted_Params,weighted_residuals,'jacobian',full(jacobian));
                % figure;semilogx(XData,y-delta);hold on;semilogx(XData,y+delta);
            end
            %%% Updates parameters
            FCSMeta.Params(~Fixed(i,:),i)=Fitted_Params;
        end
    end  
else
    %% Global fits
    XData=[];
    YData=[];
    EData=[];
    Points=[];
    %%% Sets initial value and bounds for global parameters
    Fit_Params=FCSMeta.Params(Global,1);
    Lb=lb(Global);
    Ub=ub(Global);
    for  i=find(Active)'
        %%% Reads in parameters of current file
        xdata=FCSMeta.Data{i,1};
        ydata=FCSMeta.Data{i,2};
        edata=FCSMeta.Data{i,3};
        %%% Disables weights
        if ~Use_Weights
            edata(:)=1;
        end
        
        %%% Adjusts data to selected time region
        Min=find(xdata>=str2double(h.Fit_Min.String),1,'first');
        Max=find(xdata<=str2double(h.Fit_Max.String),1,'last');
        if ~isempty(Min) && ~isempty(Max)
            XData=[XData;xdata(Min:Max)];
            YData=[YData;ydata(Min:Max)];
            EData=[EData;edata(Min:Max)];
            Points(end+1)=numel(xdata(Min:Max));
        end
        %%% Concatenates initial values and bounds for non fixed parameters
        Fit_Params=[Fit_Params; FCSMeta.Params(~Fixed(i,:)& ~Global,i)];
        Lb=[Lb lb(~Fixed(i,:) & ~Global)];
        Ub=[Ub ub(~Fixed(i,:) & ~Global)];
    end
    %%% Puts current Data into global variable to be able to stop fitting
    %%% Performs fit
    [Fitted_Params,~,weighted_residuals,Flag,~,~,jacobian]=lsqcurvefit(@Fit_Global,Fit_Params,{XData,EData,Points,Fixed,Global,Active},YData./EData,Lb,Ub,opts);
    %%% calculate confidence intervals
    if h.Conf_Interval.Value
        method = h.Conf_Interval_Method.Value;
        alpha = 0.05; %95% confidence interval
        if method == 1
            ConfInt = nlparci(Fitted_Params,weighted_residuals,'jacobian',jacobian,'alpha',alpha);
        elseif method == 2
            disp('Running MCMC... This could take a minute.');tic;
            confint = nlparci(Fitted_Params,weighted_residuals,'jacobian',jacobian,'alpha',alpha);
            proposal = (confint(:,2)-confint(:,1))/2; proposal = (proposal/10)';
            if any(isnan(proposal))
                %%% nlparci may return NaN values. Set to 1% of the fit value
                proposal(isnan(proposal)) = Fitted_Params(isnan(proposal))/100;
            end
            %%% define log-likelihood function, which is just the negative of the chi2 divided by two! (do not use reduced chi2!!!)
            loglikelihood = @(x) (-1/2)*sum((Fit_Global(x,{XData,EData,Points,Fixed,Global,Active})-YData./EData).^2);
            %%% Sample
            nsamples = 1E4; spacing = 1E2;
            [samples,prob,acceptance] =  MHsample(nsamples,loglikelihood,@(x) 1,proposal,Lb,Ub,Fitted_Params,zeros(1,numel(Fitted_Params)));
            while acceptance < 0.01
                    disp(sprintf('Acceptance was too low! (%.4f)',acceptance));
                    disp('Running again with more narrow proposal distribution.');
                    proposal = proposal/10;
                    [samples,prob,acceptance] =  MHsample(nsamples,loglikelihood,@(x) 1,proposal,Lb,Ub,Fitted_Params,zeros(1,numel(Fitted_Params)));
            end
            %%% New asymmetric confidence interval estimate
            ConfInt = prctile(samples(1:spacing:end,:),100*[alpha/2,1-alpha/2],1)';
            
            %v = numel(weighted_residuals)-numel(Fitted_Params); % number of degrees of freedom is equal to the number of samples
            % perc = 1.96;%tinv(1-alpha/2,v);
            % ConfInt = [(mean(samples(1:spacing:end,:))-perc*std(samples(1:spacing:end,:)))', (mean(samples(1:spacing:end,:))+perc*std(samples(1:spacing:end,:)))'];
            
            disp(sprintf('Done. Performed %d steps in %.2f seconds.',nsamples,toc));
            % print variables to workspace
            assignin('base','GlobalSamples',samples(1:spacing:end,1:sum(Global)));
            assignin('base','LocalSamples',samples(1:spacing:end,sum(Global)+1:end));        
            assignin('base','acceptance',acceptance);
            if acceptance < 0.01
                disp(sprintf('Acceptance was too low! (%.4f)',acceptance));
            end
        end
        GlobConfInt = ConfInt(1:sum(Global),:);
        ConfInt(1:sum(Global),:) = [];        
        for i = find(Active)'
            FCSMeta.Confidence_Intervals{i} = zeros(size(FCSMeta.Params,1),2);
            FCSMeta.Confidence_Intervals{i}(Global,:) = GlobConfInt;
            FCSMeta.Confidence_Intervals{i}(~Fixed(i,:) & ~Global,:) = ConfInt(1:sum(~Fixed(i,:) & ~Global),:);
            ConfInt(1:sum(~Fixed(i,:)& ~Global),:)=[]; 
        end
    end
    %%% Updates parameters
    FCSMeta.Params(Global,:)=repmat(Fitted_Params(1:sum(Global)),[1 size(FCSMeta.Params,2)]) ;
    Fitted_Params(1:sum(Global))=[];
    for i=find(Active)'
        FCSMeta.Params(~Fixed(i,:) & ~Global,i)=Fitted_Params(1:sum(~Fixed(i,:) & ~Global)); 
        Fitted_Params(1:sum(~Fixed(i,:)& ~Global))=[]; 
    end    
end
%%% Displays last exitflag
switch Flag
    case 1
        h.Termination.String='Function converged to a solution x.';
    case 2
        h.Termination.String='Change in x was less than the specified tolerance.';
    case 3
        h.Termination.String='Change in the residual was less than the specified tolerance.';
    case 4
        h.Termination.String='Magnitude of search direction smaller than the specified tolerance.';
    case 0
        h.Termination.String='Number of iterations exceeded options. MaxIter or number of function evaluations exceeded options.';
    case -1
        h.Termination.String='Algorithm was terminated by the output function.';
    case -2
        h.Termination.String='Problem is infeasible: the bounds lb and ub are inconsistent.';
    case -4
        h.Termination.String='Optimization could not make further progress.';
    otherwise
        h.Termination.String= ['Unknown exitflag: ' num2str(Flag)];
end
%%% Indicates end of fitting procedure
h.Fit_Table.Enable='on';
h.FCSFit.Name='FCS Fit';
FCSMeta.FitInProgress = 0;
%%% Updates table values and plots
Update_Table([],[],2);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Actual fitting function for individual fits %%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function [Out] = Fit_Single(Fit_Params,Data)
%%% Fit_Params: Non fixed parameters of current file
%%% Data{1}:    X values of current file
%%% Data{2}:    Weights of current file
%%% Data{3}:    Indentifier of current file
global FCSMeta

%%% Aborts Fit
%drawnow;
if ~FCSMeta.FitInProgress
    Out = zeros(size(Data{2}));
    return;
end

x=Data{1};
Weights=Data{2};
file=Data{3};
Fixed = Data{4};
%%% Determines, which parameters are fixed
%Fixed = cell2mat(h.Fit_Table.Data(file,5:3:end-1));

P=zeros(numel(Fixed),1);
%%% Assigns fitting parameters to unfixed parameters of fit
P(~Fixed)=Fit_Params;
%%% Assigns parameters from table to fixed parameters
P(Fixed)=FCSMeta.Params(Fixed,file);
%%% Applies function on parameters
%eval(FCSMeta.Model.Function);
OUT = feval(FCSMeta.Model.Function,P,x);
%%% Applies weights
Out=OUT./Weights;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Actual fitting function for global fits %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function [Out] = Fit_Global(Fit_Params,Data)
%%% Fit_Params: [Global parameters, Non fixed parameters of all files]
%%% Data{1}:    X values of all files
%%% Data{2}:    Weights of all files
%%% Data{3}:    Length indentifier for X and Weights data of each file
global FCSMeta
%h = guidata(findobj('Tag','FCSFit'));

%%% Aborts Fit
%drawnow;
if ~FCSMeta.FitInProgress
    Out = zeros(size(Data{2}));
    return;
end

X=Data{1};
Weights=Data{2};
Points=Data{3};
Fixed = Data{4};
Global = Data{5};
Active = Data{6};
%%% Determines, which parameters are fixed, global and which files to use
%Fixed = cell2mat(h.Fit_Table.Data(1:end-3,5:3:end));
%Global = cell2mat(h.Fit_Table.Data(end-2,6:3:end));
%Active = cell2mat(h.Fit_Table.Data(1:end-3,1));
P=zeros(numel(Global),1);

%%% Assigns global parameters
P(Global)=Fit_Params(1:sum(Global));
Fit_Params(1:sum(Global))=[];

Out=[];k=1;
for i=find(Active)'
  %%% Sets non-fixed parameters
  P(~Fixed(i,:) & ~Global)=Fit_Params(1:sum(~Fixed(i,:) & ~Global)); 
  Fit_Params(1:sum(~Fixed(i,:)& ~Global))=[];  
  %%% Sets fixed parameters
  P(Fixed(i,:) & ~Global)= FCSMeta.Params((Fixed(i,:)& ~Global),i);
  %%% Defines XData for the file
  x=X(1:Points(k));
  X(1:Points(k))=[]; 
  k=k+1;
  %%% Calculates function for current file
  %eval(FCSMeta.Model.Function);
  OUT = feval(FCSMeta.Model.Function,P,x);
  Out=[Out;OUT]; 
end
Out=Out./Weights;


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Function to recalculate binning for FRET %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function rebinFRETdata(obj,~)
global UserValues FCSData FCSMeta
h = guidata(obj);
bin = str2double(obj.String);
%%% round to multiples of 0.005
bin = ceil(bin/0.005)*0.005;
x = (-0.1:bin:ceil(1.1/bin)*bin)';
UserValues.FCSFit.FRETbin = bin;
obj.String = num2str(bin);
for i=1:numel(FCSData.Data)
    %%% Reads data
    E = FCSData.Data{i}.E;
    Data.E = E;
    his = histcounts(E,x)'; %his = [his'; his(end)];
    Data.Cor_Average = his./sum(his)./min(diff(x));
    error = sqrt(his)./sum(his)./min(diff(x));
    Data.Cor_SEM = error; Data.Cor_SEM(Data.Cor_SEM == 0) = 1;
    Data.Cor_Array = [];
    Data.Valid = [];
    Data.Counts = [numel(E), numel(E)];
    Data.Cor_Times = x(1:end-1)+bin/2;
    FCSData.Data{i} = Data;

    %%% Updates global parameters
    FCSMeta.Data{i,1} = FCSData.Data{i}.Cor_Times;
    FCSMeta.Data{i,2} = FCSData.Data{i}.Cor_Average;
    FCSMeta.Data{i,2}(isnan(FCSMeta.Data{i,2})) = 0;
    FCSMeta.Data{i,3} = FCSData.Data{i}.Cor_SEM;
    FCSMeta.Data{i,3}(isnan(FCSMeta.Data{i,3})) = 1;
    
    %%% Update Plots
    FCSMeta.Plots{i,1}.XData = FCSMeta.Data{i,1};
    FCSMeta.Plots{i,1}.YData = FCSMeta.Data{i,2};
    if isfield(FCSMeta.Plots{i,1},'YNegativeDelta')
        FCSMeta.Plots{i,1}.YNegativeDelta = error;
        FCSMeta.Plots{i,1}.YPOsitiveDelta = error;
    else
        FCSMeta.Plots{i,1}.LData = error;
        FCSMeta.Plots{i,1}.UData = error;
    end
    
    FCSMeta.Plots{i,4}.XData = FCSMeta.Data{i,1}-bin/2;
    FCSMeta.Plots{i,4}.YData = FCSMeta.Data{i,2};       
end
Update_Plots;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Functions to load and save the session %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function LoadSave_Session(obj,e)
global UserValues FCSData FCSMeta
h = guidata(obj);
switch obj
    case h.LoadSession
        %%% get file
        [FileName,PathName] = uigetfile({'*.fcs','FCSFit Session (*.fcs)'},'Load FCSFit Session',UserValues.File.FCSPath,'MultiSelect','off');
        if numel(FileName) == 1 && FileName == 0
            return;
        end
        %%% Saves pathname to uservalues
        UserValues.File.FCSPath=PathName;
        LSUserValues(1);
        %%% Deletes loaded data
        FCSData=[];
        FCSData.Data=[];
        FCSData.FileName=[];
        cellfun(@delete,FCSMeta.Plots);
        FCSMeta.Data=[];
        FCSMeta.Params=[];
        FCSMeta.Plots=cell(0);
        h.Fit_Table.Data(1:end-3,:)=[];
        h.Style_Table.RowName(1:end-1,:)=[];
        h.Style_Table.Data(1:end-1,:)=[];

        %%% load data
        data = load(fullfile(PathName,FileName),'-mat');
        %%% update global variables
        FCSData = data.FCSData;
        FCSMeta = data.FCSMeta;
        %%% update UserValues settings, with exception of export settings
        UserValues.FCSFit.Fit_Min = data.Settings.Fit_Min;
        UserValues.FCSFit.Fit_Max = data.Settings.Fit_Max;
        UserValues.FCSFit.Plot_Errorbars = data.Settings.Plot_Errorbars;
        UserValues.FCSFit.Fit_Tolerance = data.Settings.Fit_Tolerance;
        UserValues.FCSFit.Use_Weights = data.Settings.Use_Weights;
        UserValues.FCSFit.Max_Iterations = data.Settings.Max_Iterations;
        UserValues.FCSFit.NormalizationMethod = data.Settings.NormalizationMethod;
        UserValues.FCSFit.Hide_Legend = data.Settings.Hide_Legend;
        UserValues.FCSFit.Conf_Interval = data.Settings.Conf_Interval;
        UserValues.FCSFit.FRETbin = data.Settings.FRETbin;
        UserValues.FCSFit.PlotStyles = data.Settings.PlotStyles;
        UserValues.FCSFit.PlotStyleAll = data.Settings.PlotStyleAll;
        UserValues.File.FCS_Standard = FCSMeta.Model.Name;
        LSUserValues(1);
        %%% update GUI according to loaded settings
        h.Fit_Min.String = num2str(UserValues.FCSFit.Fit_Min);
        h.Fit_Max.String = num2str(UserValues.FCSFit.Fit_Max);
        h.Fit_Errorbars.Value = UserValues.FCSFit.Plot_Errorbars;
        h.Tolerance.String = num2str(UserValues.FCSFit.Fit_Tolerance);
        h.Fit_Weights.Value = UserValues.FCSFit.Use_Weights;
        h.Iterations.String = num2str(UserValues.FCSFit.Max_Iterations);
        h.Normalize.Value = UserValues.FCSFit.NormalizationMethod;
        h.Conf_Interval.Value = UserValues.FCSFit.Conf_Interval;
        h.Hide_Legend.Value = UserValues.FCSFit.Hide_Legend;
        h.FRETbin.String = num2str(UserValues.FCSFit.FRETbin);
        %%% update visuals
        Create_Plots([],[]);
        %%% Updates table and plot data and style to new size
        Update_Style([],[],0);
        Update_Style([],[],1);
        Update_Table([],[],0);
        %%% fill in active, fixed and global state
        if isfield(data,'FixState') && isfield(data,'GlobalState') && isfield(data,'ActiveState')
            h.Fit_Table.Data(1:end-3,6:3:end) = data.FixState;
            h.Fit_Table.Data(1:end-3,7:3:end) = data.GlobalState;
            h.Fit_Table.Data(end-2,7:3:end) = num2cell(sum(cell2mat(data.GlobalState),1) > 0);
            h.Fit_Table.Data(1:end-3,2) = data.ActiveState;
            Update_Plots;
        end
        %%% Updates model text
        [~,name,~] = fileparts(FCSMeta.Model.Name);
        name_text = {'Loaded Fit Model:';name;};
        h.Loaded_Model_Name.String = sprintf('%s\n',name_text{:});
        h.Loaded_Model_Description.String = sprintf('%s\n',FCSMeta.Model.Description{:});
        h.Loaded_Model_Description.TooltipString = sprintf('%s\n',FCSMeta.Model.Description{:});
    case h.SaveSession
        %%% get filename
        [FileName, PathName] = uiputfile({'*.fcs','FCSFit Session (*.fcs)'},'Save Session as ...',fullfile(UserValues.File.FCSPath,[FCSData.FileName{1},'.fcs']));
        %%% save all data
        data.FCSMeta = FCSMeta;
        data.FCSMeta.Plots = cell(0);
        data.FCSData = FCSData;
        data.Settings = UserValues.FCSFit;
        data.FixState = h.Fit_Table.Data(1:end-3,6:3:end);
        data.GlobalState = h.Fit_Table.Data(1:end-3,7:3:end);
        data.ActiveState = h.Fit_Table.Data(1:end-3,2);
        save(fullfile(PathName,FileName),'-struct','data');
end

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Functions to create basic plots on data load %%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function Create_Plots(~,~)
global UserValues FCSMeta FCSData
h = guidata(findobj('Tag','FCSFit'));
switch FCSMeta.DataType
    case {'FCS averaged','FCS individual','FCS'} %%% Correlation files
        for i=1:numel(FCSData.FileName)
            %%% Creates new plots
            FCSMeta.Plots{end+1,1} = errorbar(...
                FCSMeta.Data{i,1},...
                FCSMeta.Data{i,2},...
                FCSMeta.Data{i,3},...
                'Parent',h.FCS_Axes);
            FCSMeta.Plots{end,2} = line(...
                'Parent',h.FCS_Axes,...
                'XData',FCSMeta.Data{i,1},...
                'YData',zeros(numel(FCSMeta.Data{i,1}),1));
            FCSMeta.Plots{end,3} = line(...
                'Parent',h.Residuals_Axes,...
                'XData',FCSMeta.Data{i,1},...
                'YData',zeros(numel(FCSMeta.Data{i,1}),1));
            FCSMeta.Plots{end,4} = line(...
                'Parent',h.FCS_Axes,...
                'XData',FCSMeta.Data{i,1},...
                'YData',FCSMeta.Data{i,2});
        end
        %%% change the gui
        SwitchGUI(h,'FCS');
    case 'FRET'   %% 2color FRET data from BurstBrowser
        for i=1:numel(FCSData.FileName)
            %%% Creates new plots
            FCSMeta.Plots{end+1,1} = errorbar(...
                FCSMeta.Data{i,1},...
                FCSMeta.Data{i,2},...
                FCSMeta.Data{i,3},...
                'Parent',h.FCS_Axes);
            FCSMeta.Plots{end,2} = line(...
                'Parent',h.FCS_Axes,...
                'XData',FCSMeta.Data{i,1},...
                'YData',zeros(numel(FCSMeta.Data{i,1}),1));
            FCSMeta.Plots{end,3} = line(...
                'Parent',h.Residuals_Axes,...
                'XData',FCSMeta.Data{i,1},...
                'YData',zeros(numel(FCSMeta.Data{i,1}),1));
            FCSMeta.Plots{end,4} = stairs(...
                FCSMeta.Data{i,1}-UserValues.FCSFit.FRETbin/2,...
                FCSMeta.Data{i,2},...
                'Parent',h.FCS_Axes);            
        end
        %%% change the gui
        SwitchGUI(h,'FRET');
end
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Functions for various small callbacks %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function Misc (obj,e,mode)
global UserValues
h = guidata(findobj('Tag','FCSFit'));

if nargin<3
   switch obj %%% Export Font Selection
       case h.Export_Font
           f = uisetfont;
           if ~isstruct(f)
               return;
           end
           f.FontString = ['Export Font: ' f.FontName];
           if strcmp(f.FontWeight, 'bold')
               f.FontString = [f.FontString ', b'];
           end
           if strcmp(f.FontAngle, 'italic')
               f.FontString = [f.FontString ', i'];
           end
           f.FontString = [f.FontString ' ,' num2str(f.FontSize)];
           
           obj.UserData = f;
           obj.String = f.FontString;
           UserValues.FCSFit.Export_Font = f;
           LSUserValues(1);
   end
    
end

